- [IO 管理：IO 基本原理](#io-%E7%AE%A1%E7%90%86%EF%BC%9Aio-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86)
  - [1. IO 硬件基本原理](#1-io-%E7%A1%AC%E4%BB%B6%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86)
    - [1.1. IO 设备分类](#11-io-%E8%AE%BE%E5%A4%87%E5%88%86%E7%B1%BB)
    - [1.2. 设备电子部件](#12-%E8%AE%BE%E5%A4%87%E7%94%B5%E5%AD%90%E9%83%A8%E4%BB%B6)
    - [1.3. 设备通信方式](#13-%E8%AE%BE%E5%A4%87%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F)
  - [2. IO 软件基本原理](#2-io-%E8%BD%AF%E4%BB%B6%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86)
    - [2.1. 核心问题](#21-%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98)
    - [2.2. IO 软件实现](#22-io-%E8%BD%AF%E4%BB%B6%E5%AE%9E%E7%8E%B0)
      - [2.2.1. 程序控制 IO](#221-%E7%A8%8B%E5%BA%8F%E6%8E%A7%E5%88%B6-io)
      - [2.2.2. 中断驱动 IO](#222-%E4%B8%AD%E6%96%AD%E9%A9%B1%E5%8A%A8-io)
      - [2.2.3. DMA IO](#223-dma-io)
    - [2.3. IO 软件层次](#23-io-%E8%BD%AF%E4%BB%B6%E5%B1%82%E6%AC%A1)
  - [3. Refer Links](#3-refer-links)

# IO 管理：IO 基本原理

## 1. IO 硬件基本原理

### 1.1. IO 设备分类

- **块设备 (block device)**

  **块设备把信息存储在固定大小的块中，每个块都有自己的地址**。通常块的大小在 512 bytes~32768 bytes 之间，**所有的传输都以一个或多个完整连续的块为单位**。

  **块设备是可寻址的**，其基本特征是每个块都能独立于其它块而读写。**硬盘、CD-ROM、USB 盘都是最常见的块设备**。

- **字符设备 (character device)**

  **字符设备的传输以字符为单位发送或接收一个字符流，而不考虑任何块结构**。

  **字符设备是不可寻址的**，也没有任何寻道操作。**打印机、鼠标以及大多数于磁盘不同的设备都属于字符设备**。

- 其它设备
  - **时钟既不可寻址，也不产生或接收字符流**，其任务仅仅是按照预先定义好的时间间隔产生中断。
  - **内存映射的显示器也不可寻址，且不产生或接收字符流**。

### 1.2. 设备电子部件

**IO 设备一般由机械部件和电子部件两部分组成，电子部件一般称为设备控制器 / 适配器**。

- **每个控制器都有几个寄存器用于与 CPU 进行通信**，通过读写这些寄存器，操作系统可以了解设备的状态以及对设备进行控制。
- 除了控制寄存器外，**许多设备还有一个操作系统可以读写的数据缓冲区**，如屏幕上显示像素的常规方法是使用一个视频 RAM。

### 1.3. 设备通信方式

那么，CPU 如何与 IO 设备的控制寄存器 / 数据缓冲区进行通信呢？
- 通过 IO 端口
  
  为每个控制寄存器分配一个 IO 端口，所有的 IO 端口组成 IO 端口空间，操作系统通过特殊的 IO 指令 IN/OUT 可以在 CPU 寄存器和设备的控制寄存器之间进行数据通信。这也是早期大多数计算机的实现方式。

- 通过内存映射
  
  将所有控制寄存器映射到内存空间中，每个控制寄存器被分配唯一的一个内存地址，通常分配给控制寄存器的地址位于地址空间的顶端。CPU 需要与设备进行数据交互时，直接与内存进行交互即可。

  优点：
  - 由于在 C/C++ 中不存在执行 IN/OUT 指令的方法，因此对于 IO 端口的通信必须使用汇编代码实现，而对于内存映射 IO 则可以通过 C/C++ 来实现。
  - 不需要特殊的保护机制来阻止用户进程执行 IO 操作。这样的方案使得不同的设备驱动程序防止在不同的地址空间中，不但可以减少内核的大小，也可以防止驱动程序之间的互相干扰。
  - 可以引用内存的每一条指令也可以引用控制寄存器。

  缺点：

- 直接存储器存取 (DMA)

  前 2 种方案种，CPU 每次从设备控制器种读取一个字节的数据，但事实上这样浪费了 CPU 的时间，因此又出现了 DMA，只有硬件具有 DMA 控制器时操作系统才可以使用 DMA。

  ![image](http://img.cdn.firejq.com/jpg/2018/7/28/2009d9c94e86b610159e599908a825cc.jpg)

  ![image](http://img.cdn.firejq.com/jpg/2018/7/28/42048ef6dbba40c87dbf94aa097635b6.jpg)

## 2. IO 软件基本原理

### 2.1. 核心问题

- 设备独立性

  在设计 IO 软件时，一个关键的概念是设备独立性，即应使得程序可以访问任意的 IO 设备而无须事先指定设备。

- 统一命名

- 错误处理

- 同步 & 异步传输

- 缓冲

- 共享 & 独占设备

### 2.2. IO 软件实现

IO 可以以 3 种不同的方式实现：
- 程序控制 IO
- 中断驱动 IO
- DMA IO

#### 2.2.1. 程序控制 IO

IO 最简单的形式让 CPU 完成全部的工作，这种方式称为程序控制 IO。

程序控制 IO 的根本问题在于 IO 的整个过程都需要占用 CPU 时间，即“忙等待”问题。

#### 2.2.2. 中断驱动 IO

中断驱动 IO 的关键问题在于中断发生在每一个字符上，而中断需要花费时间。

#### 2.2.3. DMA IO

本质上，DMA IO 属于程序控制 IO，但是由 DMA 控制器而不是主 CPU 来完成全部工作，使得 CPU 可以在 IO 期间去做其它的工作。

DMA IO 将中断的次数从打印每个字符一次减少到打印每个缓冲区一次，如果由许多个字符并且中断比较缓慢，则采用 DMA 可能是重要的改进。

但 DMA 控制器比 CPU 要慢很多，因此若 DMA 无法全速驱动设备或 CPU 没有其它任务需要完成，那么采用中断驱动 IO 或程序控制 IO 是比 DMA 更好的选择。

### 2.3. IO 软件层次

IO 软件通常组织成 4 个层次：

![image](http://img.cdn.firejq.com/jpg/2018/7/28/bd08602a05a2e82fbe704139652c37e2.jpg)

其中，每一层都具有明确的功能和接口。

## 3. Refer Links