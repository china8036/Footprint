- [JVM 类加载](#jvm-%E7%B1%BB%E5%8A%A0%E8%BD%BD)
	- [1. 加载阶段](#1-%E5%8A%A0%E8%BD%BD%E9%98%B6%E6%AE%B5)
	- [2. 连接阶段](#2-%E8%BF%9E%E6%8E%A5%E9%98%B6%E6%AE%B5)
	- [3. 初始化阶段](#3-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5)
		- [3.1. 初始化的操作](#31-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%93%8D%E4%BD%9C)
		- [3.2. 初始化的时机](#32-%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E6%9C%BA)

# JVM 类加载

当程序主动使用某个类时，如果该类还未被加载到内存中，则 JVM 会对该类进行**加载、连接、初始化**，这三个步骤一般统称为类加载或类初始化。

## 1. 加载阶段

类加载指的是将类的 class 文件读取到内存，并为之创建一个 java.lang.Class 对象的过程，也就是说，当程序中使用任何类时，系统都会为之建立一个 java.lang.Class 对象。

**类加载阶段的操作由类加载器完成，类加载器通常由 JVM 提供，这些类加载器是所有程序运行的基础。**

## 2. 连接阶段

当类被加载后，系统为之生成一个对应的 Class 对象，接着将会进入连接阶段，连接阶段负责把类的二进制数据整合到 JRE 中。

类连接可分为以下三个阶段：
- 验证。验证阶段用于检验被加载的类是否有正确的内部结构，并和其它类协调一致。
- 准备。准备阶段复杂为类的静态变量分配内存，并设置默认值。
- 解析。解析阶段将类的二进制数据中的符号引用替换成直接引用。

## 3. 初始化阶段

在类的初始化阶段，JVM 负责对类进行初始化，类的初始化主要就是对类中的静态变量进行初始化和执行静态初始化块。

JVM 执行类的初始化时，若该类的父类还没有被初始化，则会先初始化其直接父类。因此，JVM 中最先初始化的总是 java.lang.Object 类。当程序主动使用任何一个类时，系统会保证该类以及该类的所有父类（包括直接父类和间接父类）都会被初始化。

### 3.1. 初始化的操作

在 Java 程序中可以使用以下 2 种方式定义类的初始化操作，JVM 会按照这些语句在程序中的先后顺序依次执行它们：
- 声明静态变量时指定初始值。
- 使用静态初始化块。

例：
```java
public class Test {
  static {
    //...
    a = 6;
    //...
  }

  static int a = 5;

}
```
上述代码中，先执行静态初始化块中的代码，再静态变量 a 的初始化赋值，因此当 Test 类初始化结束后，该类的静态变量 a 的值为 5。

### 3.2. 初始化的时机

什么情况下系统会执行类的初始化呢？

当 Java 程序首次通过以下方式之一来使用某个类或接口时，系统就会执行该类的初始化：
- 创建类的实例。创建实例的方式包括：使用 new 操作符、使用反射、使用反序列化方式。
- 调用某个类的静态方法。
- 访问或赋值某个类或接口的静态变量。
- 使用反射来强制创建某个类或接口对应的 java。lang.Class 对象。
- 初始化某个类的子类。当初始化某个类的子类时，该子类的所有父类都会被初始化。
- 直接使用 java.exe 命令来运行某个主类。当运行某个主类时，程序会先初始化该主类。

NOTE: 
- 对于一个 final 的静态变量：
  - 若该静态变量的值在编译阶段就可以确定，则这个静态变量会在编译阶段在出现的地方被直接替换成它的值，因此不会导致类的初始化。
  - 若该静态变量的值需要在运行阶段才能确定，则通过该类来访问它的静态变量时，会导致该类的初始化。

- 当使用 ClassLoader 类的 loadClass() 方法来加载某个类时，该方法只是加载该类，但并不会执行该类的初始化。使用 Class 类的 forName() 方法才会导致强制初始化该类。
