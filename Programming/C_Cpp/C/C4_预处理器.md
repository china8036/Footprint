- [C 语言：预处理器](#c-语言预处理器)
    - [1. 文件包含](#1-文件包含)
    - [2. 宏定义](#2-宏定义)
        - [2.1. 无参宏](#21-无参宏)
        - [2.2. 有参宏](#22-有参宏)
    - [3. 条件包含](#3-条件包含)
    - [4. Refer Links](#4-refer-links)

# C 语言：预处理器

**预处理是编译过程中单独执行的第一个步骤，是在编译之前对源文件进行简单加工的过程，预处理命令是以 `#` 号开头的命令**。预处理命令要放在所有函数之外，而且一般都放在源文件的前面。当对一个源文件进行编译时，系统将自动调用预处理程序对源程序中的预处理部分作处理，处理完毕自动进入对源程序的编译。

C 语言提供了多种预处理功能，如宏定义、文件包含、条件编译等，合理地使用它们会使编写的程序便于阅读、修改、移植和调试，也有利于模块化程序设计。

## 1. 文件包含

`#include` 是文件包含命令，主要用来引入对应的头文件。`#include` 的处理过程很简单，就是**将该命令所在的位置替换为头文件的内容，从而把头文件和当前源文件连接成一个源文件，与复制粘贴的效果相同**。

`#include` 有两种使用方式：
- `#include <stdio.h>`: 如果文件名用尖括号括起来，则根据相应的规则查找该文件，具体规则与具体的实现有关。
- `#include "myHeader.h"`: 如果文件名用引号括起来，则在源文件所在的位置查找该文件。

NOTE
- 一个 `#include` 命令只能包含一个头文件，多个头文件需要多个 `#include` 命令。
- 文件包含允许嵌套，也就是说在一个被包含的文件中又可以包含另一个文件。
- **如果某个包含文件的内容发生了变化，那么所有依赖于该包含文件的源文件都必须重新编译**。

## 2. 宏定义

C 语言中允许用一个标识符来标识一个字符串，称为“宏”，标识符为“宏名”。**在编译预处理时，对程序中所有出现的“宏名”，都用宏定义时的字符串去代换，简称“宏代换”或“宏展开”**。

宏定义的作用域：从定义命令至程序结束，若想终止宏的作用域，则使用`#undef`命令。

宏定义可分为两类：有参数和无参数。

### 2.1. 无参宏

凡是以“#”开头的均为预处理命令。“define”为宏定义的命令，标识符为定义的宏名；字符串可以是常量、表达式、格式化字符串等。

一般形式：
```
#define 宏名 字符串
```

eg：
```c
#define P printf
#define D "%d\n"
#define F "%f\n"

int main()
{
    int a = 5;
    float b = 3.8;
    p(D F, a, b);
}
```

NOTE
- 在宏定义时，其字符串要用小括号括起来，否则会产生出错误的编译，在运行时，得不到想要的结果；例如 `#define M (x*3+x*5)`。
- 宏定义不需要在行末加分号，若加上分号，则会连分号也会被替换进去。
- 宏定义是可以嵌套使用的，在展开时，由预处理程序层层替换。
- define 和 typedef 的区别：
  - define：只是简单的宏替换。
  - typedef：是对类型说明符的重新命名，被命名的标识符具有类型定义说明功能。

### 2.2. 有参宏

C 语言允许有参宏（即宏带有参数）。在宏定义中的参数称之为“形式参数”，形式参数在编译的时候是不会分配空间的，在宏调用中的参数称之为“实际参数”。

一般形式为：
```
#define 宏名（形参表）字符串

宏名（实参表）
```

eg:
```c
#define SSSV(s1, s2, s3, v)  s1=l*w; s2=l*h; s3=w*h; v=l*w*h

int main()
{
    int l = 3, w = 4, h = 5, sa, sb, sc, vv;

    SSSV(sa, sb, sc, vv);

    printf("sa = %d\tsb = %d\tsc = %d\tvv = %d\n", sa, sb, sc, vv);
    return 0;
}
```

预处理器运算符 `##` 为宏扩展提供了一种连接实际参数的手段。如果替换文本中的参数与 `##` 相邻，则该参数将被实际参数替换，`##` 与前后的空白符将被删除，并对替换后的结果重新扫描。例如：可通过 `#define paste(front, back) front ## back` 来连接两个参数。

NOTE
- 在有参宏定义中，宏名和形参表之间不能有空格。
- 在有参宏定义中的形参是标识符，而宏调用中的实参可以是表达式。
- 在有参宏定义中，由于原理是直接进行字符串替换，因此在使用时要分外小心，以避出错。通常会**将字符串内的形参通常用括号括起来，以免出错，如 `#define square(x) x * x`，在使用 `square(z+1)` 时，会被替换为 `z+1*z+1` 而导致计算次序出错**。
- 宏定义也可以用来定义多个语句。
- 带参数的宏和函数很相似，但有本质上的区别：**宏展开仅仅是字符串的替换，不会对表达式进行计算；宏在编译之前就被处理掉了，它没有机会参与编译，也不会占用内存**。而函数是一段可以重复使用的代码，会被编译，会给它分配内存，每次调用函数，就是执行这块内存中的代码。

## 3. 条件包含

多个编译指令允许程序员有选择的编译程序源代码的不同部分，这种过程称为条件编译。

条件编译指令：
```
#if
#else
#elif
#endif
```
- `#if` 语句对其中的常量整型表达式（**其中不能包含 `sizeof`、类型转换运算符、enum 常量**）进行求值，若该表达式的值不等于 0，则包含其后的各行，直到遇到 `#endif`、`#elif` 或 `else` 语句为止。
- `#if` 语句中可以使用表达式 `#define(var_name)` 来判断变量名是否已被定义。
- **`#if` 语句中不能使用 `sizeof`，因为预处理器不对类型名进行解析；但预处理器并不计算 `#define` 语句中的表达式，因此在 `#define` 语句中使用 `sizeof` 是合法的**。

e.g.
```c
#include <stdio.h>
int main(){
    if(_WIN32){
        system("color 0c");
        printf("1");
    }else if(__linux__){
        printf("2");
    }else{
        printf("3");
    }

    return 0;
}
```
对上面的代码进行改进：
```c
#include <stdio.h>
int main(){
    #if _WIN32
        system("color 0c");
        printf("1");
    #elif __linux__
        printf("2");
    #else
        printf("3");
    #endif
    return 0;
}
```
上边的改进代码将条件判断的代码都更改为了条件编译操作，如果宏 `_WIN32` 的值为真，就保留第 4、5 行代码，删除第 7、9 行代码；如果宏 `__linux__` 的值为真，就保留第 7 行代码；如果所有的宏都为假，就保留第 9 行代码。

这些操作都是在预处理阶段完成的，**多余的代码以及所有的宏都不会参与编译，不仅保证了代码的正确性，还减小了编译后文件的体积**。

## 4. Refer Links

[C 语言 - 宏的世界](https://www.jianshu.com/p/5463d8a21444)

[C 语言带参数宏定义](http://c.biancheng.net/cpp/html/66.html)

[C 语言宏与单井号（#）和双井号（##）](https://blog.csdn.net/acs713/article/details/6891837)
