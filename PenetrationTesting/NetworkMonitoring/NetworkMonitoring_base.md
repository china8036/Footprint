- [网络监听技术](#%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC%E6%8A%80%E6%9C%AF)
    - [概述](#%E6%A6%82%E8%BF%B0)
        - [网卡](#%E7%BD%91%E5%8D%A1)
    - [具体网络环境中的网络监听](#%E5%85%B7%E4%BD%93%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC)
        - [共享式环境的网络监听](#%E5%85%B1%E4%BA%AB%E5%BC%8F%E7%8E%AF%E5%A2%83%E7%9A%84%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC)
        - [交换式环境的网络监听](#%E4%BA%A4%E6%8D%A2%E5%BC%8F%E7%8E%AF%E5%A2%83%E7%9A%84%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC)
            - [端口镜像](#%E7%AB%AF%E5%8F%A3%E9%95%9C%E5%83%8F)
            - [MAC 洪泛](#mac-%E6%B4%AA%E6%B3%9B)
            - [端口盗用](#%E7%AB%AF%E5%8F%A3%E7%9B%97%E7%94%A8)
            - [ARP 欺骗](#arp-%E6%AC%BA%E9%AA%97)
    - [网络监听的检测](#%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC%E7%9A%84%E6%A3%80%E6%B5%8B)
    - [网络监听的防范](#%E7%BD%91%E7%BB%9C%E7%9B%91%E5%90%AC%E7%9A%84%E9%98%B2%E8%8C%83)

# 网络监听技术

## 概述

网络监听指监视网络状态、网络通信数据流向以及通信具体内容；

用于网络监听的工具称为嗅探器（sniffer），嗅探器工作在网络环境中的底层，能够拦截网络中的通信数据，通过相应的处理程序实时分析通信的具体内容，进而掌握网络的整体布局和状态；

### 网卡

网卡，即网络接口卡（Network Interface Card，NIC），用于实习计算机和网络电缆间的物理连接，为计算机之间的通信提供物理通道；

网卡工作在数据链路层，其地址称为 MAC 地址 / 硬件地址；

- 网卡工作模式
	- 单播 / 广播
	当数据帧到达 NIC 时，在正常情况下，网卡读入数据帧，然后检查帧头中的 MAC 地址字段，若目的 MAC 与本机 MAC 地址或广播地址相同，则产生中断信号通知操作系统进行相应处理，否则会 drop 数据帧；

	- 混杂模式（Promiscuous）
	当 NIC 处于 Promiscuous 模式时，对接收到的数据帧不会检查帧头信息，而是一律产生硬件中断，通知操作系统进行处理；    
	将主机 NIC 配置为 Promiscuous 模式是实施网络监听的前提条件；

## 具体网络环境中的网络监听
网络监听除与 NIC 的工作模式有关，还与主机所处的网络环境相关，网络环境一般分为共享式网络环境和交换式网络环境；

### 共享式环境的网络监听

- 共享式环境是指同一网段中的所有网络接口都能访问在物理媒体上传输的数据；

- 以太网是典型的共享式网络环境；
	- 依据 CSMA/CD 协议，当一台主机发送数据时，所以后主机都能接收到其发送的数据；   
	- 每台主机在发送数据前必须检测总线是否空闲，如果发现其它主机在发送数据，将进行等待，确认总线空闲后才能发送数据；   
	- 集线器是以太网中的重要设备，它可以看作是 LAN 中共享的**广播**信道；

- 当处于共享式环境时，只需将 NIC 设置为 Promiscuous 模式，即可不丢弃获取到的数据帧，进而进行分析处理，达到监听的目的；

### 交换式环境的网络监听

- 交换式环境一般指的是使用交换机的网络环境；

- 交换机是使用最广泛的 LAN 连接设备   
	- 交换机与 HUB 最大的区别在于交换机上的通信数据不再需要向网络连接设备的所有端口进行转发，而是精确发往目标 MAC 主机所在的端口；   
	- 交换机内部维护了一份**连接在交换机上的主机的 MAC 地址与交换机端口**的映射表，将 MAC 地址与交换机端口号相关联，这份映射表称为 MAC 地址表 / 内容可寻址存储器（CAM）；   

- 当处于交互式网络环境中时，即便主机 NIC 处于 Promiscuous 模式了，主机无法在正常情况下获取发往其它主机的数据帧，因此，需要采取一定的手段来达到监听目的；

#### 端口镜像
- 端口镜像指的是将交换机一个或多个端口接收或发送的数据帧完全复制给指定的另外一个或多个端口，其中，被复制的端口为镜像源端口，复制操作的端口为镜像目的端口；

- 大部分交换机都具有端口镜像的功能，其主要功能是让网络管理员能便捷的监控数据通信，掌握网络运行情况；

- 具体操作：假设某 switch 有 1~7 号端口，7 号端口连接的是 hacker 主机，为监听其它端口的所有主机：
	- 将 7 号端口作为镜像目的端口，将 1、3、4、5、6 号端口作为镜像源端口，并选择镜像方向；
	- 将 hacker 主机的 NIC 配置为 Promiscuous 模式；

- 缺陷：一般用户没有配置 switch 的权限；

#### MAC 洪泛
- MAC Flood 针对 switch 的 MAC 地址表（即 CAM）进行；

- switch 建立 MAC 地址表的国创是一个自学习的国创，其进行数据转发的过程可以描述如下：
	- switch 从自己的某个 port 接收 frame，提取 frame 中的源 MAC 地址，建立 MAC 地址与 switch 相应 port 的映射，并将映射关系写入 CAM；
	- switch 提取 frame 的目的 MAC 地址，在 CAM 中查找相应的 MAC 地址，以决定向哪个 port 转发 frame：
		- 若 CAM 中包含了目的 MAC 地址的信息，则将 frame 发向与目的 MAC 地址相对应的 switch port；
		- 若 CAM 中不包含目的 MAC 地址的信息，则将 frame 向 switch 的所有 port 广播，该转发过程称为“洪泛”；

- MAC Flood 攻击思路：
持续发送大量源 MAC 地址为随机值的 frame，导致虚假的 MAC 地址信息充满 switch 的 CAM，而当 switch 有 frame 需要转发时，由于 CAM 中没有与 frame 的目的 MAC 地址对应的信息，此时 switch 采取洪泛的方法，即向所有 port 转发（也就是 HUB 的工作模式），进而可以使用共享式网络的监听方法进行网络监听；

- 成功原因   
	- frame 中的 MAC 地址缺乏认证机制
	- switch 内存资源有限
	- switch 自学习模式存在严重隐患

- 缺陷
	- MAC 洪泛会影响网络连接速度；
	- 目前大多数 switch 都对 MAC Flood 做了免疫设置；

#### 端口盗用

- 端口盗用技术同样利用了交换机 MAC 地址表的自学习机制；

- 端口盗用攻击思路
	- 向 switch 发送欺骗性的 frame，使得被监听主机的 MAC 地址与 hacker 所处的交换机 port 在交换机的 CAM 中绑定在一起；
	- 在此条件下，若出现目的 MAC 地址为被监听主机 MAC 地址的 frame，交换机将依据 MAC 地址表中的错误信息，将 frame 发往 hacker 主机所在的 port；

- 缺陷
	- hacker 如何把监听到的数据发还给被监听的主机？目前常用的做法是将数据先进行缓存，等待网络正常后再将数据转发给被监听主机，此后在实施新一轮端口盗用；

#### ARP 欺骗

- ARP 协议：将目标主机 IP 地址转换成目标主机 MAC 地址，属于网络层的协议；

- 每台联网的主机都有一个 ARP 高速缓存，其中保存了一些局域网主机 IP 地址到 MAC 地址的映射，主机联网一段时间后，即使不进行网络通信，ARP Cache 中通常也会存储一些地址映射信息；

- ARP 欺骗能够成功的原因
	- ARP 设计之初没有考虑到安全性问题，完全建立在信任 LAN 中所有主机的基础上。ARP 具有高效的优点，但是缺乏验证机制，当主机收到 ARP 数据包，不会进行任何认证就会刷新主机的 ARP 缓存；
	- ARP 协议无状态性。主机不会检测自己是否发送过 ARP 请求，所有的 ARP Reply 都会接收；

- ARP 欺骗的两种实现方法
	- 利用 ARP Request。hacker 主机发送 ARP 请求，在 ARP 请求的源 IP 地址和源 MAC 地址字段中填写虚假的信息，导致其它主机用该虚假的信息更新其 ARP Cache，此后其它主机需要发送数据包时，便会根据虚假的信息的指向将数据包发送到特定 MAC 地址的主机；
		- 缺陷：欺骗行为过于明显，易被发现；
	- 利用 ARP Reply。利用 ARP 协议的无状态性，通过在 ARP Reply 中设置虚假的 IP 地址 -MAC 地址映射，更新其它主机的 ARP Cache，达到 ARP 欺骗的目的；

## 网络监听的检测

网络监听的主机只是被动接收在网上传输的信息，不注定修改数据，也不影响其它主机的正常通信，所以网络监听通常难以被发现；但仍有技术手段有助于识别网络中实施监听的主机：

- Ping 主机    
向可疑主机发送定制的 ICMP 包，目的 IP 地址为可疑主机 IP，目的 MAC 为随机伪造值，若可疑主机的 NIC 处于正常工作模式，该 ICMP 包会被丢弃，若可疑主机 NIC 处于混杂模式，可可疑主机会对该异常的 ICMP 包进行 reply；

- 发送垃圾数据包   
先向可疑主机发送大量虚假目的 MAC 地址的数据包，正常主机会忽略这些包，而实施监听的主机会对这些数据包进行分析处理，导致可疑主机的 CPU 资源被大量占用，计算机性能下降；此时再向可疑主机发送 ping 请求，对比发送垃圾数据包之前的响应速度，若响应速度明显下降，则说明可疑主机正在实施监听；

- ARP 数据包检测    
在 LAN 中发送非广播方式的 ARP Request，其所查询的 IP 地址是 LAN 中不存在的地址，若 LAN 中有主机响应此 ARP Request，并以其 MAC 地址作为被查询 IP 地址的解析结果，则可推断该主机在实施 ARP 欺骗，很可能处于监听模式；

- 观察 DNS 服务器的解析请求    
某些网络监听工具会对 IP 地址进行反向 DNS 解析，从而帮助 hacker 根据域名发现有价值的主机；因此，可以在 LAN 中针对不存在的 IP 地址发送 ping，若有主机对这些 IP 地址进行 DNS 反向查询，可推断该主机运行了网络监听程序；

## 网络监听的防范

- 从逻辑或物理上对网络分段；
- 采用交换机取代集线器；
- 采用加密技术；
- 防范与网络监听有关的 hacker 技术；
