- [数据结构：图结构 - AOV 和 AOE](#数据结构图结构---aov-和-aoe)
  - [1. DAG](#1-dag)
  - [2. AOV 网与拓扑排序算法](#2-aov-网与拓扑排序算法)
  - [3. AOE 网与关键路径算法](#3-aoe-网与关键路径算法)
  - [4. Refer Links](#4-refer-links)

# 数据结构：图结构 - AOV 和 AOE

## 1. DAG

**有向无环图** (directed acyclic graph，简称 DAG) 是指一个无环的有向图，它是一种类似于有向树的特殊有向图。

![image](http://img.cdn.firejq.com/jpg/2018/2/25/85101484af413f92682e9575ac989c32.jpg)

除了描述多项式以外，有向无环图也是描述一项工程或系统进行过程的有效工具。在一般情况下，工程由若干个称为“活动”（activity）的子工程组成，而这些子工程之间存在一定的约束条件（比如执行的先后次序）。**对整个工程而言，工程的顺利执行以及对整个工程完成所需要的最短时间的估算是人们最为关心的两个问题，而这两个问题的解决可通过对有向图进行拓扑排序和关键路径操作来实现**。

## 2. AOV 网与拓扑排序算法

- AOV

  在**有向图**中，**使用顶点表示活动，使用有向边表示活动之间的先后关系**，这样的图被称为顶点表示活动的网（activity on vertex network，AOV 网）。

  在网中，若从顶点 i 到顶点 j 有一条有向路径，则 i 是 j 的前驱，j 是 i 的后继。若<i, j>是网中一条弧，则 i 是 j 的直接前驱，j 是 i 的直接后继。AOV 网表示了活动之间的优先关系。

  例如，计算机专业的学生要拿到学位必须完成一系列规定的基本课程，这些课程中有的是独立于所有其他课程的基础课程，必须最先学习；有些课程作为某些课程的先修课程必须在那些课程之前进行学习；而有些课程可随时安排学习等。因此，课程的安排具有一定的先后次序。这个关系就适合用 AOV 网表示。

- 拓扑有序序列

  为保证 AOV 网所表示的工程活动能够全部顺利执行，**在 AOV 网中不应该出现回路，否则，就意味着某项活动要以自己为先决条件，显然，这是荒谬的，这样的工程无法完成**。

  **测试 AOV 网是否存在回路的办法是，对该有向图构造其顶点的拓扑有序序列，若网中所有顶点都在它的拓扑有序序列中，则该 AOV 网中必定不存在环**。

  拓扑排序，是将有向无环图 G 中所有顶点排成一个线性序列，使得图中任意一对顶点 u 和 v 有以下关系：若 `<u, v>∈E(G)`，则 u 在线性序列中出现在 v 之前。通常，称这样的线性序列为满足拓扑次序（topological order）的序列，简称拓扑序列。

  拓扑序列具有以下 5 个特点：
  - **若将图中顶点按拓扑次序排成一行，则图中所有的有向边均是从左指向右的。**
  - 若图中存在有向环，则不可能使顶点满足拓扑次序。也就是说，**[非 DAG 不存在拓扑序列](https://www.nowcoder.com/questionTerminal/b1ab4ac91a654745b62a1a5e60195268?orderByHotValue=1&mutiTagIds=590&page=8&onlyReference=false)**。
  - **一个 DAG 可能有多个拓扑序列**。
  - 一个 DAG 的拓扑序列通常表示某种方案切实可行。

- 拓扑排序算法

  对 AOV 网进行拓扑排序的步骤是：
  1. 在 AOV 网中选一个入度为 0 即没有前驱的顶点并输出之。
  1. 从图中删除该顶点和所有以它为尾的弧。
  1. 重复上述两步，直到网中全部顶点都已输出，或者**当前图中不存在入度为 0 的顶点（说明有向图中存在环）**为止。
  
  对于上述操作步骤，**可采用邻接表作有向图的存储结构，且在头结点中增加一个存放顶点入度的数组（indegree）。删除入度为零的顶点及以它为尾的弧的操作，可通过弧头顶点的入度减 1 来实现**。为避免重复检测入度为零的顶点，可另设一**栈**暂存这些顶点，由此得到拓扑排序的算法。

  算法实现：**通常拓扑排序可通过贪心策略或 DFS （栈）来实现**。

  ![image](http://img.cdn.firejq.com/jpg/2018/2/25/ac62e80d69a373f4be5ced588e9bdb8d.jpg)

  分析以上程序，对有 n 个顶点和 e 条弧的有向图而言，建立求各顶点的入度的时间复杂度为 O(e)，建零入度顶点栈的时间复杂度为 O(n)。在拓扑排序过程中，若有向图无环，则每个顶点进一次栈，出一次栈，入度减 1 的操作在 while 语句中总共执行 e 次，所以总的**时间复杂度为 O(n+e)**。

## 3. AOE 网与关键路径算法

- AOE

  在**带权的有向图**中，**顶点表示事件（ 能被触发，拥有两个特征属性：最早发生时间 Ve(j); 最晚发生时间 Vl(j) ），边表示活动（ 能被开始，拥有两个特征属性：最早开始时间 e(i)；最晚开始时间 l(i) ）**，边上的权值表示活动的成本或时间等开销，此有向图称为 AOE 网（activity on edge network）。

  AOE 网中有两条原则：
  - 只有某顶点所代表的事件发生后，从该顶点出发的各活动才能开始。
  - 只有进入某顶点的各活动都结束，该顶点所代表的事件才能发生。

  **AOE 网与 AOV 网是既有联系又有区别的两种图，前者用于表示一项工程中各子工程之间的优先关系，而后者用来估算工程的完成时间。**通常，在 AOE 网中列出完成预定工程计划所需要进行的活动、每个活动计划完成的时间、与活动相关的事件以及事件和活动之间的关系等，由此来确定工程是否可行、总共需要的时间以及影响整个工程的关键活动。

  例：下图给出了一个有 15 项活动（a0, a1, a2, …, a14）的 AOE 网，包含 10 个事件（v0, v1, v2, v3, …, v9），其中，v0 为源点，表示工程的开始，v9 为汇点，表示整个工程结束。每个事件表示在它之前的活动已经完成，在它之后的活动可开始，与每个活动相联系的数是执行该活动所需的时间。在正常情况下，网中只有一个入度为零的点（源点）和一个出度为零的点（汇点）。

  ![image](http://img.cdn.firejq.com/jpg/2018/2/25/76c0fdc66b394eafc377cf976c145db7.jpg)

- 关键路径 & 关键活动

  采用 AOE 网进行工程管理时，一般需要考虑两个问题：
  - 完成整项工程至少需要多长时间？
  - 哪些活动是影响工程进度的关键活动？

  由于 AOE 网中表示的活动**可并行进行**，所以完成整个工程所必须花费的最短时间是从源点到汇点的最长路径长度（即路径上各活动持续时间之和），具有最大路径长度的路径称为**关键路径**（critical path），关键路径上的活动称为**关键活动**，关键路径的长度是整个工程所需的最短时间。**只有提前完成关键活动才能加快工程的进度，缩短整个工期。**

  NOTE
  - **关键路径的长度是整个工程所需要的最短工期**。
  - 关键路径并不一定只有一条，所以只改变一条，有时候不能改变全局。**当一个 AOE 图中同时有多条关键路径时，需要计算所有的关键路径才能进行完整的工程优化，此时应被优化的关键活动应是能影响到所有关键路径的活动，否则无法使整个工期缩短（“短板效应”）**。

- 关键路径算法

  关键路径算法是用于找到 AOE 网中的关键路径的算法。

  求关键路径的算法，只需理解顶点（事件）和边（活动）的各自的两个特征属性以及求法，然后取 e(i)=l(i) 的边即为关键路径上的边（关键路径可能不止一条）：
  1. 根据首结点的 Ve(j)=0，由前向后计算各顶点（事件）的最早发生时间。
  1. 根据终结点的 Vl(j)=Ve(j)，由后向前依次求解各顶点（事件）的最晚发生时间。
  1. 根据边的 e(i) 等于它的发出顶点的 Ve(j)，计算各边（活动）的最早开始时间（最早开始，对应最早发生）。
  1. 根据边的 l(i) 等于它的到达顶点的 Vl(j) 减去边的权值，计算各边（活动）的最晚开始时间（最晚开始，对应最晚发生）。

  - 例：求出以下 AOE 网所示工程的关键路径。

    ![image](http://img.cdn.firejq.com/jpg/2018/2/25/57a6e87422b87d63410be717d9def760.jpg)

    求出 AOE 网的 4 个特征属性：
    - Ve(j)：即从始点开始到顶点 Vk 的最大路径长度，表示事件发生的最早时间（etv: earliest time of vertex）。
      - 计算方法：
        - 从前向后，取大值：直接前驱结点的 Ve(j)＋到达边（指向顶点的边）的权值，有多个值的取较大者。
        - 首结点 Ve(j) 已知，为 0。
      - 计算过程：如上图各顶点（事件）的 Ve(j)： （从 V1 开始）

        ![image](http://img.cdn.firejq.com/jpg/2018/2/25/27af392475cf310f0500cbb9341f091e.jpg)

    - Vl(j)：在不推迟整个工期的前提下，事件 vk 允许的最晚发生时间 (ltv: lastest time of vertex)。
      - 计算方法：
        - 从后向前，取小值：直接后继结点的 Vl(j) –发出边（从顶点发出的边）的权值，有多个值的取较小者。
        - 终结点 Vl(j) 已知，等于它的 Ve(j)）。
      - 计算过程：如上图各顶点（事件）的 Vl(j)： （从 V7 开始，它的最早、最晚发生时间相同，都为 10）

        ![image](http://img.cdn.firejq.com/jpg/2018/2/25/99931dfa967623ad201546f3ae27d5b5.jpg)

    - e(i): 若活动 ai 由弧<vk,vj>表示，则活动 ai 的最早开始时间应该等于事件 vk 的最早发生时间。（ete: earliest time of edge）。

      有：e[i]=ve[k];（即：边（活动）的最早开始时间等于，它的发出顶点的最早发生时间）

      如上图各边（活动）的 e(i)：

      ![image](http://img.cdn.firejq.com/jpg/2018/2/25/cb1455050c13ca13baa6db60b5b027e9.jpg)  

    - l(i): 若活动 ai 由弧<vk,vj>表示，则 ai 的最晚开始时间要保证事件 vj 的最迟发生时间不拖后。（lte: lastest time of edge）。

      有：l[i]=vl[j]-len<vk,vj>1（为边（活动）的到达顶点的最晚发生时间减去边的权值）

      如上图各边（活动）的 l(i)：

      ![image](http://img.cdn.firejq.com/jpg/2018/2/25/3177649c4224e22de57a35d8a02c6e50.jpg)

      NOTE: 求 l(i) 时，不可认为与该边出发点的 Vl(i) 相等，因为边头事件最晚发生的时候边上的活动不一定马上开始，求得的不一定是最终事实的结果；同理，求 e(i) 时不可用边尾的 Ve(i) - 边的权值。

    最后，取出 e(i)=l(i) 的边为 a1、a2、a4、a8、a9，这些就是关键活动，即为关键路径上的边，所以关键路径有两条：a1 a4 a9 和 a2 a8 a9。

    为缩短整个工程的工期，若规定只能选两个活动进行优化（减少执行时间），可以达到优化整个工程的效果的是：
    ```
    a1 a4 ×（只影响到了两条关键路径的一条，“短板效应”，无法缩短整个工程工期）
    a1 a9 √
    a2 a8 ×（只影响到了两条关键路径的一条，“短板效应”，无法缩短整个工程工期）
    a2 a9 √
    a4 a9 √
    a8 a9 √
    ```

  代码实现：拓扑排序是求关键路径的基础，要求关键路径必须先求出拓扑序列。
  ```cpp
  // TODO:
  ```

## 4. Refer Links

http://c.biancheng.net/cpp/u/shuju8/  

TODO:

[拓扑排序在工程实践中有什么具体的应用？](https://www.zhihu.com/question/39748146)

[拓扑排序的应用（hdu1285、hdu3342、hdu2647）](https://www.jianshu.com/p/1cda977685b6)