- [计算机组成原理：总线系统](#计算机组成原理总线系统)
  - [1. 基本概念](#1-基本概念)
    - [1.1. 总线特性](#11-总线特性)
    - [1.2. 总线类别](#12-总线类别)
    - [1.3. 总线标准](#13-总线标准)
    - [1.4. 总线带宽](#14-总线带宽)
  - [2. 连接方式](#2-连接方式)
    - [2.1. 单总线连接](#21-单总线连接)
    - [2.2. 多总线连接](#22-多总线连接)
  - [3. 内部结构](#3-内部结构)
    - [3.1. 早期总线结构](#31-早期总线结构)
    - [3.2. 现代总线结构](#32-现代总线结构)
  - [4. 总线仲裁](#4-总线仲裁)
    - [4.1. 集中式仲裁](#41-集中式仲裁)
      - [4.1.1. 链式查询方式](#411-链式查询方式)
      - [4.1.2. 计算器定时查询方式](#412-计算器定时查询方式)
      - [4.1.3. 独立请求方式](#413-独立请求方式)
    - [4.2. 分布式仲裁](#42-分布式仲裁)
  - [5. Refer Links](#5-refer-links)

# 计算机组成原理：总线系统

## 1. 基本概念

数字计算机是由若干系统功能部件构成的，这些系统功能部件在一起工作才能形成一个完整的计算机系统。计算机的若干功能部件之间不可能采用全互联形式，因此就需要有公共的信息通道，即总线。

**总线是构成计算机系统的互联机构，是多个系统功能部件之间进行数据传送的公共通路**。借助于总线连接，计算机在各系统功能部件之间实现地址、数据和控制信息的交换，并在争用资源的基础上进行工作。

### 1.1. 总线特性

- 物理特性：总线的物理连接方式（根数、插头、插座形状、引脚排列方式等）。
- 功能特性：每根线的功能。
- 电气特性：每根线上信号的传递方向及有效电平范围。
- 时间特性：规定了每根总线在什么时间有效。

### 1.2. 总线类别

根据总线连接对象的不同，总线可分为：
- **内部总线**：CPU 内部连接各寄存器及运算器部件之间的总线。
- **系统总线**：CPU 和计算机系统中其他高速功能部件相互连接的总线。
- **I/O 总线**：CPU 和中低速 I/O 设备相互连接的总线。

根据传送信息的不同，总线从逻辑上又可分为：
- **地址总线**：传送存储单元的地址信息。

  地址总线上能传送多少个不同的信息，CPU 就能对多少个存储单元进行寻址。一个 CPU 有 n 根地址线，就可以说这个 CPU 的地址总线宽度为 n，最多可寻址 2^n 个内存单元。

- **数据总线**：传送读或写的数据信息。

  CPU 与内存或其它器件之间的数据传送是通过数据总线来进行的。数据总线的宽度决定来 CPU 和外界的数据传送速度，例如：8 根数据总线一次可传送一个 8 位二进制数据即 1 Byte，16 根地址总线一次可传送 2 Byte。

- **控制总线**：传送器件选择、读写命令等控制信息。

  CPU 对外部器件的控制是通过控制总线进行的。控制总线是一些不同控制线的集合，有多少根控制线，就意味着 CPU 提供了对外部器件的多少种控制，也就是说控制总线的宽度决定了 CPU 对外部器件的控制能力。

### 1.3. 总线标准

相同的指令系统，相同的功能，不同厂家生产的各功能部件在实现方法上几乎没有相同的，但各厂家生产的相同功能部件却可以互换使用，其原因何在呢？

为了使不同厂家生产的相同功能部件可以互换使用，就需要进行系统总线的标准化工作。目前主要的总线标准有：
- ISA 总线标准
- EISA 总线标准
- PCI 总线标准

### 1.4. 总线带宽

总线带宽定义为总线本身所能达到的最高传输速率，它是衡量总线性能的重要指标。

## 2. 连接方式

大多数总线都是以相同的方式构成的，其不同之处在于总线中数据线和地址线的宽度，以及控制线的多少及其功能。

根据连接方式的不同，单机系统中采用的总线结构有 2 种基本类型：
- 单总线
- 多总线

### 2.1. 单总线连接

在许多单处理器的计算机中，使用一条单一的系统总线来连接 CPU、内存和 I/O 设备，称为单总线结构。

在单总线结构中，要求连接到总线上的逻辑部件必须高速运行，以便在某些设备需要使用总线时，能迅速获得总线控制权；而当不再使用总线时，能迅速放弃总线控制权。否则，由于一条总线由多种功能部件共用，可能导致很大的时间延迟，即某一时间只能允许一对设备之间传送数据，这就使得信息传送的效率和吞吐量受到极大限制。

单总线结构很容易扩展成多 CPU 系统。

### 2.2. 多总线连接

多总线结构的系统中，在 CPU、主存、I/O 之间互联采用多条总线：

![image](http://img.cdn.firejq.com/jpg/2019/2/13/8077e3453a3c81c957a6d3b69e037b84.jpg)

- CPU 和 cache 之间采用高速的 CPU 总线。
- 主存连在系统总线上。
- 高速总线上可以连接高速 LAN（100Mb/s 局域网）、视频接口、图形接口、SCSI 接口（支持本地磁盘驱动器和其他外设）、Firewire 接口（支持大容量 I/O 设备）。
- 高速总线通过扩充总线接口与扩充总线相连，扩充总线上可以连接串行方式工作的 I/O 设备。
- 通过桥 CPU 总线、系统总线和高速总线彼此相连。桥实质上是一种具有缓冲、转换、控制功能的逻辑电路。

多总线结构体现了高速、中速、低速设备连接到不同的总线上同时进行工作，以提高总线的效率和吞吐量，而且处理器结构的变化不影响高速总线。

## 3. 内部结构

### 3.1. 早期总线结构

早期总线的实际上是处理器芯片引脚的延伸，是处理器与 I/O 设备适配器的通道。这种简单的总线一般也由 50～100 条线组成，这些线按其功能可分为三类：
- 地址线
- 数据线
- 控制线

![image](http://img.cdn.firejq.com/1-1Q11319424C07.gif)

早期总线结构的不足之处在于：
- CPU 是总线上惟一的主控者。即使后来增加了具有简单仲裁逻辑的 DMA 控制器以支持 DMA 传送，但仍不能满足多 CPU 环境的要求。
- 总线信号是 CPU 引脚信号的延伸，故总线结构紧密与 CPU 相关，通用性较差。

### 3.2. 现代总线结构

在现代总线结构中，CPU 和它私有的 cache 一起作为一个模块与总线相连。系统中允许有多个这样的处理器模块。而总线控制器完成几个总线请求者之间的协调和仲裁。整个总线分成如下 4 个部分：
- 数据传送总线
- 仲裁总线
- 中断和同步总线
- 公用线

e.g. Pentium 计算机主板的总线结构是一个三层次的多总线结构，即 CPU 总线、PCI 总线和 ISA 总线：

![image](http://img.cdn.firejq.com/1-1Q113194332O4.gif)

- CPU 总线：是 64 位数据线和 32 位地址线的同步总线，可连接 4～128MB 的主存，还接有 L2 级 Cache。
- PCI 总线：用于连接高速的 I/O 设备模块，如图形显示器适配器、网络接口控制器、硬盘控制器等。
- ISA 总线：用于连接低速 I/O 设备模块。
- 桥芯片：CPU 总线、PCI 总线和 ISA 总线通过两个“桥”芯片连成整体，桥芯片在此起到了信号速度缓冲、电平转换和控制协议的转换作用。
  - 北桥：CPU 总线和 PCI 总线的桥
  - 南桥：PCI 总线和 ISA 总线的桥
  这样，每当 CPU 芯片升级时只需改变 CPU 总线和北桥芯片，全部原有的外围设备都可自动继续工作。

## 4. 总线仲裁

连接到总线上的功能模块有主动和被动两种形态，其中主方可以启动一个总线周期，而从方只能响应主方请求。每次总线操作，只能有一个主方，但是可以有多个从方。

**为了解决多个功能模块争用总线的问题，必须设置总线仲裁部件，以某种方式选择其中一个主设备作为总线的下一次主方**。对多个主设备提出的占用总线请求，一般采用优先级或公平策略进行仲裁。主方持续控制总线的时间称为总线占用期。

按照总线仲裁电路的位置不同，仲裁方式分为集中式和分布式两种。

### 4.1. 集中式仲裁

集中式仲裁中每个功能模块有两条线连到总线控制器：
- **送往仲裁器**的总线请求信号线 BR
- **仲裁线送出**的总线授权信号线 BG

#### 4.1.1. 链式查询方式

总线授权信号 BG 串行地从一个 I/O 接口传送到下一个 I/O 接口。假如 BG 到达的接口无总线请求，则继续往下查询；假如 BG 到达的接口有总线请求，BG 信 号便不再往下查询，该 I/O 接口获得了总线控制权。离中央仲裁器最近的设备具有最高优先级，通过接口的优先级排队电路来实现。

优点：只用很少几根线就能按一定优先次序实现总线控制，并且这种链式结构很容易扩充设备。

缺点：是对询问链的电路故障很敏感，优先级固定。

#### 4.1.2. 计算器定时查询方式

总线上的任一设备要求使用总线时，通过 BR 线发出总线请求。中央仲裁器接到请求信号以后，在 BS 线为“0”的情况下让计数器开始计数，计数值通过一组地址线发向各设备。每个设备接口都有一个设备地址判别电路，当地址线上的计数值与请求总线的设备地址相一致时，该设备 置“1”BS 线，获得了总线使用权，此时中止计数查询。 每次计数可以从“0”开始，也可以从中止点开发始。如果从“0”开始，各设备的优先次序与链式查询法相同，优先级的顺序是固定的。如果从中止点开始，则每个设备使用总线的优级相等。

计数器的初值也可用程序来设置，这可以方便地改变优先次序，但这种灵活性是以增加线数为代价的。可方便的改变优先级。

#### 4.1.3. 独立请求方式

每一个共享总线的设备均有一对总线请求线 BRi 和总线授权线 BGi。当设备要求使用总线时，便发出该设备的请求信号。总线仲裁器中有一个排队电路，它根据一定的优先次序决定首先响应哪个设备的请求，给设备以授权信号 BGi。

独立请求方式的优点是响应时间快，即确定优先响应的设备所花费的时间少，用不着一个设备接一个设备地查询。其次，对优先次序的控制相当灵活。它可以预先固定，例如 BR0 优先级最高，BR1 次之…BRn 最低；也可以通过程序来改变优先次序；还可以用屏蔽（禁止）某个请求的办法，不响应来自无效设备的请求。因此当代总线标准普遍采用独立请求方式。

### 4.2. 分布式仲裁

不需要中央仲裁器，每个潜在的主方模块都有自己的仲裁号和仲裁器，多个仲裁器竞争使用总线。当它们有总线请求时，把它们唯一的仲裁号发送到共享的仲裁总线上，每个仲裁器将仲裁总线上得到的号与自己的号进行比较。如果仲裁总线上的号大，则它的总线请求不予响应，并撤消它的仲裁号。最后，获胜者的仲裁号保留在仲裁总线上。显然，分布式仲裁是以优先级仲裁策略为基础。

## 5. Refer Links
