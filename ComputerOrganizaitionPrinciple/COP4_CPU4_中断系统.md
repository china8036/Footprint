- [计算机组成原理：CPU - 中断系统](#计算机组成原理cpu---中断系统)
  - [1. 基本概念](#1-基本概念)
  - [2. 中断源](#2-中断源)
    - [2.1. 内中断 / 软中断](#21-内中断--软中断)
    - [2.2. 硬中断 / 外中断](#22-硬中断--外中断)
      - [2.2.1. 可屏蔽中断](#221-可屏蔽中断)
      - [2.2.2. 不可屏蔽中断](#222-不可屏蔽中断)
  - [3. 中断优先级](#3-中断优先级)
    - [3.1. 单级中断系统](#31-单级中断系统)
    - [3.2. 多级中断系统](#32-多级中断系统)
  - [4. 中断处理程序](#4-中断处理程序)
    - [4.1. 基本逻辑](#41-基本逻辑)
    - [4.2. 安装过程](#42-安装过程)
  - [5. 中断过程](#5-中断过程)
  - [6. 单步中断机制](#6-单步中断机制)
  - [7. 特殊响应机制](#7-特殊响应机制)
  - [8. 实例：Pentium CPU 中断系统](#8-实例pentium-cpu-中断系统)
  - [9. Refer Links](#9-refer-links)

# 计算机组成原理：CPU - 中断系统

## 1. 基本概念

任何一个通用的现代 CPU 都具备了一种能力，可以在**执行完**当前正在执行的指令之后，检测到从 CPU 外部发送过来或从 CPU 内部产生的一种特殊信息，并且可以立即对所接收到的信息进行处理。这种特殊的信息称为中断信息。“中断”指的是 CPU 从刚执行完的指令序列中断，不再接着往下执行，而是转去处理这个特殊信息。

中断概念的出现，是计算机系统结构设计中的一个重大变革。**中断是 CPU 暂时中止现行程序，转去处理随机发生的紧急事件，处理完后自动返回原程序的功能和技术**。通常，当一个中断发生时，CPU 暂停它的现行程序，而转向中断处理程序，从而可以输入或输出一个数据。当中断处理完毕后，CPU 又返回到它原来的任务，并从它停止的地方开始执行程序。

中断系统是计算机实现中断功能的软硬件总称，它由硬件和软件结合来实现（中断周期由硬件实现，中断服务程序由机器指令序列实现）。**一般在 CPU 中设置中断机构，在外设接口中设置中断控制器，在软件上设置相应的中断服务程序**。

## 2. 中断源

中断源指的是产生中断信息的来源。

中断信息可以来自 CPU 的内部和外部，因此依据中断源进行分类可将中断分为内中断和外中断。

### 2.1. 内中断 / 软中断

内中断 / 软中断指的是 CPU 内部原因引起的中断，中断信号是由指令直接提供的。

i.e. 对于 8086CPU，当 CPU 内部有以下情况发生的时候，将产生相应的内中断信息：
- 除法错误（如执行 div 指令时产生的除法溢出）：中断类型码为 0
- 单步执行：中断类型码为 1
- 执行 into 指令：中断类型码为 4
- 执行 int 指令：中断类型码为 n (int n)

### 2.2. 硬中断 / 外中断

硬中断 / 外中断指的是外部设备原因引起的中断，中断信号是由中断控制器提供的。

当 CPU 外部有需要处理的情况发生时（如外设的输入到达），相关芯片将向 CPU 发出相应的中断信息。CPU 在执行完当前指令后，可以检测到发送过来的中断信息，引起中断过程，处理外设输入。

#### 2.2.1. 可屏蔽中断

可屏蔽中断是 CPU 可以不响应的外中断。当 CPU 检测到可屏蔽中断信息时，如果标志寄存器 IF=1，则 CPU 将响应中断；如果标志寄存器 IF=0，则 CPU 将不响应中断。

几乎外设引发的中断都是可屏蔽中断。

#### 2.2.2. 不可屏蔽中断

不可屏蔽中断是 CPU 必须响应的外中断。当 CPU 检测到不可屏蔽中断信息时，则在执行完当前指令后立即响应，引发中断过程。

不可屏蔽中断一般是在系统中有必须处理的紧急情况发生时用来通知 CPU 的中断信息。

## 3. 中断优先级

根据计算机系统对不同中断源优先级的处理策略不同，可分为单级中断系统和多级中断系统：

### 3.1. 单级中断系统

单级中断系统是中断结构中最基本的形式。**在单级中断系统中，所有的中断源都属于同一级，所有中断源触发器排成一行，其优先次序是离 CPU 近的优先权高**。当响应某一中断请求时，执行该中断源的中断服务程序。在此过程中，不允许其他中断源再打断中断服务程序，即使优先权比它高的中断源也不能再打断。只有该中断服务程序执行完毕之后，才能响应其他中断。

### 3.2. 多级中断系统

**多级中断系统是指计算机系统中有相当多的中断源，根据各中断事件的轻重缓急程度不同而分成若干级别，每一中断级分配给一个优先权**。一般说来，优先权高的中断级可以打断优先权低的中断服务程序，以程序嵌套方式进行工作。根据系统的配置不同，多级中断又可分为一维多级中断和二维多级中断。一维多级中断是指每一级中断中只有一个中断源；二维多级中断是指每一级中断中有多个中断源。

设置多级中断的系统一般都希望有较快的中断响应时间，因此首先响应哪一级中断和哪一个中断源，都是由硬件逻辑（中断优先级排队电路）实现，而不是用程序实现。

## 4. 中断处理程序

### 4.1. 基本逻辑

中断处理程序指的是用户编写的用来处理中断信息的程序，由于 CPU 随时都可能执行，因此中断处理程序必须常驻在内存某段空间之中。

中断处理程序的基本逻辑主要包括：
1. 保存用到的寄存器。
1. 执行处理中断的逻辑。
1. 恢复用到的寄存器。
1. 用 iret 指令使 CPU 返回执行中断处理程序之前的执行点继续往下执行。

### 4.2. 安装过程

除了由用户编写并安装到指定的内存区中的中断处理程序外，BIOS 和操作系统（如 DOS 系统）也提供了中断处理程序，其安装过程如下：
1. 计算机开机后，CPU 一加电，就初始化 `CS=0FFFFH, IP=0`，自动从 FFFF:0 单元开始执行程序。FFFF:0 处有一条转跳指令，CPU 执行该指令后，转去执行 BIOS 中的硬件系统检测和初始化程序。
1. 初始化程序将建立 BIOS 所支持的中断向量，即将 BIOS 提供的中断处理程序的入口地址登记在中断向量表中。注意，对于 BIOS 所提供的中断处理程序，只需将入口地址登记在中断向量表即可，因为它们是固化到 ROM 中的程序，在内存中一直存在。
1. 硬件系统检测和初始化完成后，调用 `int 19h` 进行操作系统的引导。从此计算机交由操作系统控制。
1. DOS 系统启动后，除完成其它工作外，还将它所提供的中断处理程序装入内存，并建立相应的中断向量。

## 5. 中断过程

CPU 收到中断信息后，要对中断信息进行处理，首先将引发中断过程。**中断过程由 CPU 的硬件负责实现和自动完成，硬件完成中断过程后，CS:IP 指向中断处理程序的入口地址，CPU 开始执行中断处理程序**。

中断过程主要包含以下阶段：
- 识别中断源

  CPU 首先要知道所接收到的中断信息的来源，因此中断信息种必须包含识别来源的编码，即**中断类型码**。中断类型码是一个字节型数据，可表示 256 种中断信息的来源。

- 保存现场

  由于 CPU 执行完中断处理程序后需要返回原来的执行点继续执行下面的指令，因此在转移之前需要先保存现场（即保存当前 CS 和 IP 的值），然后再设置 CS 和 IP。

- 映射中断处理程序

  CPU 在收到并识别了中断信息后，就应该转去执行该中断信息的中断处理程序，也就需要根据中断信息确定其处理程序的入口地址。CPU 用 8 位的中断类型码通过**中断向量表**找到相应的中断处理程序的入口地址，中断向量表即中断处理程序的入口地址列表。

  中断向量表在内存中保存，其中存放着 256 个中断源所对应的中断处理程序入口。对于 8086PC 机，中断向量表按照规范必须放在内存地址 0 处，即内存 0000:0000 ~ 0000:03FF 的 1024 个单元中肯定存放着中断向量表，8086CPU 就从这个规定的地址读取中断向量表。

i.e.

8086CPU 的中断处理过程：
1. 从中断信息中取得中断类型码。
1. 将标志寄存器的值入栈，并设置标志寄存器第 8 位 TF 和第 9 位 IF 的值为 0。
1. 将 CS 和 IP 的内容入栈。
1. 从内存地址为中断类型码 * 4 和中断类型码 * 4 + 2 的 2 个字单元中读取中断处理程序的入口地址并设置 CS 和 IP。
1. CPU 开始执行由用户编写的中断处理程序。

## 6. 单步中断机制

大部分通用的现代 CPU 都提供了单步中断机制，为单步跟踪程序的执行过程 (Debug) 提供了实现机制。

单步中断机制指的是 CPU 在执行完一条指令后，如果检测到标志寄存器的 TF 位为 1，则会产生一个单步中断，使 CPU 转向去执行 1 号中断处理程序。

## 7. 特殊响应机制

在有些情况下，CPU 在执行完当前指令后，即便是检测到发生了中断，也不会进行响应。

i.e. 对于 8086CPU，在执行完向 ss 寄存器传送数据的指令后，即便是发生中断，CPU 也不会响应。这是因为，ss:sp 联合指向栈顶，若 ss 改变而 sp 并未改变，将导致 ss:sp 指向错误的地址而引发错误。

## 8. 实例：Pentium CPU 中断系统

- Pentium 有 2 类中断源：
  - **中断**：通常称为外部中断，它是由 CPU 的外部硬件信号引发的。有两种情况 ：(1) 可屏蔽中断：CPU 的 INTR 引脚收到中断请求信号，如果 CPU 中标志寄存器 IF=1 时，可引发中断；IF=0 时，中断请求信号在 CPU 内部被禁止。(2) 非屏蔽中断：CPU 的 NMI 引脚收到的中断请求信号而引发的中断，这类中断不能被禁止。
  - **异常**：通常称为异常中断，它是由指令执行引发的。有两种情况：(1) 执行异常： CPU 执行一条指令过程中出现错误、故障等不正常条件引发的中断；(2) 执行软件中断指令： 如执行 INT 0，INT 3，INT n 等指令，执行时产生异常中断。

- Pentium CPU 依据中断向量号获取中断服务子程序入口地址，但在实模式和保护模式下采用不用的方式：
  - 实模式下使用中断向量表

    中断向量表 IVT 位于内存地址 0 开始的 1KB 空间。实模式是 16 位寻址，中断服务子程序入口地址（段，偏移) 的段寄存器和段内偏移量各为 16 位。它们直接登 记在 IVT 表中，每个中断向量号对应一个中断服务子程序入口地址。每个入口地址占 4 字节。 256 个中断向量号共占 1KB。CPU 取得向量号后自动乘以 4，作为访问 IVT 的偏移，读取 IVT 相应 表项，将段地址和偏移量设置到 CS 和 IP 寄存器，从而进入相应的中断服务子程序。

  - 保护模式下使用中断描述符表

    保护模式为 32 位寻址。中断描述符表 IDT 每一表项对应一个中断向量号，表项称为中断门描述符、陷阱门描述符。这些门描述符为 8 字节长，对应 256 个中断向量号，IDT 表长为 2KB。由中断描述符表寄存器 IDTR 来指示 IDT 的内存地址。

    以中断向量号乘以 8 作为访问 IDT 的偏移，读取相应的中断门 / 陷阱门描述符表项。门描述符 给出中断服务子程序入口地址（段，偏移)，其中 32 位偏移量装入 EIP 寄存器，16 位的段值装 入 CS 寄存器。由于此段值是选择符，还必须访问 GDT 或 LDT，才得到段的基地址。

## 9. Refer Links
