- [计算机组成原理：CPU - x86 体系架构](#计算机组成原理cpu---x86-体系架构)
  - [1. 基本概念](#1-基本概念)
  - [2. 体系内容](#2-体系内容)
  - [3. 运作模式](#3-运作模式)
    - [3.1. 实模式 (Real mode)](#31-实模式-real-mode)
    - [3.2. 保护模式 (Protected Mode)](#32-保护模式-protected-mode)
    - [3.3. 虚拟模式 (Virtual 8086 mode)](#33-虚拟模式-virtual-8086-mode)
  - [4. Refer Links](#4-refer-links)

# 计算机组成原理：CPU - x86 体系架构

## 1. 基本概念

**x86 是一种中央处理器指令集架构，最早于 1978 年由 Intel 8086 推出**。由于 Intel 8086 在 3 年后被 IBM PC 所选用，因此之后 **x86 成为了 PC 的标准平台，成为了历来最成功的 CPU 架构**。

P.S.
- [Intel 8086](https://en.wikipedia.org/wiki/Intel_8086)

  > Intel 8086 (iAPX 86) is a 16-bit microprocessor chip designed by Intel between early 1976 and June 8, 1978, when it was released. The 8086 gave rise to the x86 architecture, which eventually became Intel's most successful line of processors.
  >
  >  On June 5, 2018, Intel released a limited edition CPU celebrating the anniversary of the Intel 8086, called the Intel Core i7-8086K.

  - 晶体管：大约 20,000 个
  - 制造工艺（制程）：3.2 μm
  - 主频：5 MHz
  - 指令集：x86-16 （迄今 Intel 8086 的指令集仍然是 PC 机与服务器的基本指令集）
  - 字长：16 bits
  - 寄存器宽度：16 bits
  - Data Bus 宽度：16 bits
  - Control Bus 宽度：16 bits
  - Inner Address Bus 宽度：16 bits
  - External Address Bus 宽度：20 bits（物理定址空间为 2^20 bit = 1 MB）

  ![image](http://img.cdn.firejq.com/jpg/2019/1/6/7535badeb63e5a14d0f7b61ca312c1a4.jpg)

  8086 有 8 个 16 bits 的寄存器，包括栈寄存器 SP 与 BP，但不包括指令寄存器 IP、控制寄存器 FLAGS 以及四个段寄存器。AX, BX, CX, DX, 这四个寄存器可以按照字节访问；但 BP, SI, DI, SP, 这四个地址寄存器只能按照 16 位宽访问。

  - 外部总线作为数据与地址的复用，降低了 CPU 的性能。8086 的后继处理器的内存访问性能大大增强了。80186 与 80286 有专门的地址计算硬件，节约了很多时间周期。80286 的外部地址总线与数据总线是分开各自专用的。
  - 8086/8088 可以连接上专用的数学协处理器以增加浮点计算性能。标准的数学协处理是 Intel 8087，执行 80 位浮点数运算。

  外设：
  - Intel 8237：直接存储器存取（DMA）控制器
  - Intel 8251：USART
  - Intel 8253：可编程间隔定时器
  - Intel 8255：可编程序外围接口
  - Intel 8259：可编程中断控制器
  - Intel 8279：键盘 / 显示控制器
  - Intel 8282/8283：8 位锁存器
  - Intel 8284：时钟发生器
  - Intel 8286/8287：双向 8 位驱动
  - Intel 8288：总线控制器
  - Intel 8289：总线仲裁器

- Intel 在早期以 80x86 这样的数字格式来命名处理器，包括 Intel 8086、80186、80286、80386 以及 80486，**由于以“86”作为结尾，因此其架构被称为“x86”**；但由于数字并不能作为注册商标，因此之后，Intel 及其竞争者均在新一代处理器使用可注册的名称，如 Intel 的奔腾（Pentium）、酷睿（Core）和 AMD 的锐龙（Ryzen）等。

- Intel 主要 CPU 产品

  ![image](http://img.cdn.firejq.com/jpg/2019/1/6/5317555c1806c5055ec361952a146033.jpg)

## 2. 体系内容

- **x86-16**

  x86-16 是基于 x86 架构的 16-bit 处理器架构，最早由 Intel 的 8086CPU 推出。

  典型产品：Intel 8086、Intel 8088、Intel 80186、Intel 80188、Intel 80286 等。

- **x86-32 / IA-32**(Intel Architecture, 32-bit)

  x86-32 是基于 x86 架构的 32-bit 处理器架构，最早由 Intel 的 80386CPU 推出，因此一般又被称作 IA-32(Intel Architecture, 32-bit)。

  典型产品：Intel 80386、Intel 80486 等。

  P.S. 由于现今绝大多数计算机至少是 32-bit，因此通常情况下 x86 都被默认用来直接表示 x86-32 架构。

- **x86-64 / x64 / AMD64 / Intel64**

  x86-64 由 AMD 率先推出，因此又称为 AMD64。x86-64 是一种与 x86 架构兼容的 64-bit 处理器架构（AMD 在此之前购买了 Intel x86 架构的授权），同属于 x86 指令集架构家族。后来，之后也被 Intel 采用，称为 Intel64 / x64。

  典型产品：Intel Xeon（至强）系列、Intel Celeron（赛扬）系列、Intel Pentium（奔腾）系列、Intel Core（酷睿）系列处理器等。

P.S.

- [为什么我们还在使用 x86 CPU? 致敬 8086 处理器问世 40 周年](https://zhuanlan.zhihu.com/p/38002889)

  现在的 x86 已经远远不是原先的 x86，就像第一辆大规模量产的汽车 Model T 和现在的特斯拉，都是汽车，表层有很多不同，但更深层次的改变却深埋在躯壳之下。从 8086 的大约 20000 个晶体管，到现在数十亿个晶体管，量变的同时也有着本质的变化。我们现在很难说现在的 X86 还是不是复制指令集，超长指令集被解析成微码，而微码引入了精简指令集的很多概念和优化，从而 RISC 和 CISC 不再是泾渭分明的两方，而是融合进入了 x86 的内心。L1、L2、L3 甚至 L4 cache 的引入，各种高速内部外部总线的发明，不断地给 x86 注入新鲜的动力。是的，x86 在生长，在演化，并在演化中焕发出勃勃的生机。

  助力 x86 持续保持成功的另一很重要的因素是兼容性。尽管 CPU Die 上大约 30% 的部分都要被用来保持向前兼容，成本巨大，但它的好处却怎么强调都不为过，甚至安腾处理器都要发明 x86 兼容模式。沉重的历史有时候是负担，但忽略巨大的惯性则是愚蠢的。x86 多年积累的巨大生态系统，让任何企图忽略它的人们都付出了惨重的代价，包括 Surface RT 和 x86 的主人自己发明的安腾。

- EPIC(Explicitly Parallel Instruction Computers) / IA-64(Intel Architecture, 64-bit)

  IA-64(Intel Architecture, 64-bit) 是 Intel 在向 64 位处理器过渡时期（x86-32 与 x86-64 之间）与惠普合作推出的独立的处理器架构，**与 x86 指令体系完全不兼容因此并不属于 x86 指令集架构家族**。IA-64 在很多方面来说，都比 x86 有了长足的进步。突破了传统 IA32 架构的许多限制，在数据的处理能力，系统的稳定性、安全性、可用性、可观理性等方面获得了突破性的提高。但其最大的缺陷是和 x86 架构完全不兼容，导致在已经被 x86 大量覆盖的市场中反响极差。

  典型产品：Intel Itanium（安腾）系列处理器等。

## 3. 运作模式

从 Intel 80386 开始，x86 处理器都具备了 3 种工作模式：实模式、保护模式和虚拟 86 模式：
- Intel 8086: 实模式
- Intel 80286: 实模式 + 保护模式
- Intel 80386: 实模式 + 保护模式 + 虚拟 x86 模式

作为第一个同时支持这 3 种工作模式的 CPU，Intel 80386 成为了一个划时代的产品。80386 处理器的 3 种工作模式各有特点且相互联系：
- 实模式是 80386 处理器工作的基础，这时 80386 当做一个快速的 8086 处理器工作。在实模式下可以通过指令切换到保护模式，也可以从保护模式退回到实模式。
- 虚拟 86 模式则以保护模式为基础，在保护模式和虚拟 86 模式之间可以互相切换。
- 但不能从实模式直接进入虚拟 86 模式或从虚拟 86 模式直接退到实模式。

### 3.1. 实模式 (Real mode)

[实模式 (Real mode)](https://en.wikipedia.org/wiki/Real_mode) 实际上就是最早期的 **8086CPU** 唯一的工作模式。80386CPU 为向上兼容并区分其新推出的“保护模式”，因此将原 8086CPU 的工作模式归纳为“实模式”。在实模式 下，80386 处理器就相当于一个快速的 8086 处理器。

e.g. MS-DOS 系统就工作在实模式下。

模式特点：
- 80386 处理器被复位或加电的时候就以实模式启动，这时候处理器中的各寄存器以实模式的初始化值工作。Intel 80386 以及现在的奔腾、酷睿等等 CPU 为了向前兼容都保留了实模式，**现代操作系统在刚加电时首先运行在实模式下，然后再切换到保护模式下运行**。

- 实模式下 80386 不支持优先级，所有的指令相当于工作在特权级（优先级 0），所以它可以执行所有特权指令，包括读写控制寄存器 CR0 等。实际上，80386 就是通过在实模式下初始化控制寄存器，GDTR，LDTR，IDTR 与 TR 等管理寄存器以及页表，然后再通过加载 CR0 使其中的保护模式使能位置位而进入保护模式的。实模式下不支持硬件上的多任务切换。

- 实模式下的中断处理方式和 8086 处理器相同，也用中断向量表来定位中断服务程序地址。中断向量表的结构也和 8086 处理器一样，每 4 个字节组成一个中断向量，其中包括两个字节的段地址和两个字节的偏移地址。

寻址方式：
- 80386 处理器在实模式下的存储器寻址方式和 8086 是一样的，由段寄存器的内容乘以 16 当做基地址，加上段内的偏移地址形成最终的物理地址，即 `物理地址（20 位） = 段地址*16 + 偏移地址`，这时候它的 32 位地址线只使用了低 20 位。

- 在实模式下，处理器不能对内存进行分页管理，所以**指令寻址的地址就是内存中实际的物理地址**。实模式将整个物理内存看成分段的区域，所有的段都是可以读、写和执行的。程序代码和数据位于不同区域，但系统程序和用户程序并没有区别对待，每一个指针都是指向实际的物理地址。

存在问题：
- 实模式直接访问物理内存，用户程序的一个指针如果指向了系统程序区域或其他用户程序区域，并修改了内容，那么对于这个被修改的系统程序或用户程序，其后果就很可能是灾难性的。
- 实模式无法支持多任务运行环境。

### 3.2. 保护模式 (Protected Mode)

早期的 Intel 8086/8088 并不具备实现一个完善的多任务操作系统的功能，因此从 **Intel 80286** 开始出现了[保护模式 (Protected Mode / PMode)](https://en.wikipedia.org/wiki/Protected_mode)，从而具备了对多任务系统的支持，保护模式也成为后续 x86 处理器的主要工作模式。

e.g. 现今大部分的 x86 操作系统都在保护模式下运行，如 Linux、FreeBSD、Windows (>2.0)。

模式特点：
- 在保护模式下，支持内存分页机制，提供了对虚拟内存的良好支持。

- 在保护模式下，通过虚拟内存机制，32 根地址线全部都可供寻址，寻址空间达到 4GB。

- 保护模式提供了对多任务运行环境的硬件支持，可以依靠硬件仅在一条指令中实现任务切换，任务环境的保护工作是由处理器自动完成的。

- 在保护模式下，80386 处理器还支持优先级机制，不同的程序可以运行在不同的优先级上。优先级一共分 0～3 个级别，操作系统运行在最高的优先级 0 上，应用程序则运行在比较低的级别上；配合良好的检查机制后，既可以在任务间实现数据的安全共享也可以很好地隔离各个任务。从实模式切换到保护模式是通过修改控制寄存器 CR0 的控制位 PE（位 0）来实现的。在这之前还需要建立保护模式必需的一些数据表，如全局描述符 表 GDT 和中断描述符表 IDT 等。

- 保护模式机制克服了实模式下的内存非法访问问题，保证了安全性。**物理内存地址也不能直接被程序访问，程序内部的地址（虚拟地址）要由操作系统转化为物理地址去访问，程序对此一无所知**。至此，进程（程序的运行态）有了严格的边界，任何其他进程根本没有办法访问不属于自己的物理内存区域，甚至在自己的虚拟地址范围内也不是可以任意访问的，因为有一些虚拟区域已经被放进一些公共系统运行库。这些区域也不能随便修改，若修改就会有出现 linux 中的段错误，或 Windows 中的非法内存访问对话框。

寻址方式：
- 保护模式下，寻址方式使用虚拟内存存储机制，即通过操作系统对内存进行分段和分页。

- TODO: [实模式和保护模式区别及寻址方式](https://www.cnblogs.com/bethunebtj/articles/4839781.html)

P.S.

- 《深入理解 Linux 内核》 内存寻址这一章，提到了“硬件中的分段”、“Linux 中的分段”、“硬件中的分页”和“Linux 中的分页”四个概念，所谓的**硬件上的分段、分页，是针对 CPU 在实模式下，即操作系统尚未加载启动之前所采用的内存寻址方式，而软件上的分段、分页，则是 CPU 在保护模式下，即操作系统启动后所采用的内存寻址方式**。

存在问题：
- 对 8086/8088 的兼容却做的不好，这严重妨碍了用户对原 8086 机器上程序的使用。

### 3.3. 虚拟模式 (Virtual 8086 mode)

Intel 80286 虽然具备了对多任务系统的支持，但 80286 对 8086/8088 的兼容却做的不好，这严重妨碍了用户对原 8086 机器上程序的使用。因此，为了在保护模式下继续提供和 8086 处理器的兼容，后续产品 **Intel 80386** 在实模式、保护模式之外还设计了一种[虚拟 x86 模式 (Virtual 8086 mode)](https://en.wikipedia.org/wiki/Virtual_8086_mode)，这种方式的提供使用户可以方便地在保护模式允许一个或多个原 8086 程序，以便可以在保护模式的多任务条件下，有的任务运行 32 位程序，有的任务运行 MS-DOS 程序。在虚拟 86 模式下，同样支持任务切换、内存分页管理和优先级，但内存的寻址方式和 8086 相同，也是可以寻址 1MB 的空间。

虚拟 x86 模式以任务形式在保护模式上执行，在 80386 上可以同时支持由多个真正的 80386 任务和虚拟 x86 模式构成的任务。在虚拟 x86 模式下，80386 支持任务切换和内存分页。在 Windows 操作系统中，有一部分程序专门用来管理虚拟 x86 模式的任务，称为虚拟 x86 管理程序。

**既然虚拟 x86 模式以保护模式为基础，它的工作方式实际上是实模式和保护模式的混合**。为了和 8086 程序的寻址方式兼容，虚拟 x86 模式采用和 8086 一样的寻址方式，即 `物理地址（20 位） = 段地址*16 + 偏移地址`，寻址空间为 1MB。但显然多个虚拟 86 任务不能同时使用同一位置的 1MB 地址空间，否则会引起冲突。操作系统利用分页机制将不同虚拟 86 任务的地址空间映射到不同的物理地址上去，这样每个虚拟 86 任务看起来都认为自己在使用 0～1MB 的地址空间。

8086 代码中有相当一部分指令在保护模式下属于特权指令无法直接执行（如屏蔽中断的 `cli` 和中断返回指令 `iret` 等），但如果不让这些指令执行，8086 代码就无法工作。为了解决这个问题，虚拟 86 管理程序采用模拟的方法来完成这些指令。这些特权指令执行的时候引起了保护异常。虚拟 x86 管理程序在异常处理程序中检查产生异常的指令：
- 如果是中断指令，则从虚拟 x86 任务的中断向量表中取出中断处理程序的入口地址，并将控制转移过去。
- 如果是危及操作系统的指令，如 `cli` 等，则简单地忽略这些指令，在异常处理程序返回的时候直接返回到下一条指令。
通过这些措施，8086 程序既可以正常地运行下去，且中间的判断过程对 8086 程序是完全透明的。e.g. MS-DOS 应用程序在 Windows 操作系统中就是这样工作的。

## 4. Refer Links

[Wikipedia: x86](https://zh.wikipedia.org/wiki/X86)

[X86/X64 的处理器和 32/64 位的系统有什么关系？](https://www.zhihu.com/question/47389187)

[实模式、保护模式和虚拟模式](https://www.cnblogs.com/chengxuyuancc/archive/2013/05/12/3073738.html)
