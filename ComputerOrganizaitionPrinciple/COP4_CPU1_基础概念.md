- [计算机组成原理：CPU - 基础概念](#计算机组成原理cpu---基础概念)
  - [1. 发展历史](#1-发展历史)
  - [2. 主要功能](#2-主要功能)
  - [3. 基本组成](#3-基本组成)
    - [3.1. 运算器](#31-运算器)
    - [3.2. 控制器](#32-控制器)
    - [3.3. cache](#33-cache)
    - [3.4. 其它](#34-其它)
  - [4. 主要寄存器](#4-主要寄存器)
  - [5. 常见参数](#5-常见参数)
    - [5.1. CPU 性能](#51-cpu-性能)
    - [5.2. CPU 参数](#52-cpu-参数)
  - [6. Refer Links](#6-refer-links)

# 计算机组成原理：CPU - 基础概念

当用计算机解决某个问题时，我们首先必须为他编写程序。程序是一个指令序列，这个序列明确告诉计算机应该执行什么操作，在什么地方找到用来操作的数据。一旦程序装入了内存储器，就可以由计算部件来自动完成取指令和执行指令的任务。专门用来执行此项工作的计算机部件称为中央处理器 (CPU)。

## 1. 发展历史

- 晶体管（继电器 → 真空管 → 晶体管 / 半导体硅）的应用和集成工艺的提升，孕育了微处理器的诞生。

- 1971 年 11 月，Intel 推出 Intel 4004 (4-bit)。这是第一个将 CPU 的所有元件都放入同一块芯片内的产品，也是世界上第一个可商用的微处理器。

- 1972 年 4 月，Intel 推出 Intel 8008 (8-bit, 2 MHz, 14-bit address bus that could address 16 KB of memory)，这是世界上第一个 8 位微处理器，它比 4004 复杂一倍；同年 8 月，Motorola 推出了 Motorola 6800 (8-bit, 1 MHz, 14-bit address bus that could address 16 KB of memory)，也是一个 8 位的微处理器。这 2 个 CPU 被称为改变世界的 2 款 microprocessor。

- 1974 年，Intel 推出了 Intel 8080 (8-bit)，这是世界上第一个为通用微机而设计的微处理器（4004 和 8008 是为特殊用途而设计的）。

- 1976 年，Intel 推出了 Intel 8085 (8-bit)。

- 1978 年，Intel 推出了 Intel 8086 (16-bit)，由于 Intel 8086 在 3 年后被 IBM PC 所选用，因此 **x86 成为了 PC 的标准平台，成为了历来最成功的 CPU 指令集架构体系**。

- 1985 年，Intel 推出了 Intel 80386 (32-bit)，其保护模式是当今 x86 处理器主要的工作模式。

## 2. 主要功能

CPU 对整个计算机系统的运行是极其重要的，它具有如下四个方面的基本功能：
- 指令控制（程序的顺序控制）
- 操作控制（一条指令有若干操作信号实现）
- 时间控制（指令各个操作实施时间的定时）
- 数据加工（算术运算和逻辑运算）

## 3. 基本组成

早期的 CPU 仅由运算器和控制器两大部分组成。但随着 ULSI 技术的发展，早期放在 CPU 芯片外部的一些逻辑功能部件，如浮点运算器、cach 总线仲裁器等都被移入了 CPU 内部，因此，现代 CPU 的基本组成包括三大部分：

### 3.1. 运算器

运算器是数据加工的处理部件和执行部件，主要功能包括执行所有的算术运算和逻辑运算，它进行的全部操作都是由控制器发出的控制信号来指挥的。其组成部件包括：
- 算术逻辑单元 (ALU)
- 通用寄存器 GR
- 数据缓冲寄存器 DR
- 状态条件寄存器 PSW

### 3.2. 控制器

控制器是发布命令的“决策机构”，需要完成协调和指挥整个计算机系统的操作，其组成部件包括：

- 程序计数器 (Programming Counter)
  - 用来存放正在执行的指令的地址或接着将要执行的下一条指令的地址。
  - 顺序执行时，每执行一条指令，PC 的值应加 1。
  - 要改变程序执行顺序的情况时，一般由转移类指令将转移目标地址送往 PC，可实现程序的转移。
- 指令寄存器 (Instruction Register)
  - 指令寄存器用来存放从存储器中取出的待执行的指令。
  - 在执行该指令的过程中，指令寄存器的内容不允许发生变化，以保证实现指令的全部功能。
- 指令译码器 (Instruction Decoder)
  - 暂存在指令寄存器中的指令只有在其操作码部分经译码后才能识别出是一条什么样的指令。
  - 译码器经过对指令进行分析和解释，产生相应的控制信号提供给时序控制信号形成部件。
- 操作控制器
  - 操作控制器根据指令操作码和时序信号，产生各种操作控制信号，以便正确地选择数据通路，把有关数据打入到一个寄存器，从而完成取指令和执行指令的控制。
  - 根据设计方法不同，操作控制器分为：
    - 时序逻辑型 / 硬布线控制器，采用时序逻辑技术实现。
    - 存储逻辑型 / 微程序控制器，采用存储逻辑技术实现。
- 时序产生器
  - 操作控制器产生的控制信号必须定时，为此必须有时序产生器，时序产生器的作用就是对各种操作信号实施时间上的控制。因为计算机高速地进行工作，每一个动作的时间是非常严格的，不能太早也不能太迟。
  - 时序控制信号形成部件又称微操作信号发生器，真正控制各部件工作的微操作信号是由指令部件提供的操作信号、时序部件提供的时序信号、被控制功能部件所反馈的状态及条件综合形成的。

### 3.3. cache

### 3.4. 其它

除此之外，还有中断系统、总线接口等其他功能部件。

## 4. 主要寄存器

各种计算机的 CPU 可能有这样或那样的不同，但是在 CPU 中至少要有 6 类寄存器：
- 指令寄存器（IR）
- 程序计数器（PC）
- 数据地址寄存器（AR）
- 缓冲寄存器（DR）
- 通用寄存器（R0～R3）
- 状态字寄存器（PSW）

P.S.

- 寄存器个数

  现在 Intel 的最新一代 CPU 里大概有上百个寄存器，扣除重复使用的相同空间的寄存器，寄存器的大小大概是 2KB 多，具体的寄存器如下图：

  ![image](http://img.cdn.firejq.com/jpg/2019/1/11/7c72e6d942e557b1551e15742f29a921.jpg)

  (Registers available in the x86-64 instruction set)

- [阮一峰：为什么寄存器比内存快？](http://www.ruanyifeng.com/blog/2013/10/register.html)

  - 距离不同

    内存离 CPU 比较远，所以要耗费更长的时间读取。距离对于桌面电脑影响很大，对于手机影响就要小得多。手机 CPU 的时钟频率比较慢（iPhone 5s 为 1.3GHz），而且手机的内存紧挨着 CPU。

  - 硬件设计不同

    内存的设计相对简单，每个位就是一个电容和一个晶体管，而寄存器的设计则完全不同，多出好几个电子元件。并且通电以后，寄存器的晶体管一直有电，而内存的晶体管只有用到的才有电，没用到的就没电，这样有利于省电。这些设计上的因素，决定了寄存器比内存读取速度更快。

  - 工作方式不同

    寄存器的工作方式很简单，只有两步：
    1. 找到相关的位
    1. 读取这些位

    内存的工作方式就要复杂得多：
    1. 找到数据的指针。（指针可能存放在寄存器内，所以这一步就已经包括寄存器的全部工作了。）
    1. 将指针送往内存管理单元（MMU），由 MMU 将虚拟的内存地址翻译成实际的物理地址。
    1. 将物理地址送往内存控制器（memory controller），由内存控制器找出该地址在哪一根内存插槽（bank）上。
    1. 确定数据在哪一个内存块（chunk）上，从该块读取数据。
    1. 数据先送回内存控制器，再送回 CPU，然后开始使用。

    内存的工作流程比寄存器多出许多步。每一步都会产生延迟，累积起来就使得内存比寄存器慢得多。

  为了缓解寄存器与内存之间的巨大速度差异，硬件设计师做出了许多努力，包括在 CPU 内部设置缓存、优化 CPU 工作方式，尽量一次性从内存读取指令所要用到的全部数据等等。

- [为什么 X86 的寄存器数量没有随着性能的提升而增加？](https://www.zhihu.com/question/65682145/answer/233730966)

  - 从编译的角度看，寄存器压力（局部的数量不够用导致不得不访存），在寄存器多到一定程度（大概 16 到 32），就不那么大了。
  - 从乱序执行硬件的角度看，现代处理器一般都应用了**寄存器重命名**技术，很多还特别优化了 reg2reg mov 操作，所以对于寄存器不够用导致的额外搬移，在这些处理器上并不会有非常大的性能损失（或者说软件在这方面的优化空间有限）。
  - 另外 x86 处理器的访存单元会特别优化，像 st fwd ld 都做的比较激进，所以你用一些内存读写也不影响性能。

## 5. 常见参数

### 5.1. CPU 性能

[CPU 性能天梯图](http://www.mydrivers.com/zhuanti/tianti/cpu/)

[CPU 性能对比](https://www.cpu-monkey.com/en/)

### 5.2. CPU 参数

- 型号

  以 Intel CPU 为例，CPU 分为高中低端，最低端的是 G 系列，其次是低端 i3 系列，然后是中端 i5 系列，高端 i7 系列和至尊 i9 系列。这个命名就和汽车一样，比如宝马 3 系，宝马 5 系，宝马 7 系。但要注意的是，Intel 的命名可不止就是 i3、i5、i7，如常见的 i7 8700K、i5 8400、i7 7700HQ、i3 8100，**i3、i5、i7 只是代表 CPU 中高低端产品线而不是代表具体产品型号**。

  ![image](http://img.cdn.firejq.com/jpg/2018/10/29/bc537d5ebd0d0ee0ec7b21507a122b0b.jpg)

  其中，i7 代表了它属于高端系列产品，7700，第一个数字 7 代表了他是第 7 代产品，后面的 700 基本就代表了他处于什么样的性能等级，后缀 K 代表着他的功率水平和特殊功能。

  Intel 更新 CPU 的时候是 i3 6100、i3 7100、i3 8100，也就是不断更新“代”，而不是不断更新 i3、i5、i7、i9、i11。什么意思？就是 intel 每次发布新的 CPU 就会 i3、i5、i7，全部发布一套，下一次升级就再发布一套新的 i3、i5、i7。

  ![image](http://img.cdn.firejq.com/jpg/2018/10/29/702497e333f9758cb7f1c6dfe7031612.jpg)

  CPU 代数（架构系列）是保证 CPU 性能最主要的因素，如果不是相隔代数过多来比较其他参数完全没有意义。例如 zen+ 架构下的 2600，和推土机架构下的 fx8300，论核心 fx8300 是八核，2600 只是六核，论主频 8300 单核心最大 4.2ghz，2600 只有 3.9ghz, 但是由于 zen+ 相比推土机架构领先太多太多，2600 甚至性能超 fx8300 两倍多。

  Intel CPU 主要系列：
  - Generation 3 / Sandy Bridge
  - Generation 4 / Ivy Bridge
  - Generation 5 / Haswell
  - Generation 6 / Broadwell / Skylake
  - Generation 7 / Kaby Lake
  - Generation 8 / Coffee Lake

  其中除了初代，从二代开始架构提升并不明显，每代平均 5% 左右，也就是说其他参数一样，3 代酷睿和 2 代酷睿差距也就 5%，4 代比 3 代强 5%。但是积小成多，每代挤牙膏，也过了 6 代了，8 代和 2 代的差距也是非常大的了，一般来说越新的架构越强。

- CPU ID

  CPU ID 是 CPU 生产厂家为识别不同类型的 CPU，而为 CPU 制订的不同的单一的代码，通常以十六进制表示。如 “0F24”（Inter 处理器）、“681H”（AMD 处理器），根据这些数字代码即可判断 CPU 属于哪种类型。

  不同厂家的 CPU，其 CPU ID 定义也是不同的：
  - Inter

    Intel CPU 的 CPU ID 一般包含四个十六进制数字，如“0F24”，从左至右分别表示 Type（类型）、Family（系列）、Mode（型号）和 Stepping（步进编号）。从 CPUID 为“068X”的处理器开始，Inter 另外加了 Brand ID（品种标识）用来辅助应用程序识别 CPU 的类型，因此根据“068X”CPUID 还不能正确判别 Pentium 和 Celerom 处理器，必须配合 Brand ID 来进行细分。
    - **CPU Type**（类型）: 类型标识，用来区别 Intel CPU 的适合应用场景（数字“1”标识所测试的微处理器是用于由用户安装的；数字“0”标识所测试的微处理器是用于由专业 PC 系统集成商、服务公司或制作商安装的）。我们通常使用的 Intel CPU 类型标识都是“0”，如“0F24”。**Intel 酷睿处理器 i3、i5、i7 指的就是 CPU Type**。
    - **CPU Family**（系列）: 产品系列标识，用来确定处理器是属于哪一代的产品。**Intel 酷睿处理器 Sandy Bridge、Ivy Bridge、Haswell 等指的就是 CPU Family**。
    - **CPU Mode**（型号）: 型号与系列通常是相互配合使用的，用以确定 CPU 是属于处理器系列中的哪一种特定类型。
    - **CPU Stepping**（步进编号）: 更新版本标识。
    - **CPU Brand_id**（品种标识）:
    - **CPU Vendor_id**（制造商标识）:

  - AMD

    AMD CPU 的 CPUID 一般包含三位十六进制数字，如“681”，从左至右分别表示为 Family（系列）、Mode（型号）和 Stepping（步进编号）。

- 主频

  在电子技术中，脉冲信号是一个按一定电压幅度，一定时间间隔连续发出的模拟信号。脉冲信号之间的时间间隔称为周期；而将在单位时间（如 1 秒）内所产生的脉冲个数称为频率。频率是描述周期性循环信号（包括脉冲信号）在单位时间内所出现的脉冲数量多少的计量名称；频率的标准计量单位是 Hz（赫）。电脑中的系统时钟就是一个典型的频率相当精确和稳定的脉冲信号发生器。

  CPU 的主频，即 CPU 内核工作的时钟频率（CPU Clock Speed）。通常所说的某某 CPU 是多少兆赫的，而这个多少兆赫就是“CPU 的主频”。**CPU 的主频表示在 CPU 内数字脉冲信号震荡的速度，与 CPU 实际的运算能力并没有直接关系**。由于主频并不直接代表运算速度，所以在一定情况下，很可能会出现主频较高的 CPU 实际运算速度较低的现象。主频的比较是建立在其他条件基本相同的情况下来讨论的，比如你手机或许 2.5GHz 的频率，而我笔记本 2.0GHz，并不代表你手机的 CPU 性能比我笔记本的还好。因为核心数、缓存、架构（最主要是它）等等参数完全不一样。所以同是 i5 4460 和 i5 4590 的时候，3.3GHz 相对于 3.2GHz 才有优势，但 0.1 的频率实际感受有多大？个人意见：几乎没有。

  提高 CPU 工作主频主要受到生产工艺的限制。由于 CPU 是在半导体硅片上制造的，在硅片上的元件之间需要导线进行联接，由于在高频状态下要求导线越细越短越好，这样才能减小导线分布电容等杂散干扰以保证 CPU 运算正确。因此制造工艺的限制，是 CPU 主频发展的最大障碍之一。

  `CPU 的主频 = 外频 x 倍频`
  - 外频

    外频是 CPU 乃至整个计算机系统的基准频率，因为外频是 CPU 与主板之间同步运行的速度，而且绝大部分电脑系统中外频也是内存与主板之间的同步运行的速度。在这种方式下，可以理解为 CPU 的外频直接与内存相连通，实现两者间的同步运行状态。

  - 倍频

    倍频即主频与外频之比的倍数。早期的 CPU 并没有“倍频”这个概念，那时主频和系统总线的速度是一样的。随着技术的发展，CPU 速度越来越快，内存、硬盘等配件逐渐跟不上 CPU 的速度了，而倍频的出现解决了这个问题，它可使内存等部件仍然工作在相对较低的系统总线频率下，而 CPU 的主频可以通过倍频来无限提升（理论上）。

    CPU 厂商基本上都会把倍频锁死，因此要超频只有从外频下手，通过倍频与外频的搭配来对主板的跳线或在 BIOS 中设置软超频，从而达到计算机总体性能的部分提升。

  - 自动降频

    CPU 温度超过一定限度后，CPU 会出于自我保护而降频。

  - 超频

    超频就是通过人为的方式将 CPU、显卡等硬件的工作频率提高（实际就是提高电压），让它们在高于其额定的频率状态下稳定工作。以 Intel P4C2.4GHz 的 CPU 为例，它的额定工作频率是 2.4GHz，如果将工作频率提高到 2.6GHz，系统仍然可以稳定运行，那这次超频就成功了。

- 核心数

  一般来说，相同架构下，四核心四线程的 CPU 性能大约是双核双线程的 1.8 倍，当然这只是理论上，不过一般四核心主频更高缓存更高，性能表现为 2 倍。这里我们说一下超线程技术，四核四线程和四核八线程有什么区别，超线程是一种技术而非物理元器件，它和核心不同，这种技术使得一个核心模拟两个虚拟核心运作，提高单个运行效率，一般我们认为超线程的提升是 25% 到 40%，这和架构也有关系，也就是说在其他一样的情况下四核八线程比四核四线程强 30%。但是四核八线程只是四核心，相比六核六线程它就更差一点了。

- 制程工艺

  常见的 45nm，28nm 都是说制程的。CPU 就是几亿个负责开与关的晶体管，而在面积相同的一个 CPU 上，当然是塞进去的晶体管越多其性能越好。怎样放的更多呢？那就是降低晶体管的大小。同样数量不同大小的晶体管，更小的制程意味着更低的功耗和发热。

  处理器发展经过了几十年，130nm、65nm、45nm、32nm、22nm、14nm、12nm 等等，工艺越先进，等大小的硅晶片上能集成的晶体管数量越多，CPU 性能就越好，功耗发热处理也更好。

- 热设计功耗 (TDP)

- 接口

  常见的接口有 1155，1150，FM2，这些只是接口的名字，就像 USB、VGA、HDMI 一样，Intel 的接口通常数字代表了其针角的数量。而数字前面一般还有 LGA，BGA，Socket 等字样，这代表的是其封装方式，这和接口一样，并没有孰优孰劣，只是平台不同。

- 缓存

  一般来说 CPU 的缓存分为 L1、L2、L3，缓存是因为内存的速度太慢，拖累处理器，处理器把即将要用的数据从内存调用到高速缓存中，先看 L1，CPU 有 80% 概率从 L1 缓存中获取数据，如果不行那就 L2，最后实在不行那就 L3，缓存的速度非常块一般来说相当于 CPU 的频率，锐龙现在单核心比不过酷睿也和缓存延迟大有关系。

- 指令集

  CPU 所支持的指令集，其实就是一个任务表，比如任务表里有 ABCDE 这 5 个选项，指令集发送 A，那么 A 所对应的 1、2、3、4、5 步操作就由 CPU 来完成。

  指令集越新效率越高，越多性能越强，与软件契合度越高。如 G4600 主频核心缓存都和 i3 6100 接近，但是它缺少部分指令集，性能就稍微弱一点。

- 字长

  e.g. 16 位 CPU / 字长为 16 位，描述了一个 CPU 具有以下几方面的结构特性：
  - 运算器一次最多可以处理 16 位的数据。字长越大，计算精度越高。
  - 寄存器的最大宽度为 16 位。
  - 寄存器和运算器之间的传输通路为 16 位。

- 其它
  - CPU 的性能还和主板支持的技术有关例如 amd 的 Precision Boost 2，AMD 的 400 系主板的 bios 会采用更激进的电压和温控策略对 cpu 在多核使用情况下进行睿频，甚至在某些情况下全核都能达到单核心最大的频率，目前也只有 X470 支持。

e.g.

i3-8100 参数说明：
- CPU 系列	  酷睿 i3 8 代系列
- 制作工艺	14 纳米
- 核心代号	Coffee Lake
- 插槽类型	LGA 1151
- CPU 主频	  3.6GHz
- 核心数量	四核心
- 线程数量	四线程
- 三级缓存	6MB
- 热设计功耗 (TDP)	65W
- 内存类型	DDR4 2400MHz
- 集成显卡	Intel UHD Graphics 630
- 超线程技术	不支持

## 6. Refer Links

[i7 真的就比 i5 好吗，我们一定要 i7 吗](https://zhuanlan.zhihu.com/p/37798889)

[如何看懂电脑参数——CPU 篇](https://zhuanlan.zhihu.com/p/20495438)

[百度百科：CPU 主频](https://baike.baidu.com/item/%E4%B8%BB%E9%A2%91/103191?fromtitle=CPU%E4%B8%BB%E9%A2%91&fromid=3519849)

[CPU Family, Model, Stepping 以及 CPU ID, DisplayFamily_DisplayModel](http://blog.sina.com.cn/s/blog_605f5b4f010180st.html)

TODO:

[为什么 ARM 和 MIPS 那么多寄存器，x86 那么少？](https://www.zhihu.com/question/24551779)

[关于现代 CPU，程序员应当更新的知识](https://linux.cn/article-6201-1.html)
