- [计算机组成原理：CPU - 流水 CPU](#计算机组成原理cpu---流水-cpu)
  - [1. 流水计算机系统组成](#1-流水计算机系统组成)
  - [2. 流水线原理](#2-流水线原理)
  - [3. 流水线形式](#3-流水线形式)
  - [4. 流水线问题](#4-流水线问题)
    - [4.1. 资源相关](#41-资源相关)
    - [4.2. 数据相关](#42-数据相关)
    - [4.3. 控制相关](#43-控制相关)
  - [5. Refer Links](#5-refer-links)

# 计算机组成原理：CPU - 流水 CPU

## 1. 流水计算机系统组成

CPU 按流水线方式组织，通常由三大部分组成：指令部件、指令队列、执行部件。这三个功能部件可以组成一个流水线。

指令部件本身又构成一个流水线，即指令流水线，它由取指令、指令译码器、计算操作数地址、取操作数等几个过程段组成。

指令队列是一个先进先出（FIFO）得寄存器栈，用于存放经过译码的指令和取来的操作数。它也是由若干个过程段组成的流水线。

执行部件可以具有多个算术逻辑运算部件，这些部件本身又用流水线方式构成。

在现有的流水线计算机中，存储器几乎都是采用交叉存取的方式工作。

执行段的速度匹配问题，通常采用并行的运算部件以及部件流水线的工作方式来解决。一般采用的方式包括：
- 将执行部件分为定点执行部件和浮点执行部件两个可并行执行的部分，分别处理定点运算和浮点运算指令。
- 在浮点执行部件中，又有浮点加法部件和浮点乘除部件，它们也可以同时执行不同的指令。
- 浮点运算部件都以流水线方式工作。

## 2. 流水线原理

计算机的流水处理过程非常类似于工厂中的流水装配线。为实现流水，首先把输入的任务（或过程）分割为一系列子任务，并使各子任务能在流水线的各个阶段并发地执行。当任务连续不断地输入流水线时，在流水线的输出端便能连续不断地吐出执行结果，从而实现了子任务级的并行。

- **标量流水线**：只拥有一条指令流水线的流水计算机称为标量流水线，标量流水计算机是**时间并行技术的应用**。

- **超标量流水线**：拥有两条以上指令流水线的流水计算机称为超标量流水线，超标量流水计算机是**时间并行技术和空间并行技术的综合应用**，如 Pentium 微型机。

e.g.

![image](http://img.cdn.firejq.com/jpg/2019/2/11/139f625359752c5ebd0410a22e40b7ea.jpg)

如图，各个过程段之间设有高速缓冲寄存器，以暂时保存上一段子任务处理的结果。在统一的时钟信号控制下，数据从一个过程段流向相邻的过程段。

- 对于非流水计算机，上一条指令的四个子过程全部执行完毕后才能开始下一条指令。因此，每隔 4 个机器时钟周期才有一个输出结果。
- 对于标量流水计算机，上一条指令与下一条指令的 4 个子过程在时间上可以重叠执行。因此，当流水线满载时，每一个时钟周期就可以输出一个结果。
- 对于超标量流水计算机，拥有两条以上的指令流水线，上一条指令与下一条指令的 4 个子过程在时间上可以重叠执行。因此，当流水线满载时，每一个时钟周期就可以输出 2 条指令执行结果。

## 3. 流水线形式

一个计算机系统可以在不同的并行等级上使用流水线技术，常见的流水线形式有：
- 指令流水线：指指令步骤的并行，将指令流的处理过程划分为取指令、译码、取操作数、执行、写回等几个并行处理的过程段。目前，几乎所有的高性能计算机都采用了指令流水线。
- 算术流水线；指运算操作步骤的并行。如流水加法器、流水乘法器、流水除法器等。现代计算机中已广泛采用了流水的算术运算，如 STAR-100 为 4 级流水运算器。
- 处理机流水线 / 宏流水线：指程序步骤的并行。由一串级联的处理机构成流水线的各个过程段，每台处理机负责某一特定的任务。数据流从第一台处理机输入，经处理后被送入第二台处理机相联的缓冲存储器中；第二台处理机从该存储器中取出数据进行处理，然后传送给第三台处理机，如此串联下去。随着高档微处理器芯片的出现，构造处理机流水线将变得更加容易。处理机流水线主要应用在多机系统中。

## 4. 流水线问题

要使流水线具有良好的性能，必须使流水线畅通流动，不发生断流。但由于流水过程中会出现多种相关冲突，给流水线不断流带来了困难。

### 4.1. 资源相关

资源相关问题指的是多条指令进入流水线后在同一机器时钟周期内争用同一个功能部件所发生的冲突。

解决方法：
- 让后边的指令停顿一拍后再启动。
- 增设一个存储器，将指令和数据分别放在两个存储器中

### 4.2. 数据相关

数据相关问题指的是在一个程序中，必须等前一条指令执行完毕后，才能执行后一条指令，但流水计算机中指令的处理是重叠进行的，因此会产生“先读后写”的数据相关冲突。

解决方法：
- “向前” 或定向传送技术：在流水 CPU 的运算器中设置若干运算结果缓冲寄存器，暂时保留运算结果，以便于后续指令直接使用。

### 4.3. 控制相关

控制相关问题指的是当执行转移指令时，依据转移条件的产生结果，可能为顺序取下条指令，也可能转移到新的目标地址取指令，从而使流水线发生断流。

解决方法：
- 延迟转移法：由编译程序重排指令序列来实现，基本思想是“先执行再转移”。
- 转移预测法：由硬件方法来实现，依据指令过去的行为来预测将来的行为。

## 5. Refer Links
