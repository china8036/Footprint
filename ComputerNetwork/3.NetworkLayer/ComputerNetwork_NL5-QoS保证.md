- [计算机网络 - 网络层：服务质量保证](#计算机网络---网络层服务质量保证)
  - [1. 流量整形 (traffic shaping)](#1-流量整形-traffic-shaping)
    - [1.1. 漏桶算法 (leaky bucket)](#11-漏桶算法-leaky-bucket)
    - [1.2. 令牌桶算法 (token bucket)](#12-令牌桶算法-token-bucket)
      - [1.2.1. 基本概念](#121-基本概念)
      - [1.2.2. 基本原理](#122-基本原理)
      - [1.2.3. 应用实例](#123-应用实例)
  - [2. 资源预留](#2-资源预留)
  - [3. 准入控制](#3-准入控制)
  - [4. 分组 / 包调度](#4-分组--包调度)
  - [5. Refer Links](#5-refer-links)

# 计算机网络 - 网络层：服务质量保证

## 1. 流量整形 (traffic shaping)

**流量整形 (traffic shaping) 也称为流量控制，是指调节进入网络的数据流的平均速率和突发性数据流所采用的技术，属于网络层操作**。它的目标是在允许应用程序发送适合他们需求的各种流量和某种程度的突发事件的同时，向网络提供一个简单易用的方式来描述可能的流量模式。

流量整形技术可以减少拥塞，有助于服务提供者兑现其服务承诺。

**流量整形对于 P2P 和其它消耗可用带宽的数据传输并不是很重要，但对于实时数据传输有着很重要的意义，如音频、视频连接数据流**。

流量整形算法一般包括 2 种类型：
- 流量速率控制
- 流量并发控制

### 1.1. 漏桶算法 (leaky bucket)

漏桶算法 (Leaky Bucket) 是网络世界中流量整形（Traffic Shaping）或速率限制（Rate Limiting）时经常使用的一种算法，它的主要目的是控制数据注入到网络的速率，平滑网络上的突发流量。漏桶算法提供了一种机制，通过它，突发流量可以被整形以便为网络提供一个稳定的流量。

- 到达的数据包（网络层的 PDU）被放置在底部具有漏孔的桶中（数据包缓存）。
- 漏桶最多可以排队 b 个字节，漏桶的这个尺寸受限于有效的系统内存。如果数据包到达的时候漏桶已经满了，那么数据包应被丢弃。
- 数据包从漏桶中漏出，以常量速率（r 字节 / 秒）注入网络，因此平滑了突发流量。

### 1.2. 令牌桶算法 (token bucket)

http://baike.baidu.com/item/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95 

https://blog.jamespan.me/2015/10/19/traffic-shaping-with-token-bucket

#### 1.2.1. 基本概念

[令牌桶算法](https://en.wikipedia.org/wiki/Token_bucket) 是一种最常使用的流控算法，属于控制速率类型的。

在网络中传输数据时，为了防止网络拥塞，需限制流出网络的流量，使流量以比较均匀的速度向外发送。令牌桶算法就实现了这个功能，可控制发送到网络上数据的数目，并允许突发数据的发送。

#### 1.2.2. 基本原理

令牌桶算法的基本过程如下：
1. 假如用户配置的平均发送速率为 r，则每隔 1/r 秒会产生一个令牌（**每一个令牌都代表一个字节**）并加入到桶中。假设用户配置的桶最多可以存放 b 个令牌。如果令牌到达时令牌桶已经满了，那么这个令牌会被丢弃。
1. **当一个 n 个字节的数据包到达时，就从令牌桶中删除 n 个令牌（不同大小的数据包，消耗的令牌数量不一样），并且数据包被发送到网络（数据包不占桶容量，令牌才占，令牌桶是用来放令牌的）**。
1. 如果桶中可用令牌小于 n，会认为这个数据包在流量限制之外，对于在流量限制外的数据包可以以不同的方式处理：
    - 它们可以被丢弃。
    - 它们可以排放在队列中以便当令牌桶中累积了足够多的令牌时再传输。
    - 它们可以继续发送，但需要做特殊标记，网络过载的时候将这些特殊标记的包丢弃。

令牌桶这种控制机制基于令牌桶中是否存在令牌来指示什么时候可以发送流量。**如果令牌桶中存在令牌，则允许发送流量；而如果令牌桶中不存在令牌，则不允许发送流量**。因此，如果突发门限被合理地配置并且令牌桶中有足够的令牌，那么流量就可以以峰值速率发送。该算法允许最长 b 个字节的突发，但从长期运行结果看，数据包的速率被限制成常量 r。

令牌桶算法与漏桶算法的主要区别在于：
- 令牌桶算法控制的是一个时间窗口内的通过的数据量（类似 QPS/TPS），在能够限制数据的平均传输速率外，还允许某种程度的突发传输。
  
  在“令牌桶算法”中，只要令牌桶中存在令牌，那么就允许突发地传输数据直到达到用户配置的门限，因此它适合于具有突发特性的流量。

- 漏桶算法能够强行限制数据的传输速率。

#### 1.2.3. 应用实例

Eureka/Guava 中就使用 token bucket 来实现 RateLimter。

## 2. 资源预留

## 3. 准入控制

## 4. 分组 / 包调度

## 5. Refer Links