- [计算机网络 - 网络层：路由 - 路由协议](#计算机网络---网络层路由---路由协议)
  - [1. 域内路由算法 (IR)/ 内部网关协议 (IGP)](#1-域内路由算法-ir-内部网关协议-igp)
    - [1.1. 路由信息协议 (RIP)](#11-路由信息协议-rip)
    - [1.2. 开放最短路径协议 (OSPF)](#12-开放最短路径协议-ospf)
      - [1.2.1. OSPF 数据包](#121-ospf-数据包)
      - [1.2.2. OSPF 运行步骤](#122-ospf-运行步骤)
      - [1.2.3. OSPF 状态](#123-ospf-状态)
      - [1.2.4. DR/DBR 选举](#124-drdbr-选举)
      - [1.2.5. OSPF 路由器](#125-ospf-路由器)
      - [1.2.6. 路径选择](#126-路径选择)
  - [2. 域间路由算法 (IR)/ 外部网关协议 (EGP)](#2-域间路由算法-ir-外部网关协议-egp)
    - [2.1. 边界网关协议 (BGP)](#21-边界网关协议-bgp)
  - [3. Refer Links](#3-refer-links)

# 计算机网络 - 网络层：路由 - 路由协议

## 1. 域内路由算法 (IR)/ 内部网关协议 (IGP)

在各自的网络内，一个组织可以使用自己的内部路由算法，这种算法称为域内路由算法 / 内部网关协议，只不过一般使用的只有几个标准协议。

### 1.1. 路由信息协议 (RIP)

早期的域间路由协议采用了距离矢量的设计思想，基于继承自 ARPANET 的分布式 Bellman-Ford 算法。路由信息协议 (RIP) 是当时运行的一个主要例子。 

### 1.2. 开放最短路径协议 (OSPF)

针对距离矢量路由算法的各种问题， ARPANET 切换到了链路状态路由算法的设计思想。

IS-IS 就是一个基于链路状态路由算法的协议，OSPF 借鉴了 IS-IS，成为了一个 ISO 标准；这两个协议在域内路由协议中占有绝对的优势，大多数的路由器都同时支持这两个协议。IS-IS 广泛的应用在 ISP 网络，OSPF 则更广泛的应用在公司网络。

**开放式最短路径优先（英语：Open Shortest Path First，缩写为 OSPF）是对链路状态路由协议的一种实现，隶属内部网关协议（IGP），故运作于自治系统内部。采用戴克斯特拉算法（Dijkstra）来计算最短路径树，使用代价 (Cost)/ 跳数作为路由度量**。

链路状态数据库（LSDB）用来保存当前网络拓扑结构，路由器上属于同一区域的链路状态数据库是相同的（属于多个区域的路由器会为每个区域维护一份链路状态数据库）。

OSPF 分为 OSPFv2 和 OSPFv3 两个版本，其中 OSPFv2 用在 IPv4 网络，OSPFv3 用在 IPv6 网络。

与 RIP 和 BGP 不同的是，OSPF 协议不使用 TCP 或者 UDP 协议而是承载在 IP 协议之上，IP 协议号为 89，工作在 OSI 模型的传输层，如下图：

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/f372341370ee2af9ad4ff1725a74234d.jpg)

**OSPF 协议是大中型网络上使用最为广泛、性能最优的 IGP（Interior Gateway Protocol）协议**。

#### 1.2.1. OSPF 数据包

OSPF 定义了以下 5 种协议数据包类型：
- Hello 包 HELLO：与邻居建立和维护毗邻关系

  Hello 包的 OSPF 包类型为 1。这些包被周期性的从各个接口（包括虚链路）发出，用来建立和维护邻居关系。另外，在支持组播或广播的物理网络上，Hello 包使用组播地址（通常为 224.0.0.5) 发送。 Hello 包的发送间隔由 HelloInterval 指定（通常为 10s），路由器将会先发出不包含邻居字段的空 Hello 包，当收到邻接路由器的 Hello 包之后，将对方的路由器标识放入本机的 Hello 包中进行组播，这种包含邻居字段的包，也被称为 HelloSeen 包。假如在间隔达到 RouterDeadInterval 所规定的时长（通常为 40s）内仍未收到一个已建立连接的路由器的 Hello 包，路由器将会终止这一连接。将对方的状态转为 Down。

- 数据库描述包 DD：描述一个 OSPF 路由器的链路状态数据库内容

  数据库描述包（Database Description）的 OSPF 包类型为 2。当邻接关系初始化后，便开始交换这些数据包。它们描述了链路状态数据库的摘要信息（只包含 LSA 的头部信息）。

  数据库描述包包含两种，即空数据库描述包和包含 LSA 头部信息的数据库描述包。

  当两个路由器互相收到 HelloSeen 包之后，他们将会开始互相发送空数据库描述包，空数据库描述包被用来进行主从关系的确定。 通常以路由标识较大的为 Master，当主从关系确立之后，从机将会使用主机的序号向主机发送第一个包含 LSA 头部信息的数据库描述包。 主机将会在收到从机的数据库描述包之后发送自己的序号加一的数据库描述包，作为对于从机的收到确认。 在这样的交互过程中，只有主机可以更改序号 (DD sequence number)，从机使用主机序号。

- 链路状态请求包 LSR：请求相邻路由器发送其链路状态数据库中的具体条目

  链路状态请求包（Link State Request）的 OSPF 包类型为 3。在交换数据库描述包之后，路由器便知道其自身链路状态数据库缺少哪些 LSA，以及哪些 LSA 是过期的。这时就可以发送链路状态请求包来请求对方发送缺少的 LSA 和最新的 LSA。

- 链路状态更新包 LSU：向邻居路由器发送链路状态通告

  链路状态更新包（Link State Update）的 OSPF 包类型为 4。**LSA 的洪泛就是由此类型的包实现的。每一个链路状态更新包可能包含多条 LSA 信息。这里的 LSA 信息是完整的，而不像数据库描述包只包含 LSA 的头部信息**。

- 链路状态确认包 LSA：确认收到了邻居路由器的 LSU

  链路状态确认包（Link State Acknowledgement）的 OSPF 包类型为 5。为了确保 LSA 的洪泛是可靠的，LSA 信息必须被显式的确认。

  ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/6c2347a98e8d78d2fa8077a421bf2fb0.jpg)

#### 1.2.2. OSPF 运行步骤

1. 建立路由器毗邻关系
1. 选举指定路由器（Designated Router, DR）和备份指定路由器（Backup Designated Router, BDR）
1. 发现路由
1. 选择最佳路由
1. 维护路由信息

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/574ecf8209702b69fc2012db81f590cd.jpg)

#### 1.2.3. OSPF 状态

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/520535e06a19964a58c083b2efb1a5e8.jpg)

- Down
- Init（初始）
- Two-way（双向）
- ExStart（准启动）
- Exchange（交换）
- Loading（加载）
- Full adjacency（全毗邻）

#### 1.2.4. DR/DBR 选举

- 为什么要选举 DR、BDR
  
  DR 和 BDR 作为网络的中心负责路由器之间的信息交换从而降低了网络中的信息流量。

  ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/b3e6e5968e41300321bd33ba93a81b4c.jpg)

- 选举过程

  ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/eb2e70590c84de3c8f7df8930d6f4f55.jpg)

  ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/e67fea749119d3de61bd5b52c3e6ee6a.jpg)

- 变化
  - 同步的次数减少了（O（n）），减少了带宽的利用。
  - 路由器的角色： DR、 BDR、 DROther。
  - 路由器间的关系： Unknown、 Neighbor、Adjacent。

#### 1.2.5. OSPF 路由器

- 内部路由器 --- 路由器所有接口都在一个区
- 主干路由器 --- 所有接口都在主干区域的路由器
- 区域边界路由器 (ABR) --- 路由器接口分属不同区域
- 自治域边界路由器 (ASBR) --- 路由器至少有一个接口不属于本自治域 /OSPF

#### 1.2.6. 路径选择

OSPF 使用“代价（Cost）”作为路由的度量值（Metric），路径的度量值越低，说明该路径越好，具有最低度量值的路径将装入路由表。代价是根据接口所配置的带宽来计算的，带宽越高，代价越低。

OSPF 有以下 4 种路由类型，优先级由高到低排序如下：
- 内部路由：去往区域内部网络的路由。
- 区域间路由：去往不同区域网络的路由。
- 类型 1 的外部路由：去往 OSPF 域外的路由，类型 1 的外部路由的度量值包括了外部路由的度量值和到 ASBR 的度量值。
- 类型 2 的外部路由：去往 OSPF 域外的路由，类型 2 的外部路由的度量值只包括了外部路由的度量值。

因此如果有多条去往相同目的地的路由具有相同的度量值，那么将比较它们的路由类型。假设有两条去往相同目的地的路由 A 和路由 B 的度量值都是 30，A 是内部路由，B 区域间路由，则 A 将会被装入路由表。如果有多条去往相同目的地的路由具有相同的类型，相同的度量值，则它们都将被装入路由表，并在不同路由之间进行负载均衡。

## 2. 域间路由算法 (IR)/ 外部网关协议 (EGP)

独立运营网络之间的路由问题，称为域间路由问题，**所有网络必须使用相同的域间路由协议和外部网关协议**。

### 2.1. 边界网关协议 (BGP)

**Internet 采用的域间路由协议是边界网关协议**。

<!-- todo: 课本 P369 -->

## 3. Refer Links