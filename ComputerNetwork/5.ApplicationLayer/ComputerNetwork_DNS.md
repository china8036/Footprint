- [DNS (Domain Name System)](#dns-domain-name-system)
  - [1. Host 静态解析](#1-host-静态解析)
  - [2. DNS 动态解析](#2-dns-动态解析)
  - [3. 记录类型](#3-记录类型)
  - [4. 域名空间结构](#4-域名空间结构)
  - [5. 查询过程](#5-查询过程)
  - [6. Refer Links](#6-refer-links)

# DNS (Domain Name System)

DNS domain name system 主要作用就是将主机域名转换为 ip 地址。从用户主机上调用应用程序的角度看，DNS 是一个提供简单、直接的转换服务的黑盒子。但事实上，实现这个服务的黑盒子非常复杂，它由分布于全球的大量 DNS 服务器以及定义了 DNS 服务器与查询主机通信方式的应用层协议组成。

## 1. Host 静态解析

早期的域名解析只采用 Host 文件静态解析的方式，但这种方式存在以下问题：
- 名称解析性能下降
- 主机维护困难

因此，出现了动态域名解析的层次性、分布式的 DNS 服务。

## 2. DNS 动态解析

DNS 为什么不采用单点的集中式的设计方式，而是使用分布式集群的工作方式？

DNS 的一种简单的设计模式就是在因特网上只使用一个 DNS 服务器，该服务器包含所有的映射，在这种集中式的设计中，客户机直接将所有查询请求发往单一的 DNS 服务器，同时该 DNS 服务器直接对所有查询客户机做出响应，尽管这种设计方式非常诱人，但他不适用当前的互联网，当今的因特网有着数量巨大并且在持续增长的主机，这种集中式设计会有以下问题：
- 单点故障（嗝屁一个，全球着急）
- 通信容量（上亿台主机发送的查询 DNS 报文请求，包括但不限于所有的 HTTP 请求，电子邮件报文服务器，TCP 长连接服务）
- 远距离的时间延迟（澳大利亚到纽约的举例）
- 维护开销大（因为所有的主机名 -ip 映射都要在一个服务站点更新）

## 3. 记录类型

域名与 IP 之间的对应关系，称为"记录"（record）。根据使用场景，"记录"可以分成不同的类型（type）：
- A：IPv4 地址记录（Address），返回域名指向的 IP 地址。

- AAAA：IPv6 地址记录（Address），返回域名指向的 IP 地址。

- NS：域名服务器记录（Name Server），返回保存下一级域名信息的服务器地址。该记录只能设置为域名，不能设置为 IP 地址。

- MX：邮件记录（Mail eXchange），返回接收电子邮件的服务器地址。

- CNAME：规范名称记录（Canonical Name），返回另一个域名，即当前查询的域名是另一个域名的跳转。

- PTR：逆向查询记录（Pointer Record），只用于从 IP 地址查询域名。

为了服务的安全可靠，一般至少应该有两条 NS 记录，而 A 记录和 MX 记录也可以有多条，这样就提供了服务的冗余性，防止出现单点失败。

## 4. 域名空间结构

域名的空间结构如下：

![image](http://img.cdn.firejq.com/jpg/2018/10/7/26e8d4d5ad902feab710e394382702a3.jpg)

```
host.sld.tld.root

主机名 . 次级域名 . 顶级域名 . 根域名
```
其中：
- 根域名

  根域名即 `.root`。目前全球只有 13 台根域名服务器（都在美国），从 `A.ROOT-SERVERS.NET` ~ `M.ROOT-SERVERS.NET`。由于"根域名服务器"的 NS 记录和 IP 地址一般是不会变化的，所以直接内置在 DNS 服务器里面。
  - P.S. 为什么根域名服务器是 13 台？

    目前绝大多数传输介质的 MTU 都大于 540 字节，对于采用 UDP 通信的 DNS 查询而言，为避免 IP 分片，应使得 UDP Data + UDP Header(8 byte) + IP Header(20 byte) < 540，因此 UDP 报文一般不会超过 512 字节。为了能在这 512 字节中放入所有的根域名服务器地址，因此将根域名服务的个数定为了 13.

  如：`www.example.com` 真正的域名是 `www.example.com.root`，简写为 `www.example.com.`。由于根域名 `.root` 对于所有域名都是一样的，所以平时是省略的。

- 顶级域名

  顶级域名由域名分配组织 ISO 决定，个人用户无法注册。顶级域名一般包括组织域和国家地区域。

  如：`.com`、`.net`、`.cn`。

- 二级域名（次级域名）

  二级域名是用户可以注册的。

  如：`www.example.com` 里面的 `.example`。

- 三级域名（主机名）

  三级域名是用户在自己的域里面为服务器分配的名称，是用户可以任意分配的。

  如：`www.example.com` 里面的 `www`。

## 5. 查询过程

每一级域名都有自己的 NS 记录，NS 记录指向该级域名的域名服务器。**"分级查询"，就是从根域名开始，依次查询每一级域名的 NS 记录，直到查到最终的 IP 地址**：

1. 从"根域名服务器"查到"顶级域名服务器"的 NS 记录和 A 记录（IP 地址）。
1. 从"顶级域名服务器"查到"次级域名服务器"的 NS 记录和 A 记录（IP 地址）。
1. 从"次级域名服务器"查出"主机名"的 IP 地址。

实例：

![image](http://img.cdn.firejq.com/jpg/2018/10/7/03d4e07cf6554d06612c82a759dcb919.jpg)

1. 当用户通过浏览器访问 `www.imooc.com.cn` 时，系统会按以下顺序查找是否有该域名对应的记录结果：浏览器 DNS 缓存、系统 DNS 缓存、系统 Hosts 文件，如果有则直接返回，没有则进入下一步。
1. 客户端向本地 DNS 服务器发起查询请求，查询 `www.imooc.com.cn` 的 A 记录。
1. 本地 DNS 服务器检查是否有 `www.imooc.com.cn` 的缓存信息，有的话直接返回结果。否则检查是否有 `.cn` 的缓存信息，如果有则直接进入下一步；否则向内置的根域名服务器发起查询请求，查询 `.cn` 的 A 记录，然后根域名服务器返回 `.cn` 的 A 记录。
1. 本地 DNS 服务器检查是否有 `.com.cn` 的缓存，如果有则直接进入下一步，否则向 `.cn` 服务器发起查询请求，查询 `.com.cn` 的 A 记录，然后 `.cn` 服务器返回 `.com.cn` 的 A 记录。
1. 本地 DNS 服务器检查是否有 `.imooc.com.cn` 的缓存，如果有则直接进入下一步，否则向 `.com.cn` 服务器发起查询请求，查询 `.immoc.com.cn` 的 A 记录，然后 `.com.cn` 服务器返回 `.imooc.com.cn` 的 A 记录。
1. 本地 DNS 服务器检查是否有 `www.immoc.com.cn` 的缓存，如果有则直接进入下一步，否则向 `.imooc.com.cn` 服务器发起查询请求，查询 `www.imooc.com.cn` 的 A 记录，然后 `.imooc.com.cn` 服务器返回 `www.imooc.com.cn` 的 A 记录。
1. 本地 DNS 服务器将 `www.imooc.com.cn` 的 A 记录缓存到本地，然后返回给客户端。

## 6. Refer Links

[阮一峰：DNS 原理入门](http://www.ruanyifeng.com/blog/2016/06/dns.html)

[DNS 解析的过程是什么，求详细的？](https://www.zhihu.com/question/23042131)

[为什么域名根服务器只能有 13 台呢？](https://www.zhihu.com/question/22587247)