- [计算机网络 - 网络层：Internet 协议 - IPv4 协议](#计算机网络---网络层internet-协议---ipv4-协议)
  - [1. IP 分片 (IP Fragment)](#1-ip-分片-ip-fragment)
    - [1.1. MTU](#11-mtu)
    - [1.2. 分片过程](#12-分片过程)
    - [1.3. 重组过程](#13-重组过程)
    - [1.4. 分片传输](#14-分片传输)
    - [1.5. 避免分片](#15-避免分片)
  - [2. IP 报文结构](#2-ip-报文结构)
    - [2.1. IP 报文头部](#21-ip-报文头部)
    - [2.2. IP 报文正文](#22-ip-报文正文)
  - [3. IP 地址](#3-ip-地址)
    - [3.1. 点分十进制表示 (Dotted decimal notation)](#31-点分十进制表示-dotted-decimal-notation)
    - [3.2. 地址分类](#32-地址分类)
    - [3.3. 子网划分](#33-子网划分)
      - [3.3.1. 子网掩码](#331-子网掩码)
      - [3.3.2. 子网规划](#332-子网规划)
      - [3.3.3. 可变长子网掩码（VLSM）](#333-可变长子网掩码vlsm)
    - [3.4. 无类域间路由 (CIDR)](#34-无类域间路由-cidr)
    - [3.5. 地址转换：NAT](#35-地址转换nat)
    - [3.6. 地址解析：ARP](#36-地址解析arp)
      - [3.6.1. 基本概念](#361-基本概念)
      - [3.6.2. 原理](#362-原理)
      - [3.6.3. ARP Cache](#363-arp-cache)
      - [3.6.4. ARP Package](#364-arp-package)
      - [3.6.5. Gratuitous ARP](#365-gratuitous-arp)
      - [3.6.6. 实例分析一](#366-实例分析一)
      - [3.6.7. 实例分析二](#367-实例分析二)
    - [3.7. 地址获取](#37-地址获取)
      - [3.7.1. RARP](#371-rarp)
      - [3.7.2. BOOTP](#372-bootp)
      - [3.7.3. DHCP](#373-dhcp)
  - [4. ICMP (Internet Control Message Protocol)](#4-icmp-internet-control-message-protocol)
    - [4.1. 基本概念](#41-基本概念)
    - [4.2. ICMP Frame](#42-icmp-frame)
      - [4.2.1. Header](#421-header)
      - [4.2.2. Data Area](#422-data-area)
  - [5. Refer Links](#5-refer-links)

# 计算机网络 - 网络层：Internet 协议 - IPv4 协议

## 1. IP 分片 (IP Fragment)

### 1.1. MTU

最大传输单元 (Maximum Transmission Unit，MTU) 是指物理接口（数据链路层）提供给其上层（如 IP 层、MPLS 层）最大一次传输数据的大小，单位为字节，其大小通常与物理通信接口有关（网卡、串口等）。

合适的 MTU 是衡通信效率和传输延迟的权衡：
- 协议数据单元的包头和包尾的长度是固定的，MTU 越大，则一个协议数据单元的承载的有效数据就越长，传送相同的用户数据所需的数据包个数也越低，通信效率也越高。例如，数据中心内部网络通常会使用大于 8192 字节的 MTU。
- MTU 不是越大越好。MTU 越大，通信效率越高而传输延迟增大，数据包中 bit 位发生错误的概率也越大。
<!-- - 若链路两端的 MTU 不同，会导致 MTU 大侧的数据被 MTU 小侧丢弃。 -->

常见缺省 MTU:
- 以太网 MTU: 1500 bytes
- IEEE 802.3/802.2 MTU: 1492 bytes

### 1.2. 分片过程

如果 IP 层（网络层）以上的协议层发送的数据段的长度超过了 MTU，则在发送者的 IP 层（网络层）将对数据段进行分片，在接收者的 IP 层（网络层）再对接收到的分片进行重组 (Reassemble)，从而将数据报包分成足够小的片段以通过那些最大传输单元小于该数据报原始大小的链路。

eg: 

以太网的 MTU 值是 1500 bytes，假设发送者的协议高层向 IP 层发送了长度为 3008 bytes 的数据段，则该数据段在添加 20 bytes 的 IP 包头后 IP 包的总长度是 3028 bytes，因为 3028 > 1500，所以该数据报文将被分片。

分片过程如下：
1. 首先计算最大的 IP 包中 IP 净荷的长度 =MTU-IP 包头长度 =1500-20= 1480 bytes。
1. 然后把 3008 bytes 按照 1480 bytes 的长度分片，将要分为 3 片，3008= 1480+1480+48。
1. 最后发送者将为 3 个分片分别添加 IP 包头，组成 3 个 IP 包后再发送，3 个 IP 包的长度分别为 1500 bytes、1500 bytes 和 68 bytes。

NOTE
- 分片时仅仅对 IP 上层的数据进行分片，不需要对 IP 首部进行分片，所以要分片的数据长度只有 3008，而不是 3028。
- 分片时无法识别 IP 上层数据段的头部和载荷，因此会将整个数据切成 N 个分片，导致只有第一个分片具有 UDP 或者 ICMP 首部，而其它分片则没有。 

### 1.3. 重组过程

### 1.4. 分片传输

对分片的传输通常有 2 种策略：
- 分片对于沿途后续的网络都是透明的，即从该网络已知到最终的目的涂中的每个网络都感觉不到曾经发生过分片。
  - 优点：简单直接。
  - 缺点：
    - 每个分片中必须提供一个计数字段或结束的标志位。
    - 由于所有数据报必须经过同一个出口路由器才能进行重组，因此会导致路由受到限制。
    - 若不是所有分片都已到达，路由器工作量增大，需要缓冲到达的短，并决定何时丢弃。
- 避免在任何一个中间路由器上重新组合分片。一旦一个数据包被分片，则每个分片都被当作原始的数据报一样来对待，分片的重组只在最终目标主机上进行。

IP 协议就是以这种方式进行工作的，IP 协议会为每个分片设置一个包序号、一个数据包内的绝对字节偏移量和一个指明是否到达数据包末尾的标志位。

### 1.5. 避免分片

在网络通讯中，**分片重组对网络性能影响很大，因此应尽量避免发生分片和重组**。

- 在网络层，避免分片一般通过在数据包发送时选择合适的 MTU 大小来实现。

  MTU 大小的选择通常有以下方式：
  - 协议协商方式
  
  - 全路径 MTU 发现机制
    
    全路径 MTU 发现机制需要先找到整条路径的最小 MTU（也就是路径 MTU），然后报文发送式小于等于路径 MTU，这就避免了数据传输过程中产生分片，从而提高数据转发性能。MTU 的协议发现机制由于安全等方面的原因，并不能总是生效，这时候就需要根据网络的特性选择合理的 MTU。如果在报文传送过程中分片是不可避免的，那么要想办法让重组尽量在终端进行，避免在转发路径中进行。

- 在传输层，避免分片通过 TCP 协议的 TCP 分段来实现。

## 2. IP 报文结构

[IPv4 Packet structure](https://en.wikipedia.org/wiki/IPv4#Packet_structure):

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/d3dcbc77a411134af34e705d1182f06d.jpg)

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/57c1cf64503423bc61f626a806041696.jpg)

每个 IP 数据报包含 2 个部分：
- 报文头部：报文头部由一个 20 bytes 的定长部分和一个可选的变长部分组成。
- 报文正文（有效净荷）

### 2.1. IP 报文头部

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/ce378be45aa6f97c16b93e2aee25562f.jpg)

IP 数据报头的传输从左到右，再从上到下。Version 字段的高序字节最先被传送出去，因此 little-endian 字节序的机器（如 Intel x86）在传输和接收 IP 报文时需要进行字节序转换。

- Version 协议的版本号（**4 bits**）
  - IPv4: 0100
  - IPv6: 0110
  - IPv5 是一个实验性的实时流协议，一直没有被广泛使用。

- Internet Header Length (IHL) 报头长度（4 bits）

- Differentiated Services Code Point (DSCP) 服务类型，表明该分组的重要程度
  - Precedence 
  - Reliability
  - ECN

- Explicit Congestion Notification (ECN) 

- Total Length 数据报总长度

  在 IP 头中用 2 个字节描述报文长度，2 个字节所能表达的最大数字就是 65535，因此 IP 数据包理论上的最大长度是 64K 字节 (65535)。

- Identification 数据报标识号
  - 标识当前数据报的序列号，由发送者分配，以便接收方可以依据来做重组。

- Flags 标志位 (**3 bits**)

  A three-bit field follows and is used to control or identify fragments. They are (in order, from most significant to least significant):

  - bit 0: Reserved; must be zero.

  - bit 1: Don't Fragment (DF)

    若 DF 标志位为 1，则要求这个 IP 包在传输的过程中不能分片，如果此 IP 包大于物理接口的 MTU，请直接丢弃，并发 ICMP 消息 (type=3，code=4，MTU=1000) 通知源主机进行重传。
  
  - bit 2: More Fragments (MF)
    
    For unfragmented packets, the MF flag is cleared. For fragmented packets, all fragments except the last have the MF flag set. The last fragment has a non-zero Fragment Offset field, differentiating it from an unfragmented packet.

- Fragment Offset

- Time To Live (TTL)

  维护一个计数器，递减为零维护一个计数器，递减为零时，数据报被丢弃，防止分组在网络中无限循环。当 TTL=0 时，会使用 ICMP 返回一个 timeout 类型的响应，通知请求已过期 / 超时。

- Protocol

  用来指定传输层协议。如 **ICMP 为 1，TCP 为 6，UDP 为 7**。

- Header Checksum

  针对头部计算校验和，验证分片头部的正确性。

- Source address 源 IP 地址

- Destination address 目的 IP 地址

- Options

  事实上，IP 报文中的 Options 字段只能得到少部分路由器的支持，因此很少使用。

- 填充：确保 IP 头是 32 位的整数倍
  
### 2.2. IP 报文正文

## 3. IP 地址

互联网协议地址（Internet Protocol Address）是 IP 协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。

IPv4 协议提供了 32 位比特位作为 IP 地址。

### 3.1. 点分十进制表示 (Dotted decimal notation)

- 32 位被分成了 4 个 8 位组
- 每个 8 位组之间用“.”分隔
- 每个 8 位组转换成十进制数，从 0 到 255

例：IP 地址（100.4.5.6），实际上是 32 位二进制数（01100100.00000100.00000101.00000110）。

### 3.2. 地址分类

Internet 委员会定义了 5 种 IP 地址类型以适合不同容量的网络，即 A 类~E 类。其中 A、B、C 是基本类，D、E 类作为多播和保留使用。除此之外，Internet 委员会在 A、B、C 类地址中预留了 3 个 IP 私有地址段，供组织机构内部使用。

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/f1c0052c03183ad2dadf7c939efa8401.jpg)

- A 类 IP 地址：
  - 一个 A 类 IP 地址由 1 字节的网络地址和 3 字节主机地址组成，网络地址的最高位必须是“0”。
  - 最大网络数：126（2^7-2)
  - IP 地址范围：0.0.0.0-127.255.255.255
  - 最大主机数：16777214
  - 私有 IP 地址范围：10.0.0.0-10.255.255.255
- B 类 IP 地址：
  - 一个 B 类 IP 地址由 2 个字节的网络地址和 2 个字节的主机地址组成，网络地址的最高位必须是“10”。
  - 最大网络数：16384(2^14)
  - IP 地址范围：128.0.0.0-191.255.255.255	
  - 最大主机数：65534
  - 私有 IP 地址范围：172.16.0.0-172.31.255.255
- C 类 IP 地址：
  - 一个 C 类 IP 地址由 3 字节的网络地址和 1 字节的主机地址组成，网络地址的最高位必须是“110”。
  - 最大网络数：2097152(2^21)
  - IP 地址范围：192.0.0.0-223.255.255.255	
  - 最大主机数：254
  - 私有 IP 地址范围：192.168.0.0-192.168.255.255
- D 类 IP 地址：
  - 以“1110”开始，是一个专门保留的地址。它并不指向特定的网络，目前这一类地址被用在多点广播（Multicast）中。多点广播地址用来一次寻址一组计算机，它标识共享同一协议的一组计算机。
  - IP 地址范围：224.0.0.1-239.255.255.254
- E 类 IP 地址：
  - 以“1111”开始，为将来使用保留，仅作实验和开发用。

NOTE：
- 常见的局域网由于容量小，一般选择 C 类的 192.168.0.0 作为地址段使用，一些大型企业就需要使用 B 类甚至 A 类地址段作为内部网络的地址段。因此，常见的内网地址都是以 192.168 开头的。
- 由于 NAT 和子网掩码的存在，实际在使用中，一个 C 类大小的局域网也可以选择 A 类的 10.0.0.0 网段作为自己的 IP 地址段。大多数局域网之所以仍然选择 192.168.0.0/24 或者 192.168.1.0/24 作为自己的 IP 地址段，更多的是因为约定成俗或者说网管个人习惯的关系。

特殊保留地址：
- D 类 IP 地址
- E 类 IP 地址
- 全零（“0．0．0．0”）地址指任意网络。
- 全“1”的 IP 地址（“255．255．255．255”）是当前子网的广播地址。
- 网络地址
- 回环地址，该类地址范围为 127．0．0．1 ~ 127．255．255．255，用于回路测试。
- 私人地址空间

例：判断以下 IP 是否合法
- 1.255.255.2 是广播地址，属于保留地址，不合法
- 127.2.3.5 是回环地址，属于保留地址，不合法
- 225.23.200.9 是 D 类地址，属于保留地址，不合法
- 192.240.150.255 合法

### 3.3. 子网划分

IP 地址由 Internet 域名和地址分配机构 (ICANN) 负责管理，ICANN 将部分地址空间授权给各区域机构，这些机构再把 IP 地址发放给 ISP 和其它公司。

为解决 IP 地址数量枯竭的问题，在网络的内部将一个网络分成几个部分，但对外仍像单个网络一样，即子网划分。子网划分对外部是不可见的，因此分配一个新的子网不需要联系 ICANN 或改变任何数据库。

#### 3.3.1. 子网掩码

#### 3.3.2. 子网规划

http://jingyan.baidu.com/article/af9f5a2d2e1a3543140a4532.html

http://www.voidcn.com/blog/handsomewangjg/article/p-4525657.html

http://www.360doc.com/content/09/1103/23/25127_8355629.shtml

#### 3.3.3. 可变长子网掩码（VLSM）

### 3.4. 无类域间路由 (CIDR)

在域名系统出现之后的第一个十年里，基于分类网络进行地址分配和路由 IP 数据包的设计就已明显显得可扩充性不足 （参见 RFC 1517）。为了解决这个问题，互联网工程工作小组在 1993 年发布了一新系列的标准——RFC 1518 和 RFC 1519——以定义新的分配 IP 地址块和路由 IPv4 数据包的方法。

无类别域间路由（Classless Inter-Domain Routing、CIDR）是一个用于给用户分配 IP 地址以及在互联网上有效地路由 IP 数据包的对 IP 地址进行归类的方法。CIDR 缓解了地址枯竭的趋势，控制甚至缩减了路由表的开销。

基本思想：配 IP 地址的时候不再以类别来分，而是按照可变长的地址块来分配。将好几个 IP 网络结合在一起，使用一种无类别的域际路由选择算法，可以减少由核心路由器运载的路由选择信息的数量；如果没有 CIDR，路由器就不能支持 Internet 网站的增多。 CIDR 采用 8~30 位可变网络 ID，而不是 A-B-C 类网络 ID 所用的固定的 8、16 和 24 位。

一个 IP 地址包含两部分：标识网络的前缀和紧接着的在这个网络内的主机地址。在之前的分类网络中，IP 地址的分配把 IP 地址的 32 位按每 8 位为一段分开。这使得前缀必须为 8，16 或者 24 位。因此，可分配的最小的地址块有 256（24 位前缀，8 位主机地址，28=256）个地址，而这对大多数企业来说太少了。大一点的地址块包含 65536（16 位前缀，16 位主机，216=65536）个地址，而这对大公司来说都太多了。这导致不能充分使用 IP 地址和在路由上的不便，因为大量的需要单独路由的小型网络（C 类网络）因在地域上分得很开而很难进行聚合路由，于是给路由设备增加了很多负担。

无类别域间路由是基于可变长子网掩码（VLSM）来进行任意长度的前缀的分配的。CIDR 包括：
- 指定任意长度的前缀的可变长子网掩码技术。遵从 CIDR 规则的地址有一个后缀说明前缀的位数，例如：192.168.0.0/16。这使得对日益缺乏的 IPv4 地址的使用更加有效。
- 将多个连续的前缀聚合成超网，并且在互联网中，只要有可能，就显示为一个聚合的网络，因此在总体上可以减少路由表的表项数目。聚合使得互联网的路由表不用分为多级，并通过 VLSM 逆转“划分子网”的过程。
- 根据机构的实际需要和短期预期需要而不是分类网络中所限定的过大或过小的地址块来管理 IP 地址的分配的过程。

因为在 IPv6 中也使用了 IPv4 的用后缀指示前缀长度的 CIDR，所以 IPv4 中的分类在 IPv6 中已不再使用。

CIDR 和可变长子网掩码 (VLSM) 的区别：
- CIDR 是把几个标准网络合成一个大的网络。
- VLSM 是把一个标准网络分成几个小型网络（子网）。
- CIDR 是子网掩码往左边移了，VLSM 是子网掩码往右边移了。

### 3.5. 地址转换：NAT

NAT (net address translate)：私有 IP 地址和公有 IP 地址之间的转换。

NAT 是一个 IP 地址耗尽的快速修补方案，内部网络使用私人地址，当内网需要和外网通信的时候，私人地址转换成合法的 global 的地址。NAT 转换器能够转换并且维护一个地址转换表，以便回来的报文找到它的去处。

带来的问题：
- NAT 违背了 IP 的结构模型 –每个 IP 地址唯一地标识了一台机器。
- NAT 将互联网改变成了“面向连接” 的网络。
- NAT 转换器维护着连接的状态，一旦它崩溃，连接也没有了。
- NAT 违背了最基本的协议分层原则。
- 如果传输层不是采用 TCP 或 UDP，而是采用了其它的协议， NAT 将不再工作。
- 有些应用会在 payload 中插入 IP 地址，然后接收方会提取出该 IP 地址并使用，但是 NAT 转换器对此一无所知，导致该类应用不再有效。
- NAT 让一个 IP 地址可以承载 61,440 （65536-4096）个私人地址（超载， PAT）。

### 3.6. 地址解析：ARP

#### 3.6.1. 基本概念

Address Resolution Protocol / 地址解析协议 (ARP) 是通过解析网路层地址来找寻数据链路层地址的一个在网络协议包中极其重要的网络传输协议，在网路层和数据链接层之间得以实现。

在 IPv6 中使用邻居发现协议 (NDP) 代替地址解析协议 (ARP)。

#### 3.6.2. 原理

**在以太网协议中规定，同一局域网中的一台主机要和另一台主机进行直接通信，必须要知道目标主机的 MAC 地址。**而在 TCP/IP 协议中，网络层和传输层只关心目标主机的 IP 地址。这就导致在以太网中使用 IP 协议时，数据链路层的以太网协议接到上层 IP 协议提供的数据中，只包含目的主机的 IP 地址。于是需要一种方法，根据目的主机的 IP 地址，获得其 MAC 地址。这就是 ARP 协议要做的事情。**所谓地址解析（address resolution）就是主机在发送帧前将目标三层的 IP 地址转换成二层的目标 MAC 地址的过程。**

实例：
- 主机 A 的 IP 地址为 192.168.1.1，MAC 地址为 0A-11-22-33-44-01。
- 主机 B 的 IP 地址为 192.168.1.2，MAC 地址为 0A-11-22-33-44-02。
- 当主机 A 要与主机 B 通信时：
  - 第 1 步：根据主机 A 上的路由表内容，IP 确定用于访问主机 B 的转发 IP 地址是 192.168.1.2。然后 A 主机在自己的本地 ARP 缓存中检查主机 B 的匹配 MAC 地址。
  - 第 2 步：如果主机 A 在 ARP 缓存中没有找到映射，它将询问 192.168.1.2 的硬件地址，即将 ARP 请求帧广播到本地网络上的所有主机。源主机 A 的 IP 地址和 MAC 地址都包括在 ARP 请求中。本地网络上的每台主机都接收到 ARP 请求并且检查是否与自己的 IP 地址匹配。如果主机发现请求的 IP 地址与自己的 IP 地址不匹配，它将丢弃 ARP 请求。
  - 第 3 步：主机 B 收到 ARP 请求，并确定 ARP 请求中的 IP 地址与自己的 IP 地址匹配，则将主机 A 的 IP 地址和 MAC 地址映射添加到本地 ARP 缓存中。
  - 第 4 步：主机 B 设置好自己的缓存后，将包含自己 MAC 地址的 ARP 回复消息直接发送回主机 A。
  - 第 5 步：当主机 A 收到从主机 B 发来的 ARP 回复消息时，会用主机 B 的 IP 和 MAC 地址映射更新 ARP 缓存（本机缓存是有生存期的，当生存期结束后，将再次重复上面的过程），主机 B 的 MAC 地址一旦确定，主机 A 就能向主机 B 发送 IP 通信了。

另外，当发送主机和目的主机不在同一个局域网中时，即便知道目的主机的 MAC 地址，两者也不能直接通信，必须经过路由转发才可以。所以此时，发送主机通过 ARP 协议获得的将不是目的主机的真实 MAC 地址，**而是一台可以通往局域网外的路由器的 MAC 地址**。于是此后发送主机发往目的主机的所有帧，都将发往该路由器，通过它向外发送。这种情况称为**委托 ARP 或 ARP 代理**（ARP Proxy）；缺省网关起着代理 ARP 的功能。

在**点对点链路中不使用 ARP，实际上在点对点网络中也不使用 MAC 地址**，因为在此类网络中分别已经获取了对端的 IP 地址。

为了让 ARP 的工作更加高效，下面是几种优化措施：
- 缓存 ARP 结果。
- 在 ARP 请求中包括源机的 IP-to-MAC 地址的映射。
- 每台机器在启动的时候，广播它的 IP-MAC 地址对。

#### 3.6.3. ARP Cache

为使广播量最小，ARP 维护 IP 地址到 MAC 地址映射的缓存以便将来使用。ARP 缓存可以包含动态和静态项目。动态项目随时间推移自动添加和删除。每个动态 ARP 缓存项的潜在生命周期是 10 分钟。新加到缓存中的项目带有时间戳，如果某个项目添加后 2 分钟内没有再使用，则此项目过期并从 ARP 缓存中删除；如果某个项目已在使用，则又收到 2 分钟的生命周期；如果某个项目始终在使用，则会另外收到 2 分钟的生命周期，一直到 10 分钟的最长生命周期。静态项目一直保留在缓存中，直到重新启动计算机为止。

ARP 缓存表采用老化机制，在一段时间内如果表中的某一行没有使用，就会被删除，这样可以大大减少 ARP 缓存表的长度，加快查询速度。

#### 3.6.4. ARP Package

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/46f9377ec989ae220132b976aebce526.jpg)

- 硬件类型：指明了发送方想知道的硬件接口类型，以太网的值为 1。
- 协议类型：指明了发送方提供的高层协议类型，IP 为 0800（16 进制）。
- 硬件地址长度和协议长度：指明了硬件地址和高层协议地址的长度，这样 ARP 报文就可以在任意硬件和任意协议的网络中使用。
- 操作类型：用来表示这个报文的类型，ARP 请求为 1，ARP 响应为 2，RARP 请求为 3，RARP 响应为 4。
- 发送方硬件地址（0-3 字节）：源主机硬件地址的前 3 个字节。
- 发送方硬件地址（4-5 字节）：源主机硬件地址的后 3 个字节。
- 发送方 IP 地址（0-1 字节）：源主机硬件地址的前 2 个字节。
- 发送方 IP 地址（2-3 字节）：源主机硬件地址的后 2 个字节。
- 目标硬件地址（0-1 字节）：目的主机硬件地址的前 2 个字节。
- 目标硬件地址（2-5 字节）：目的主机硬件地址的后 4 个字节。
- 目标 IP 地址（0-3 字节）：目的主机的 IP 地址。

eg:

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/9cf9942497b29e4aab3f828ae0abdfb0.jpg)

#### 3.6.5. Gratuitous ARP

免费 ARP（gratuitous ARP），是指主机发送 ARP 查询（广播）自己的 IP 地址，当 ARP 功能被开启或者是端口初始配置完成，主机向网络发送免费 ARP 来查询自己的 IP 地址确认地址唯一可用。

作用：
- 确定网络中是否有其他主机使用了 IP 地址，如果有应答则产生错误消息。
- 免费 ARP 可以做更新 ARP 缓存用，网络中的其他主机收到该广播则在缓存中更新条目，收到该广播的主机无论是否存在与 IP 地址相关的条目都会强制更新，如果存在旧条目则会将 MAC 更新为广播包中的 MAC。

#### 3.6.6. 实例分析一

<!-- todo: ARP 由谁发出？什么情况下会发出？主机收到 ARP 怎么处理？路由器收到 ARP 怎么处理？交换机收到 ARP 怎么处理？ -->

[同一网段内的两台主机通信是否需要路由器？](https://www.zhihu.com/question/41496681)

有主机 A 和主机 B，A 只知道 B 的 IP 地址，当 A 需要向 B 发起请求时：
- A 在本地计算 B 是否与自己处于同一个网段：

  A 使用自己物理接口的网络掩码 255.255.255.0，与自己的 IP 10.1.1.2 做 【按位与】操作，计算出自己网段地址为 10.1.1.0，再用自己的掩码和 B 的 IP 10.1.1.3 做【按位与】操作，计算出 B 的网段地址为 10.1.1.0，由于 A 与 B 的网段地址完全相同，可以认为是同一网段。

- 若 A 与 B 处于同一网段：
  - A 向局域网网段以广播方式发送 ARP 请求，B 收到 A 的 ARP 请求后以单播方式回复给 A 自己的 MAC 地址。
  - A 收到 B 的 MAC 地址后，将 B 的 MAC- 端口 进行绑定后缓存在 A 的本地 ARP Table 中，然后将数据包封装进 ip 包（使用 B 的 ip 作为目的 ip），再进一步封装成帧（帧头包括了 B 的 MAC 地址作为目的 MAC），完成 frame 的封装后从 NIC 发送到 B 的 NIC。这个过程中，A 与 B 直接进行通信，不需要改网段的路由器介入。

- 若 A 与 B 不处于同一网段：

  - A、B、路由器三者采用二层交换机互联

    ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/6b205ebfce9fdc2caaf09abd297def61.jpg)

    - A 不广播，直接向交换机 switch 发送 ARP 请求。
    - switch 收到来自 A 的 ARP 请求后，将 A 的 MAC 与其直连的端口映射并存储在 switch 的 MAC TABLE 中；然后 switch 在自己的 MAC TABLE 中查询 B 的 ip，发现没有 B 的 MAC 记录，于是向上层网关转发 ARP 请求。
    - B 收到 switch 转发的来自 A 的 ARP 请求，将（A 的 MAC）与（B 和 switch 直连的端口）映射并缓存到 B 的本地 MAC TABLE 中；之后 B 将自己的 MAC 信息回复给 switch，switch 也同样将 B 的 Port Number 和 MAC B 映射缓存起来。
    - 当 A 发给 B 的 Ethernet Frame 到达 switch，switch 发现 Frame 's Destination MAC = MAC B，查询一下 MAC Address Table，找到缓存记录中映射的 port number，于是就将 frame 发送到 B 的该 port number 上。

  - A、B、路由器三者采用 HUB 互联

    ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/199d713c97f1a2a2803a9803d8f0063b.jpg)

    A 与 B 之间的所有通信，包括 ARP、A 与 B 之间 Frame 都被 HUB 以广播方式，发给广播域里每一个主机或路由器，所以路由器可以看到 A 与 B 的通信，路由器所要做的工作很简单，默默地丢 ( silently discard)。

  - A、B、路由器三者采用具有三层功能的 switch 互联

    ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/ec41c0cea4b4b2d6e60e3f3887ba1910.jpg)

    switch 采用 SVI (Software Virtual Interface) 10.1.1.1 做 A、B 的缺省网关。这种和图一类似，三层 switch 的 SVI 接口不能接收到 A 与 B 之间的用户数据流量。

#### 3.6.7. 实例分析二

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/562686a98232540aec6c7bf375a7b540.jpg)

### 3.7. 地址获取

#### 3.7.1. RARP

#### 3.7.2. BOOTP

#### 3.7.3. DHCP

通过 DHCP 获取的 IP 是租来的，可能会过期。

## 4. ICMP (Internet Control Message Protocol)

### 4.1. 基本概念

ICMP（Internet Control Message Protocol）即 Internet 控制报文协议，是网路协议族的核心协议之一，是一种面向无连接的协议，用于 TCP/IP 网络中发送控制消息，提供可能发生在通信环境中的各种问题反馈，通过这些信息，令管理者可以对所发生的问题作出诊断，然后采取适当的措施解决。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。

TCP/IP 体系结构中的 IP 提供的是一种 “尽力而为” 的传输服务，IP 不具备错误报告或者纠正错误机制，而 ICMP 弥补了 IP 在错误报告机制方面的缺陷。路由器或 PC 可以利用 ICMP 向数据包的源主机通告传输过程中出现的问题。除了差错报告之外，ICMP 还具有查询功能，一台主机可以通过 ICMP 获取路由器或其它主机的某些信息；

ICMP 的错误报告机制是报告问题而不是纠正错误，纠正错误的任务由发送方完成。当遇到 IP 数据无法访问目标、IP 路由器无法按当前的传输速率转发数据包等情况时，会自动发送 ICMP 消息。“Ping”的过程实际上就是 ICMP 协议工作的过程。还有其他的网络命令如跟踪路由的 Tracert 命令也是基于 ICMP 协议的。

ICMP 依靠 IP 来完成它的任务，它是 IP 协议的子协议，也是 IP 协议的主要部分；

IPv4 中的 ICMP 被称作 ICMPv4，IPv6 中的 ICMP 则被称作 ICMPv6。

### 4.2. ICMP Frame

#### 4.2.1. Header

ICMP 报文包含在 IP 数据报中，IP 报头在 ICMP 报文的最前面。一个 ICMP 报文包括 IP 报头（至少 20 字节）、ICMP 报头（至少八字节）和 ICMP 报文（属于 ICMP 报文的数据部分）。当 IP 报头中的协议字段值为 1 时，就说明这是一个 ICMP 报文。

ICMP 报头从 IP 报头的第 160 位开始（IP 首部 20 字节）（除非使用了 IP 报头的可选部分），ICMP 包有一个 8 字节长的报头，其中前 4 个字节是固定的格式（包含 8 位类型字段，8 位代码字段和 16 位的校验和），后 4 个字节根据 ICMP 包的类型而取不同的值。

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/16/a70ea2c9da40b68b80ddfcc933f89b1f.jpg)

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/ee70d44a03aeac47ca145e81def9c439.jpg)

- Type
  
  ICMP 的类型，标识生成的错误报文。[Reference](https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml)

- Code
  
  进一步划分 ICMP 的类型，该字段用来查找产生错误的原因。；例如，ICMP 的目标不可达类型可以把这个位设为 1 至 15 等来表示不同的意思。

- Checksum
  
  校验码部分，这个字段包含有从 ICMP 报头和数据部分计算得来的，用于检查错误的数据，其中此校验码字段的值视为 0。

- Identifier
  
  这个字段包含了 ID 值，每个 ping 进程有唯一的 ID，在 Echo Reply 类型的消息中要返回这个字段。

- Sequence Number
  
  这个字段包含一个序号，每个 ICMP 包有唯一的 Sequence Number，同样要在 Echo Reply 类型的消息中要返回这个字段。

  - Notable control messages
    
    ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/eb201cd4aa2c7cadd9d49fc61b5a8e70.jpg)

#### 4.2.2. Data Area

填充的数据紧接在 ICMP 报头的后面（以 8 位为一组）：
- Linux 的"ping"工具填充的 ICMP 除了 8 个 8 位元组的报头以外，默认情况下还另外填充数据使得总大小为 64 字节。
- Windows 的"ping.exe"填充的 ICMP 除了 8 个 8 位元组的报头以外，默认情况下还另外填充数据使得总大小为 40 字节。

请求方发送了什么 data，应答方必须在响应包中携带相同的 data。

eg:

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/824b335b73d9359b725f18c3034222d0.jpg)

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/11/50417e3be6bb1cacdcf9034222dc4f5a.jpg)

## 5. Refer Links

[IP 数据包长度问题总结](https://blog.csdn.net/naturebe/article/details/6712153)

[为什么局域网的 IP 普遍是 192.168 开头？](https://www.zhihu.com/question/19813460)