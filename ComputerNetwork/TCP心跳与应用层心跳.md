- [TCP心跳与应用层心跳](#tcp%E5%BF%83%E8%B7%B3%E4%B8%8E%E5%BA%94%E7%94%A8%E5%B1%82%E5%BF%83%E8%B7%B3)
  - [TCP心跳包 与 应用程序中的心跳包](#tcp%E5%BF%83%E8%B7%B3%E5%8C%85-%E4%B8%8E-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E5%BF%83%E8%B7%B3%E5%8C%85)
  - [服务端主动发送心跳包，还是客户端发送比较好？](#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%BB%E5%8A%A8%E5%8F%91%E9%80%81%E5%BF%83%E8%B7%B3%E5%8C%85%EF%BC%8C%E8%BF%98%E6%98%AF%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E9%80%81%E6%AF%94%E8%BE%83%E5%A5%BD%EF%BC%9F)

# TCP心跳与应用层心跳

在TCP的机制里面，本身是存在有心跳包的机制的，也就是TCP的选项。系统默认是设置的是2小时的心跳频率。但是它检查不到机器断电、网线拔出、防火墙这些断线。而且逻辑层处理断线可能也不是那么好处理。一般，如果只是用于保活还是可以的。心跳包一般来说都是在逻辑层发送空的包来实现的。下一个定时器，在一定时间间隔下发送一个空包给客户端，然后客户端反馈一个同样的空包回来，服务器如果在一定时间内收不到客户端发送过来的反馈包，那就只有认定说掉线了。只需要send或者recv一下，如果结果为零，则为掉线。但是，在长连接下，有可能很长一段时间都没有数据往来。理论上说，这个连接是一直保持连接的，但是实际情况中，如果中间节点出现什么故障是难以知道的。更要命的是，有的节点（防火墙）会自动把一定时间之内没有数据交互的连接给断掉。在这个时候，就需要我们的心跳包了，用于维持长连接，保活。在获知了断线之后，服务器逻辑可能需要做一些事情，比如断线后的数据清理呀，重新连接呀当然，这个自然是要由逻辑层根据需求去做了。总的来说，心跳包主要也就是用于长连接的保活和断线处理。一般的应用下，判定时间在30-40秒比较不错。如果实在要求高，那就在6-9秒。

http://blog.csdn.net/hengyunabc/article/details/44310193




## TCP心跳包 与 应用程序中的心跳包

既然TCP中有心跳检测（KeepAlive机制）了，为什么还要在应用层做心跳检测？https://www.cnblogs.com/1wen/p/5808276.html 


回答：https://blog.coderzh.com/2015/03/05/WhyHeartBeatNeeded/ 

几乎所有的网游服务端都有心跳包(HeartBeat或Ping)的设计，在最近开发手游服务端时，也用到了心跳包。思考思考，心跳包是必须的吗？为什么需要心跳包？TCP没有提供断线检测的方法吗？TCP提供的KeepAlive机制可以替代HeartBeat吗？

由于连接丢失时，TCP不会立即通知应用程序。比如说，客户端程序断线了，服务端的TCP连接不会检测到断线，而是一直处于连接状态。这就带来了很大的麻烦，明明客户端已经断了，服务端还维护着客户端的连接，照常执行着该玩家的游戏逻辑……

心跳包就是用来及时检测是否断线的一种机制，通过每间隔一定时间发送心跳数据，来检测对方是否连接。是属于应用程序协议的一部分。

- 问题1： TCP为什么不自己提供断线检测？

  首先，断线检测需要轮询发送检测报文，会消耗一定的网络带宽和暂用一定的网络资源。如果把它做成TCP的底层默认功能，那些不需要断线检测的应用程序将会浪费不必要的带宽资源。

  另外，TCP不提供连接丢失及时通知的最重要原因与其主要设计目的目标之一有关：出现网络故障时维护通信的能力。TCP是美国国防部赞助研究的，一种即使发生战争或自然灾害这种严重网络损坏情况下，也能维护可靠网络通信的网络协议。通常，网络故障只是暂时的，有时路由器会在TCP临时连接丢失后默默的重新连上。所以，TCP本身并不提供那么及时的断线检测。

- 问题2： TCP的KeepAlive机制可以用来及时检测连接状态吗？

  TCP有个KeepAlive开关，打开后可以用来检测死连接。通常默认是2小时，可以自己设置。但是注意，这是TCP的全局设置。假如为了能更及时的检测出断开的连接，把tcp_keepalive_time和tcp_keepalive_intvl的时间改小（参考：Link），该机器上所有应用程序的KeepAlive检测间隔都会变小，显然是不能接受的。因为不同应用程序的需求是不一样的。

  (在某些平台的Socket实现已经支持为每条连接单独设置KeepAlive参数)

  KeepAlive本质上来说，是用来检测长时间不活跃的连接的。所以，不适合用来及时检测连接的状态。

- 问题3：心跳包（HeartBeat）为什么是好的方式及时检测连接状态？

  具有更大的灵活性，可以自己控制检测的间隔，检测的方式等等。
  
  心跳包同时适用于TCP和UDP，在切换TCP和UDP时，上层的心跳包功能都适用。（其实这种情况很少遇到）
  
  有些情况下，心跳包可以附带一些其他信息，定时在服务端和客户端之间同步。（比如帧数同步）


**心跳包机制一般两种：TCP自带的keep-alive；应用层探活。**

那到底使用tcp的keep-alive还是应用层自己实现的心跳机制呢？

keep-alive占用带宽少，不用开发人员实现。但在有代理的网络下，不一定能探活到服务器，除非反向代理也有相应的心跳机制；应用层心跳能携带更多状态。


## 服务端主动发送心跳包，还是客户端发送比较好？

https://www.zhihu.com/question/35896874 
