- [计算机网络 - 传输层：Transport control protocol 基本概念](#计算机网络---传输层transport-control-protocol-基本概念)
  - [1. 两个经典问题](#1-两个经典问题)
    - [1.1. 拜占庭将军问题](#11-拜占庭将军问题)
    - [1.2. 两军问题](#12-两军问题)
  - [2. TCP 协议概述](#2-tcp-协议概述)
  - [3. Refer Links](#3-refer-links)

# 计算机网络 - 传输层：Transport control protocol 基本概念

## 1. 两个经典问题

### 1.1. 拜占庭将军问题

拜占庭将军问题深入探讨：http://www.8btc.com/baizhantingjiangjun 

问题描述：

拜占庭帝国想要进攻一个强大的敌人，为此派出了 10 支军队去包围这个敌人。这个敌人虽不比拜占庭帝国，但也足以抵御 5 支常规拜占庭军队的同时袭击。基于一些原因，这 10 支军队不能集合在一起单点突破，必须在分开的包围状态下同时攻击。他们任一支军队单独进攻都毫无胜算，除非有至少 6 支军队同时袭击才能攻下敌国。他们分散在敌国的四周，依靠通信兵相互通信来协商进攻意向及进攻时间。

困扰这些将军的问题是，他们不确定他们中是否有叛徒，叛徒可能擅自变更进攻意向或者进攻时间。在这种状态下，拜占庭将军们能否找到一种分布式的协议来让他们能够远程协商，从而赢取战斗？

### 1.2. 两军问题

https://www.cnblogs.com/charlesblc/p/6271472.html 

两军问题 / 两军对垒问题 (two-army problem)(two Generals' Problem)，是计算机领域的一个思想实验，用来阐述**在一个不可靠的通信链路上试图通过通信以达成一致是存在缺陷的和困难的，是在计算机通信领域首个被证明无解的问题，由此也可推论出，随机通信失败条件下的“拜占庭将军问题”也同样无解**。

![image](http://img.cdn.firejq.com/jpg/2018/6/11/4b151e199e3ca4121a5ba119660253cc.jpg)

- 问题描述：

  一支白军被围困在一个山谷中，山谷的两侧是蓝军。困在山谷中的白军人数多余山谷两侧的任意一支蓝军，而少于两支蓝军的中和。若一支蓝军对白军单独发起进攻，则必败无疑；但若两支蓝军同时发起进攻，则可取胜。两只蓝军希望同时发起进攻，这样他们就要传递消息，以便确定发起进攻的具体时间。假设他们只能派遣士兵穿越白军所在的山谷（唯一的通信信道）来传递消息，那么在穿越山谷是，士兵有可能被俘虏，从而造成消息的丢失。现在的问题是：如何通信，以便蓝军必胜。

- 设计：
  - 假设一支蓝军指挥官发出消息：“我建议在明天佛晓发起进攻，请确认。”如果消息到达了另一支蓝军，其指挥官同意这一建议，并且他的回信也安全的送到，那么能否进攻呢？不能。这是一个两步握手协议，因为该指挥官无法知道他的回信是否安全送到了，所以，他不能发起进攻；
  - 改进协议，将两步握手协议改为三步握手协议，这样，最初提出建议的指挥官必须确认对该建议的应答信息。假如信息没有丢失，并收到确认消息，则他必须将收到的确认信息告诉对方，从而完成三步握手协议。
  - 然而，这样他就无法知道消息是否被对方收到，因此，他不能发起进攻。那么采用四步握手协议会如何呢？结果仍被证明是于事无补。

- 结论是：不存在使红军必胜的通信约定（协议）。最后信息的发送者，永远无法知道这个信息是否到达。

**两军问题的根本问题在于信道的不可靠**，反过来说，如果传递消息的信道是可靠的，两军问题可解。然而，并不存在这样一种信道，所以两军问题在经典情境下是不可解的。

但可以通过一种相对可靠的方式来解决大部分情形，即 TCP 协议。

## 2. TCP 协议概述

[传输控制协议 (Transmission Control Protocol, TCP)](https://en.wikipedia.org/wiki/Transmission_Control_Protocol) **是一种面向连接的、可靠的、基于端到端字节流的传输层通信协议，是专门为了在不可靠的互联网络上提供可靠的端到端字节流而设计的传输协议**，由 IETF 的 [RFC 793](http://tools.ietf.org/html/rfc793) 定义。对于大多数 Internet 应用来说，它们需要可靠的、按序传递的传输特性，这种情况下就应该使用 TCP 协议。

- TCP 传输实体

  支持 TCP 的机器都有一个 **TCP 传输实体**，或者是用户进程或者是操作系统内核，都可以管理 TCP 流和跟 IP 层的接口：
  - TCP 实体接收本地进程的用户数据流，将其分割成不超过 64 kB 的分片（实际上通过以太网传输要考虑 MTU 限制，去掉 IP 头和 TCP 头，通常不超过 1460 字节），每个分片 / 分段以单独的 IP 数据包形式发送。
  - 当包含 TCP 数据段的报文到达某台机器的时候，被提交给该机器的 TCP 传输实体，传输实体再将其重构出原始的字节流。

- TCP 连接的全球唯一标识：
  - 三元组：协议 + 本地地址 + 本地端口号。
  - 五元组：协议 + 本地地址 + 本地端口号 + 远端地址 + 远端端口号。

  P.S. [IP 地址和端口号可以确定网络上唯一的进程吗？](https://www.zhihu.com/question/27784864/answer/496153949)

  **不可以**。在 Linux 系统中，通过 SO_REUSEADDR 和 SO_REUSEPORT 可以复用地址和端口，也就是说可以在同一个 IP 的同一个 port 上绑定多个进程，即**端口复用技术**。这种技术的通常使用场景是针对 TIMEWAIT 链接，防止服务器重启时绑定的端口还未释放或者程序意外退出导致系统没有释放端口，如果这时设立了端口复用，那么重新启动或者新启动的应用进程可以直接绑定端口。

- TCP 协议基本特点

  - TCP 的一个关键特征，也是主导整个协议设计的特征是 **TCP 连接上的每个字节都有它自己独有的 32 位序号**。数据包携带的 32 位序号可用在一个方向上的滑动窗口以及另一个方向上的确认。

  - 发送端和接收端的 TCP 实体以段的形式交换数据，TCP 段由一个固定的 20 bytes 头和随后 0 个或多个数据字节构成。

  - TCP 连接**传输的是一个字节流而不是一个消息流**，端到端之间不保留消息的边界，因此 TCP 传输可能会出现 TCP 粘包问题。
  
  - TCP 段的实际大小由 TCP 应用程序决定，它可以将多次写操作中的数据累积后放在一个段中发送，也可以将一次写操作中的数据分割到多个段中发送。限制一个 TCP 段实际大小的因素有 2 个：
    - **IP 数据包的载荷理论上限是 65515 bytes，因此 TCP 段的大小不能超过这个上限。TCP 头为 20 字节，因此 TCP 报文段的最大负载是为 65515 - 20 = 65495 字节**。
    - 每个网络都有 MTU 限制，发送端和接收端的每个段必须适合 MTU 才能以单个不分段的数据包发送和接收，因此对于传输层有相应的 MSS 限制。

  - 所有的 TCP 连接是**全双工**的（同时双向传输）和**端到端**的（每条连接只有两个端点）。

  - **在一个 TCP 连接中，仅有两方进行彼此通信，因此 TCP 不支持组播和广播**。

  - **TCP 通信建立在面向连接的基础上，实现了一种"虚电路"的概念**。双方通信之前，需要先建立一条连接，然后双方就可以在其上发送数据流。这种数据交换方式能提高效率，但事先建立连接和事后拆除连接需要开销。
    
    <!-- TODO: -->

  - TCP 使用校验和，确认和重传机制来保证可靠传输。

  - TCP 给数据分节进行排序，并使用累积确认保证数据的顺序不变和非重复。

  - TCP 使用滑动窗口机制来实现流量控制，通过具有动态窗口大小的滑动窗口协议进行拥塞控制。
    
    当发送端传送一个 TCP 段时，会启动一个计时器。当该 TCP 段到达接收方时，接收端的 TCP 实体返回一个携带了确认号和剩余窗口大小的段（若有数据要发送则包含数据，否则直接发送不包含数据的 TCP 段），并且确认号的值等于接收端期望接受的下一个序号。如果发送方的计时器在确认段到达之前超时，则发送端会再次发送原来的段。

  - TCP 并不能保证数据一定会被对方接收到，因为在不可靠的信道上这是不可能的。TCP 能够做到的是，如果有可能，就把数据递送到接收方，否则就（通过放弃重传并且中断连接）通知用户。因此**准确说 TCP 也不是 100% 可靠的协议，它所能提供的是数据的可靠递送或故障的可靠通知**。

## 3. Refer Links
