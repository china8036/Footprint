- [计算机网络 - 传输层：User Datagram Protocol](#计算机网络---传输层user-datagram-protocol)
  - [1. 基本概念](#1-基本概念)
  - [2. UDP 段结构](#2-udp-段结构)
    - [2.1. UDP 载荷](#21-udp-载荷)
    - [2.2. UDP 头部](#22-udp-头部)
      - [2.2.1. 端口](#221-端口)
      - [2.2.2. 报文长度](#222-报文长度)
      - [2.2.3. 校验和](#223-校验和)
  - [3. 应用](#3-应用)
  - [4. Refer Links](#4-refer-links)

# 计算机网络 - 传输层：User Datagram Protocol

## 1. 基本概念

UDP (User Data Protocol) 用户数据报协议是一个简单的无连接的（connectionless）的面向数据报的传输层协议，正式规范为 [RFC 768](https://tools.ietf.org/html/rfc768)。

UDP 没有流量控制、拥塞控制或接收到损坏的数据段后的重传机制，因此这些工作都需要在应用层中完成。**UDP 只是提供了一个与 IP 协议的接口，并在此接口上增加通过端口号复用多个进程的功能，以及可选的端到端错误检测的功能**。

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/13/78ba8bb522bf024702b338fbc04bcf6c.jpg)

## 2. UDP 段结构

UDP 数据段 (segment) 包括 8 字节（8-Byte）的 UDP 头部和有效载荷数据两个部分。

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/13/da0908b68b5313377cc54e9ab3336f5b.jpg)

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/13/f62196532c01889f9c5afab2274ff03f.jpg)

### 2.1. UDP 载荷

当一个 UDP 数据包到来时，其有效载荷被递交给与目标端口相关联的进程。

### 2.2. UDP 头部

UDP 首部字段由 4 个部分组成，**在 IPv4 中，Source Port 和 Checksum 是可选的；在 IPv6 中，只有 Source Port 是可选的**。
```
0      7 8     15 16    23 24    31
+--------+--------+--------+--------+
|     Source      |   Destination   |
|      Port       |      Port       |
+--------+--------+--------+--------+
|                 |                 |
|     Length      |    Checksum     |
+--------+--------+--------+--------+
```

#### 2.2.1. 端口

UDP Header 中为来源端口和目的端口提供了各 16 bit 的空间，用来标记发送和接受的应用进程。其中，由于 UDP 不需要应答，所以来源端口是可选的，如果来源端口不用可以置为 0。

**事实上，UDP 相比原始 IP 数据报的最主要价值在于增加了源端口和目的端口**，若没有端口字段，传输层无法知道如何处理每个入境的数据包，有了端口字段后，它才能将内嵌的段交给正确的应用程序处理。

- 数据长度：16 bit
- 端口范围： 0~65535(2^16)
- 应用：
  - `< 1023` : 用于公共应用（保留，全局分配，用于标准服务器），由 IANA 分配。
  - `1024 ~ 49151` : 用户端口，注册端口。
  - `> 49152` : 动态端口，私人端口。
  - 常见缺省端口
    
    ![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/13/a777d47edcbe77bcae080fd9675770ac.jpg)

#### 2.2.2. 报文长度

该字段指定 UDP 报头和数据总共占用的长度，最小长度是 8 字节，因为 UDP 报头已经占用了 8 字节。

由于这个字段的长度是 16 bit，因此 UDP 报文总长不可能超过 65535 字节（包括 8 字节的报头和 65527 字节的数据）。
- 实际上通过 IPv4 协议传输时，由于 IPv4 的头部信息要占用 20 字节，因此数据长度不可能超过 65507 字节（65,535 − 8 字节 UDP 报头 − 20 字节 IP 头部）。
- 在 IPv6 的 jumbogram 中，是有可能传输超过 65535 字节的 UDP 数据包的。依据 RFC 2675，如果这种情况发生，报文长度应被填写为 0。

#### 2.2.3. 校验和

![image](http://otaivnlxc.bkt.clouddn.com/jpg/2018/6/13/51e7cedd315c98c2ee416082bf0e2b4b.jpg)

校验和字段可以用于发现头部信息和数据中的传输错误，提供额外的可靠性。

- 该字段在 IPv4 中是可选的，在 IPv6 中则是强制的。如果不使用校验和，该字段应被填充为全 0（一般不建议关闭，除非数据传输质量不重要，如数字化语音）。
- 如果收方的校验和为全 1，传输无错。
- 二进制反码求和
  - 从低位到高位逐列计算。
  - 0 和 0 相加是 0， 0 和 1 相加是 1， 1 和 1 相加是 0，但产生进位。
  - 最高位相加产生进位，该位为 1。
- 检错能力较弱，但简单快速。
- 使用协议地址，破坏了分层原则。

## 3. 应用

为什么使用 UDP？
- 对于需要对数据包流实施精确控制、错误检测或时序功能的应用，UDP 提供的服务恰到好处。
- 为了降低对计算机资源的需求，如 DNS，客户端给 DNS 服务器发送一个包含该主机名的 UDP 数据包，服务器用一个包含了该主机 IP 地址的 UDP 数据包作为应答，事先不需要建立连接，事后也不需要释放连接。
- 应用程序本身已提供数据完整性的检查机制，勿须依赖传输层的协议来保证。
- 应用程序传输的并非关键性的数据，如路由器周期性的路由信息交换。
- 一对多方式，必须使用 UDP（TCP 限于一对一的传送），如视频传播。

例：
- 客户 - 服务器交互 （如 DNS、远程过程调用 RPC）
- 多媒体应用，如流媒体协议 （实时传输协议 RTP/ 实时传输控制协议 RTCP/ 实时流传输协议 RTSP）和 IP 电话（VoIP）
- 路由信息协议（RIP）
- 简单网络管理协议（SNMP）
- 动态主机配置协议（DHCP）
- 组播和广播

## 4. Refer Links