- [数据库：关系查询优化](#%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9A%E5%85%B3%E7%B3%BB%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96)
  - [1. 查询处理](#1-%E6%9F%A5%E8%AF%A2%E5%A4%84%E7%90%86)
    - [1.1. 处理步骤](#11-%E5%A4%84%E7%90%86%E6%AD%A5%E9%AA%A4)
      - [1.1.1. 查询分析](#111-%E6%9F%A5%E8%AF%A2%E5%88%86%E6%9E%90)
      - [1.1.2. 查询检查](#112-%E6%9F%A5%E8%AF%A2%E6%A3%80%E6%9F%A5)
      - [1.1.3. 查询优化](#113-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96)
      - [1.1.4. 查询执行](#114-%E6%9F%A5%E8%AF%A2%E6%89%A7%E8%A1%8C)
    - [1.2. 查询操作实现](#12-%E6%9F%A5%E8%AF%A2%E6%93%8D%E4%BD%9C%E5%AE%9E%E7%8E%B0)
      - [1.2.1. 选择操作的实现](#121-%E9%80%89%E6%8B%A9%E6%93%8D%E4%BD%9C%E7%9A%84%E5%AE%9E%E7%8E%B0)
      - [1.2.2. 连接操作的实现](#122-%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C%E7%9A%84%E5%AE%9E%E7%8E%B0)
  - [2. 查询优化](#2-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96)
    - [2.1. 概述](#21-%E6%A6%82%E8%BF%B0)
    - [2.2. 代数优化](#22-%E4%BB%A3%E6%95%B0%E4%BC%98%E5%8C%96)
      - [2.2.1. 代数表达式的优化](#221-%E4%BB%A3%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E4%BC%98%E5%8C%96)
      - [2.2.2. 查询树的启发式优化](#222-%E6%9F%A5%E8%AF%A2%E6%A0%91%E7%9A%84%E5%90%AF%E5%8F%91%E5%BC%8F%E4%BC%98%E5%8C%96)
    - [2.3. 物理优化](#23-%E7%89%A9%E7%90%86%E4%BC%98%E5%8C%96)
      - [2.3.1. 基于启发式规则的存取路径选择优化](#231-%E5%9F%BA%E4%BA%8E%E5%90%AF%E5%8F%91%E5%BC%8F%E8%A7%84%E5%88%99%E7%9A%84%E5%AD%98%E5%8F%96%E8%B7%AF%E5%BE%84%E9%80%89%E6%8B%A9%E4%BC%98%E5%8C%96)
        - [2.3.1.1. 选择操作的启发式规则](#2311-%E9%80%89%E6%8B%A9%E6%93%8D%E4%BD%9C%E7%9A%84%E5%90%AF%E5%8F%91%E5%BC%8F%E8%A7%84%E5%88%99)
        - [2.3.1.2. 连接操作的启发式规则](#2312-%E8%BF%9E%E6%8E%A5%E6%93%8D%E4%BD%9C%E7%9A%84%E5%90%AF%E5%8F%91%E5%BC%8F%E8%A7%84%E5%88%99)
      - [2.3.2. 基于代价估算的优化](#232-%E5%9F%BA%E4%BA%8E%E4%BB%A3%E4%BB%B7%E4%BC%B0%E7%AE%97%E7%9A%84%E4%BC%98%E5%8C%96)

# 数据库：关系查询优化

## 1. 查询处理

查询处理是关系数据库管理系统执行查询语句的过程，其任务是把用户提交给关系数据库管理系统的查询语句转换为高效的查询执行计划。

### 1.1. 处理步骤

关系数据库管理系统查询处理可以分为 4 个阶段：查询分析、查询检查、查询优化和查询执行。

#### 1.1.1. 查询分析

首先对查询语句进行扫描、词法分析和语法分析。从查询语句中识别出语言符号，如 SQL 关键字、属性名和关系名等，进行语法检查和语法分析，即判断查询语句是否符合 SQL 语法规则，如果没有语法错误就转入下一步处理，否则便报告语句中出现的语法错误。

#### 1.1.2. 查询检查

对合法的查询语句进行语义检查，即根据数据字典中有关的模式定义检查语句中的数据库对象，如关系名、属性名是否存在和有效。如果是对视图的操作，则要用视图消解方法把视图的操作转换成对基本表的操作。还要根据数据字典中的用户权限和完整性约束定义对用户的存取权限进行检查。如果该用户没有相应的访问权限或违反了完整性约束，就拒绝执行该查询。**此阶段的完整性检查是初步的、静态的检查。**

检查通过后便把 SQL 查询语句转换成内部表示，即转换成等价的关系代数表达式。关系数据库管理系统一般用查询树 / 语法分析树来表示扩展的关系代数表达式。

#### 1.1.3. 查询优化

每个查询都会有许多可供选择的执行策略和操作算法，查询优化就是选择一个高效执行的查询处理策略。查询优化有多种方法，按照优化的层次一般可分为代数优化和物理优化：
- 代数优化是指关系代数表达式的优化，即按照一定的规则，通过对关系代数表达式进行等价变换，改变代数表达式中操作的次序和组合，使得查询更加高效。
- 物理优化是指存取路径和底层操作算法的选择。选择的依据可以是基于规则的，也可以基于代价的，还可以是基于语义的。

实际关系数据库管理系统中的查询优化器都综合运用了这些优化技术，以获得最好的查询优化效果。

#### 1.1.4. 查询执行

根据查询优化器得到的执行策略生成查询执行计划，由代码生成器生成执行这个查询计划的代码，然后加以执行，回送查询结果。

### 1.2. 查询操作实现

每一种查询操作有多种执行的算法，以下是其中最主要的几种算法。

#### 1.2.1. 选择操作的实现

SELECT 语句有许多选项，因此实现的算法和优化策略也很复杂。

- 简单的全表扫描算法

  假设可以使用的内存为 M 块，全表扫描的思想如下：
  1. 按照物理次序读 M 块到内存。
  1. 检查内存的每个元组 t，如果 t 满足选择条件，则输出 t。
  1. 如果表中还有其它块未被处理，重复第一步和第二步。

  全表扫描算法只需要很少的内存（最少为 1 块）就可以运行，而且控制简单。对于规模小的表，这种算法简单有效。对于规模大的表进行顺序扫描，当选择率（即满足条件的元组树占全表的比例）较低时，这个算法的效率较低。

- 索引扫描算法

  如果选择条件种的属性上有索引（如 B+ 树索引或 hash 索引），可以用索引扫描方法，通过索引先找到满足条件的元组指针，再通过元组指针在查询的基本表中找到元组。

  一般情况下，当选择率较低时，基于索引的选择算法要优于全表扫描算法。但在某些情况下，例如选择率较高，或者要查找的元组均匀地分布在查找的表中，这时基于索引的选择算法的性能不如全表扫描算法。因为除了对表的扫描操作，还要加上对 B+ 树索引的扫描操作，对每一个检索码，从 B+ 树根结点到叶子结点路径上的每个结点都要执行一次 I/O 操作。

#### 1.2.2. 连接操作的实现

连接操作是查询处理中最常用也是最耗时的操作之一。

- 嵌套循环算法

  这是最简单可行的算法。对外层循环的每一个元组，检索内层循环中的每一个元组，并检查这两个元组在连接属性上是否相等。如果满足连接条件，则串接后作为结果输出，直到外层循环表中的元组处理完为止。

  在实际实现中数据存取是按照数据块读入内存，而不是按照元组进行 I/O 的。嵌套循环算法是最简单最通用的连接算法，可以处理包括非等值连接在内的各种连接操作。

- 排序 - 合并算法

  这是等值连接常用的算法，尤其适合参与连接的各个表已经排好序的情况。

  一般来说，对于大表，先排序后使用排序 - 合并连接算法执行连接，总的时间一般会减少。

- 索引连接算法

- hash join 算法

  hash join 算法也是处理等值连接的算法。它把连接属性作为 hash 码，用同一个 hash 函数将两个表中的元组散列到 hash 表中。

## 2. 查询优化

关系数据库系统和非过程化的 SQL 之所以能够取得巨大的成功，关键是得益于查询优化技术的发展。关系查询优化是影响关系数据库管理系统性能的关键因素。

由于关系表达式的语义级别很高，使关系系统可以从关系表达式中分析查询语义，提供了执行查询优化的可能性。这为关系系统在性能上接近甚至超过非关系系统提供了机遇。

### 2.1. 概述

关系系统的查询优化既是关系数据库管理系统实现的关键技术，又是关系系统的优点所在。它减轻了用户选择存取路径的负担，用户只要提出“干什么”，而不必指出“怎么干”。这不仅降低了对数据库用户的技术要求，且通常情况下系统可以比用户程序的“优化”做的更好。

目前关系数据库管理系统通过某种代价模型计算出各种查询执行策略的执行代价，然后选取代价最小的执行方案。在集中式数据库中，查询执行开销主要包括磁盘存取块数（I/O 代价）、处理机时间（CPU 代价）和查询的内存开销，在分布式数据库中还需要加上通信开销的代价，即：
```
总代价 = I/O 代价 + CPU 代价 + 内存代价 + 通信代价
```
其中，由于 I/O 操作涉及机械操作，耗时比内存操作高出几个数量级，因此，**计算查询代价时一般用查询处理读写的块数作为衡量单位**。

由于查询优化的搜索空间有时非常大，实际系统选择的策略不一定是最优的，而是较优的。

### 2.2. 代数优化

代数优化是指关系代数表达式的优化，即按照一定的规则，通过对关系代数表达式进行等价变换，改变代数表达式中操作的次序和组合，使得查询更加高效。

#### 2.2.1. 代数表达式的优化

常用的代数等价变换规则：
- 连接、笛卡尔积的交换律
- 连接、笛卡尔积的结合律
- 投影的串接定律
- 选择的串接定律
- 选择与投影操作的交换律
- 选择与笛卡尔积的交换律
- 选择与并的分配律
- 选择与差运算的分配律
- 选择对自然连接的分配律
- 投影与笛卡尔积的分配律
- 投影与并的分配律

#### 2.2.2. 查询树的启发式优化

典型的启发式规则有：
- 选择运算应尽可能先做。这是优化策略中最重要、最基本的一条。它常常可使执行代价节约几个数量级，因为选择运算一般使得计算的中间结果大大变小。
- 把投影运算和选择运算通过进行。如有若干投影和选择运算，并且它们都面对同一个关系数据库，则可以在扫描此关系的同时完成所有这些运算，以避免重复运算。
- 把投影同其前后的双目结合起来，没需要为了去掉某些字段而扫描一遍关系。
- 把某些选择同它同它在执行的笛卡尔积结合起来称为一个连接运算。连接（特别是等值连接）运算要比同样关系上的笛卡尔积省很多时间。
- 找出公共子表达式。如果这种重复出现的子表达式的结果不是很大的关系，并且从外存中读入这个关系比计算该子表达式的时间要少得多，则先计算一次公共子表达式并把结果写入中间文件是合算的。当查询的是视图时，定义视图的表达式就是公共子表达式的情况。

### 2.3. 物理优化

代数优化改变查询语句中操作的次序和组合，但不涉及底层的存取路径。物理优化是指存取路径和底层操作算法的选择。

选择的方法可以是：
- 基于规则的启发式优化：启发式规则是指那些在大多数情况下都适用，但不是在每种情况下都是最好的规则。
- 基于代价估算的优化：使用优化器估算不同执行策略的代价，并选择具有最小代价的执行计划。
- 两者结合的优化方法：查询优化器通常会将这两种技术结合在一起使用。通常先使用启发式规则，选取若干较优的候选方案，减少代价估算的工作量，然后分别计算这些候选方案的执行代价，较快地选出最终的优化方案。

#### 2.3.1. 基于启发式规则的存取路径选择优化

##### 2.3.1.1. 选择操作的启发式规则

对于小关系，使用全表扫描，即使选择列上有索引。

对于大关系：
- 对于“主码 = 值”的查询，查询结果最多是一个元组，可以选择主码索引。一般的关系数据库管理系统会自动建立主码索引。
- 对于“非主属性 = 值”的查询，并且选择列上有索引，则要估算查询结果的元组数目，如果比例较小（<10%）可以使用索引扫描方法，否则还是使用全表顺序扫描。
- 对于属性上的非等值查询或范围查询，并且选择列上有索引，同样要估算查询结果的元组数目，如果比例较小（<10%）可以使用索引扫描方法，否则还是使用全表顺序扫描。
- 对于用 AND 连接的合取选择条件，如果有涉及这些属性的组合索引，则优先采用组合索引扫描方法。如果某些属性上有一般索引，则可以采用索引扫描方法，否则使用全表顺序扫描。
- 对于用 OR 连接的析取选择条件，一般使用全表顺序扫描。

##### 2.3.1.2. 连接操作的启发式规则

- 若 2 个表都已经按照连接属性排序，则选用排序 - 合并算法。
- 若一个表在连接属性上有索引，则可以选用索引连接算法。
- 若以上规则都不适用，且其中一个表较小，可以采用 hash join 算法。
- 最后可以选用嵌套循环年算法，并选择其中较小的表，即占用块数较少的表，作为外循环的表。

#### 2.3.2. 基于代价估算的优化

启发式规则优化是定性的选择，比较粗糙，适合解释执行的系统。在编译执行的系统中，一次编译多次执行，查询优化和查询执行是分开的，因此，可以采用更加精细复杂的基于代价估算的选择优化。

基于代价的优化方法要计算各种操作算法的执行代价，它与数据库的状态密切相关。为此在数据字典中存储了优化器需要的统计信息，包括：
- 对每个基本表：该表的元组总数、元组长度、占用的块数、占用的溢出块数。
- 对基本表的每个列：该列不同值的个数、该列最大值、该列最小值，是否建立了索引，是哪种索引。
- 对所有：（如 B+ 树索引）该索引的层数、不同索引值的个数、索引的选择基数、索引的叶结点数。
