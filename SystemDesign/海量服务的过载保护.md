- [海量服务的过载保护](#海量服务的过载保护)
	- [1. 基本概念](#1-基本概念)
		- [1.1. 服务过载](#11-服务过载)
		- [1.2. 过载保护](#12-过载保护)
	- [2. 过载保护方法](#2-过载保护方法)
		- [2.1. 轻重分离](#21-轻重分离)
		- [2.2. 灰度发布](#22-灰度发布)
		- [2.3. 频率控制](#23-频率控制)
		- [2.4. 系统参数调优](#24-系统参数调优)
	- [3. Refer Links](#3-refer-links)

# 海量服务的过载保护

## 1. 基本概念

### 1.1. 服务过载

系统的负载达到最大处理能力后，系统的服务能力随负载的增加急剧下降，导致后端服务所处理的请求都是无效（已超时）的请求，而真正的请求却堵塞在请求队列中，“滚雪球”是过载的一种形象描述。

系统请求增加或性能变差是过载的直接诱因，会导致系统的 CPU、内存、磁盘或网络中的一个或多个达到瓶颈，使得系统响应变慢，然后用户重试或系统内部重试，放大了正常的请求量，加重系统的负载，最后导致系统过载，这是一个恶性循环的过程，如果没有外界干预且系统过载的诱因持续发生，系统是无法退出过载状态的。系统局部的过载可能在系统内扩散，导致整个系统不可用。用户规模越大，系统局部的过载扩散到整个系统的速度越快。

### 1.2. 过载保护

通过各种技术手段，保证系统负载达到最大处理能力后，随着负载的继续增加，系统处理能力基本保持恒定，“防雪球”是过载保护的一种形象描述。

一般来说，过载保护并不是一个系统的正常状态，一个好的系统应该能处理用户的正常请求而不进入过载保护状态，只有当一些特殊事件（重大故障，重大社会事件等）引起请求量突增时，才进入过载保护状态。

## 2. 过载保护方法

### 2.1. 轻重分离

轻重分离的目的是尽量将系统隔离起来，确保一个系统的过载状态或过载保护状态不会扩散到其他系统。轻重分离一般包括：
- 业务分离：不同业务分 set 部署
- 功能分离：不同功能分 set 部署
- 读写分离：读 / 写分进程、分机器甚至分 set 部署

### 2.2. 灰度发布

新版本的上线应该严格灰度，避免引入请求量的突增或系统性能的突降。例如发起一个线上的活动时，如果参与用户很多，应该将活动时间拉长，逐步放量，避免在一个时间点引入太多的用户请求，触发过载。

### 2.3. 频率控制

- 单位时间内总请求数目限制

- 基于连接的上传 / 下载流量限制

- 基于连接的超时关闭

- 基于连接的内存缓冲区使用限制

- 基于管道的数据流量限制

- 管道数据防雪崩包超时丢弃

- 待发送数据包超时丢弃

### 2.4. 系统参数调优

系统参数调优主要涉及到网络参数和磁盘 IO 参数，系统参数设置不合理也可能引发系统过载。

## 3. Refer Links