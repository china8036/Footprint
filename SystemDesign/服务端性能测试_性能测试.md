- [服务端性能测试：性能测试](#服务端性能测试性能测试)
	- [1. 一般步骤](#1-一般步骤)
	- [2. 测试方法](#2-测试方法)
	- [3. 定位瓶颈](#3-定位瓶颈)
		- [3.1. 查看系统负载](#31-查看系统负载)
		- [3.2. 使用 Profiler](#32-使用-profiler)
	- [4. Refer Links](#4-refer-links)

# 服务端性能测试：性能测试

## 1. 一般步骤

[如何严谨地做性能测试](https://coolshell.cn/articles/17381.html)

一，你得定义一个系统的响应时间 latency，建议是 TP99，以及成功率。比如路透的定义：99.9% 的响应时间必需在 1ms 之内，平均响应时间在 1ms 以内，100% 的请求成功。

二，在这个响应时间的限制下，找到最高的吞吐量。测试用的数据，需要有大中小各种尺寸的数据，并可以混合。最好使用生产线上的测试数据。

三，在这个吞吐量做 Soak Test，比如：使用第二步测试得到的吞吐量连续 7 天的不间断的压测系统。然后收集 CPU，内存，硬盘 / 网络 IO，等指标，查看系统是否稳定，比如，CPU 是平稳的，内存使用也是平稳的。那么，这个值就是系统的性能

四，找到系统的极限值。比如：在成功率 100% 的情况下（不考虑响应时间的长短），系统能坚持 10 分钟的吞吐量。

五，做 Burst Test。用第二步得到的吞吐量执行 5 分钟，然后在第四步得到的极限值执行 1 分钟，再回到第二步的吞吐量执行 5 钟，再到第四步的权限值执行 1 分钟，如此往复个一段时间，比如 2 天。收集系统数据：CPU、内存、硬盘 / 网络 IO 等，观察他们的曲线，以及相应的响应时间，确保系统是稳定的。

六、低吞吐量和网络小包的测试。有时候，在低吞吐量的时候，可能会导致 latency 上升，比如 TCP_NODELAY 的参数没有开启会导致 latency 上升（详见 TCP 的那些事），而网络小包会导致带宽用不满也会导致性能上不去，所以，性能测试还需要根据实际情况有选择的测试一下这两咱场景。

## 2. 测试方法

![image](http://otaivnlxc.bkt.clouddn.com/Snipaste_2018-08-07_13-13-05.png)

【压力测试】一般提到性能测试，大家最常用到的代名词就是压力测试。实际上，压力测试分成两种：【暴力测试】和【稳定性测试】。

【暴力测试】对系统产生过载的压力，让系统产生一系列致命而无法提供服务的问题。目的是评估这个系统超负载后带来的风险。

【稳定性测试】系统负载未过载情况下的一种压力测试。分两种测试方法，一种是【可靠性测试】，主要是持续一定长的时间提供一定量的负载，暴露系统的缺陷。缺陷暴露的几率与负载的大小成正比。解决系统缺陷后，才能进行【容量测试】。另一种是【稳定性测试】，在稳定的负载下，看系统各个性能指标在一段时间内是否稳定。倘若系统性能不稳定，获得的数值则不适合用来做容量评估。

【基准测试】狭义的性能测试，获得系统在某种特定的条件下（包括特定的负载条件下）的性能指标数据。

【负载测试】通过不断增加对系统的负载，获得系统在不同负载下的性能指标。一般通过并发连接数调节负载。并发连接数取值一般以 CPU 核数的倍数为佳：1、2、4、8、16、32、64、128。如此取样得到的数据最有参考价值，测试效率也最高。记录每种负载情况下的系统性能，包括：吞吐量（平均值，峰值）、90% 响应时间和资源利用率（CPU 占用率）。

【容量测试】容量测试主要采用负载测试方法获取数值，继而分析评估系统容量。这个过程包括对系统性能瓶颈的定位，性能调优，使资源利用率最大化，给出系统最优情况下能承载的最佳性能指标。

【并发测试】根据手段可以分为几种。【基准测试】：大量并发连接，看服务处理的响应时间是否正常；【稳定性测试】：被测系统在频繁建立和释放连接情况下系统是否能持续提供服务；【可靠性测试】：并发用户在一定高负载下同时访问临界数据，暴露系统缺陷；【暴力测试】：获取导致系统暴露缺陷的并发连接数。

## 3. 定位瓶颈

### 3.1. 查看系统负载

首先，当我们系统有问题的时候，我们不要急于去调查我们代码，这个毫无意义。我们首要需要看的是操作系统的报告。看看操作系统的 CPU 利用率，看看内存使用率，看看操作系统的 IO，还有网络的 IO，网络链接数等。Windows 下的 perfmon 是一个很不错的工具，Linux 下也有很多相关的命令和工具，比如：SystemTap，LatencyTOP，vmstat, sar, iostat, top, tcpdump 等 。通过观察这些数据，我们就可以知道我们的软件的性能基本上出在哪里。

- CPU

	如果 CPU 利用率不高，但是系统的 Throughput 和 Latency 上不去了，这说明我们的程序并没有忙于计算，而是忙于别的一些事，比如 IO。（另外，CPU 的利用率还要看内核态的和用户态的，内核态的一上去了，整个系统的性能就下来了。而对于多核 CPU 来说，CPU 0 是相当关键的，如果 CPU 0 的负载高，那么会影响其它核的性能，因为 CPU 各核间是需要有调度的，这靠 CPU0 完成）

- IO

	IO 和 CPU 一般是反着来的，CPU 利用率高则 IO 不大，IO 大则 CPU 就小。关于 IO，我们要看三个事：
	- 一个是磁盘文件 IO
	- 一个是驱动程序的 IO（如：网卡）
	- 一个是内存换页率
	这三个事都会影响系统性能。

- 网络带宽

	在 Linux 下，你可以使用 iftop, iptraf, ntop, tcpdump 这些命令来查看网络带宽使用情况，或是用 Wireshark 来查看。

- 程序

	如果 CPU 不高，IO 不高，内存使用不高，网络带宽使用不高。但是系统的性能上不去。这说明你的程序有问题，比如，你的程序被阻塞了。可能是因为等那个锁，可能是因为等某个资源，或者是在切换上下文。

通过了解操作系统的性能，我们才知道性能的问题，比如：带宽不够，内存不够，TCP 缓冲区不够，等等，很多时候，不需要调整程序的，只需要调整一下硬件或操作系统的配置就可以了。

### 3.2. 使用 Profiler

接下来，我们需要使用性能检测工具，也就是使用某个 Profiler 来差看一下我们程序的运行性能。如：Java 的 JProfiler/TPTP/CodePro Profiler，GNU 的 gprof，IBM 的 PurifyPlus，Intel 的 VTune，AMD 的 CodeAnalyst，还有 Linux 下的 OProfile/perf，后面两个可以让你对你的代码优化到 CPU 的微指令级别，如果你关心 CPU 的 L1/L2 的缓存调优，那么你需要考虑一下使用 VTune。 使用这些 Profiler 工具，可以让你程序中各个模块函数甚至指令的很多东西，如：运行的时间 ，调用的次数，CPU 的利用率，等等。这些东西对我们来说非常有用。

我们重点观察运行时间最多，调用次数最多的那些函数和指令。这里注意一下，对于调用次数多但是时间很短的函数，你可能只需要轻微优化一下，你的性能就上去了（比如：某函数一秒种被调用 100 万次，你想想如果你让这个函数提高 0.01 毫秒的时间 ，这会给你带来多大的性能）

使用 Profiler 有个问题我们需要注意一下，因为 Profiler 会让你的程序运行的性能变低，像 PurifyPlus 这样的工具会在你的代码中插入很多代码，会导致你的程序运行效率变低，从而没发测试出在高吞吐量下的系统的性能，对此，一般有两个方法来定位系统瓶颈：

1）在你的代码中自己做统计，使用微秒级的计时器和函数调用计算器，每隔 10 秒把统计 log 到文件中。

2）分段注释你的代码块，让一些函数空转，做 Hard Code 的 Mock，然后再测试一下系统的 Throughput 和 Latency 是否有质的变化，如果有，那么被注释的函数就是性能瓶颈，再在这个函数体内注释代码，直到找到最耗性能的语句。

最后再说一点，对于性能测试，不同的 Throughput 会出现不同的测试结果，不同的测试数据也会有不同的测试结果。所以，用于性能测试的数据非常重要，性能测试中，我们需要观测试不同 Throughput 的结果。

## 4. Refer Links

TODO:

[coolshell 代码优化概要](https://coolshell.cn/articles/2967.html)

[coolshell 性能测试应该怎么做？](https://coolshell.cn/articles/17381.html)

[coolshell 性能调优攻略](https://coolshell.cn/articles/7490.html)